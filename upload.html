<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LookingGreat</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --pad: 14px; --radius: 16px; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0b0f; color:#fff; }
    .wrap { max-width: 860px; margin: 0 auto; padding: var(--pad); padding-bottom: 92px; }
    .top { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .title { font-size: 18px; font-weight: 700; letter-spacing: .2px; }
    .hint { opacity:.75; font-size: 13px; margin-top: 6px; line-height: 1.35; }
    .card { margin-top: 12px; border-radius: var(--radius); overflow:hidden; background: #11121a; border: 1px solid rgba(255,255,255,.06); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 1px; background: rgba(255,255,255,.06); }
    .tile { position: relative; background:#0f1018; min-height: 44vh; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .tile img { width:100%; height:100%; object-fit: cover; display:block; }
    .loading { padding: 16px; opacity:.8; font-size: 14px; }
    .error { padding: 14px; background: rgba(255,0,0,.12); border: 1px solid rgba(255,0,0,.35); border-radius: 12px; margin-top: 12px; }
    .bar { position: fixed; left:0; right:0; bottom:0; padding: 10px var(--pad) calc(10px + env(safe-area-inset-bottom)); background: rgba(10,10,14,.92); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,.08); }
    .bar-inner { max-width: 860px; margin: 0 auto; display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .btn { border: 1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); color:#fff; border-radius: 14px; padding: 10px 12px; font-size: 14px; cursor:pointer; }
    .btn:active { transform: translateY(1px); }
    .muted { opacity:.7; font-size: 13px; }
    .screen { display:none; }
    .screen.active { display:block; }
    .upload { margin-top: 12px; }
    .field { margin: 10px 0; }
    input[type="file"] { width:100%; color:#fff; }
    .link { color:#9bd0ff; word-break: break-all; }
    .results { margin-top: 12px; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); font-size: 13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">Выбери, что выглядит лучше</div>
        <div class="hint">Тап по фото = голос. Сразу покажем следующую пару.</div>
      </div>
    </div>

    <div id="err" class="error" style="display:none"></div>

    <!-- VOTE SCREEN -->
    <div id="screenVote" class="screen active">
      <div class="card">
        <div class="grid">
          <div id="leftTile" class="tile">
            <div class="loading" id="leftLoading">Загрузка…</div>
            <img id="leftImg" alt="" style="display:none" />
          </div>
          <div id="rightTile" class="tile">
            <div class="loading" id="rightLoading">Загрузка…</div>
            <img id="rightImg" alt="" style="display:none" />
          </div>
        </div>
      </div>
      <div class="muted" style="margin-top:10px" id="voteNote"></div>
    </div>

    <!-- UPLOAD SCREEN (hidden until user clicks) -->
    <div id="screenUpload" class="screen">
      <div class="card" style="padding:14px">
        <div class="title" style="font-size:16px">Загрузить 2 фото</div>
        <div class="hint">Фото появятся в ленте, другие пользователи проголосуют. Ты получишь ссылку на результат.</div>

        <div class="upload">
          <div class="field">
            <div class="muted">Фото 1</div>
            <input id="fileLeft" type="file" accept="image/*" />
          </div>
          <div class="field">
            <div class="muted">Фото 2</div>
            <input id="fileRight" type="file" accept="image/*" />
          </div>
          <button class="btn" id="btnUpload">Загрузить</button>
          <div class="muted" style="margin-top:10px" id="uploadStatus"></div>

          <div class="results" id="uploadResult" style="display:none">
            <div style="margin-top:12px">
              <span class="pill">Ссылка на результат</span>
            </div>
            <div style="margin-top:8px" class="link" id="resultLink"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RESULTS SCREEN -->
    <div id="screenResults" class="screen">
      <div class="card" style="padding:14px">
        <div class="title" style="font-size:16px">Результат</div>
        <div class="hint" id="resHint">Загрузка…</div>
        <div style="margin-top:10px" id="resBody"></div>
      </div>
    </div>
  </div>

  <div class="bar">
    <div class="bar-inner">
      <button class="btn" id="btnBack" style="display:none">Назад</button>
      <div class="muted" id="barText">Голосуй в ленте</div>
      <button class="btn" id="btnGoUpload">Загрузить 2 фото</button>
    </div>
  </div>

<script>
  const API_ORIGIN = "https://api.lookingreat.ru";

  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
  }

  const errBox = document.getElementById("err");
  function showErr(msg) {
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function clearErr() {
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  function getTelegramId() {
    // MVP: если есть Telegram WebApp — берём user.id, иначе fallback 111
    const id = tg?.initDataUnsafe?.user?.id;
    return id ? String(id) : "111";
  }

  function setScreen(name) {
    document.getElementById("screenVote").classList.remove("active");
    document.getElementById("screenUpload").classList.remove("active");
    document.getElementById("screenResults").classList.remove("active");

    document.getElementById("screen" + name).classList.add("active");
    document.getElementById("btnBack").style.display = (name === "Vote") ? "none" : "inline-block";
    document.getElementById("barText").textContent =
      (name === "Vote") ? "Голосуй в ленте" :
      (name === "Upload") ? "Загрузка фото" : "Просмотр результата";
  }

  const leftTile = document.getElementById("leftTile");
  const rightTile = document.getElementById("rightTile");
  const leftImg = document.getElementById("leftImg");
  const rightImg = document.getElementById("rightImg");
  const leftLoading = document.getElementById("leftLoading");
  const rightLoading = document.getElementById("rightLoading");
  const voteNote = document.getElementById("voteNote");

  let currentPair = null;
  let votingLock = false;

  async function loadNext() {
    clearErr();
    voteNote.textContent = "";
    currentPair = null;

    leftImg.style.display = "none";
    rightImg.style.display = "none";
    leftLoading.style.display = "block";
    rightLoading.style.display = "block";

    const telegram_id = getTelegramId();
    const url = `${API_ORIGIN}/api/vote/next?telegram_id=${encodeURIComponent(telegram_id)}`;

    const r = await fetch(url);
    const data = await r.json();

    if (!data.ok) {
      showErr(data.error || "Ошибка загрузки");
      leftLoading.style.display = "none";
      rightLoading.style.display = "none";
      return;
    }

    if (!data.item) {
      leftLoading.style.display = "none";
      rightLoading.style.display = "none";
      voteNote.textContent = "Пока нет новых пар. Зайди позже или загрузи свои 2 фото.";
      return;
    }

    currentPair = data.item;

    leftImg.onload = () => { leftLoading.style.display = "none"; leftImg.style.display = "block"; };
    rightImg.onload = () => { rightLoading.style.display = "none"; rightImg.style.display = "block"; };

    leftImg.src = currentPair.photo_left_url;
    rightImg.src = currentPair.photo_right_url;
  }

  async function vote(choice) {
    if (votingLock) return;
    if (!currentPair) return;

    votingLock = true;
    clearErr();

    const telegram_id = getTelegramId();
    const payload = { telegram_id, pair_id: currentPair.id, choice };

    try {
      const r = await fetch(`${API_ORIGIN}/api/vote`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await r.json().catch(() => null);

      if (!r.ok) {
        const msg = data?.error || `Ошибка (${r.status})`;
        showErr(msg);
        votingLock = false;
        return;
      }

      // instantly next
      await loadNext();
    } catch (e) {
      showErr(String(e?.message || e));
    } finally {
      votingLock = false;
    }
  }

  leftTile.addEventListener("click", () => vote("left"));
  rightTile.addEventListener("click", () => vote("right"));

  // Upload
  const btnGoUpload = document.getElementById("btnGoUpload");
  const btnBack = document.getElementById("btnBack");
  const btnUpload = document.getElementById("btnUpload");
  const fileLeft = document.getElementById("fileLeft");
  const fileRight = document.getElementById("fileRight");
  const uploadStatus = document.getElementById("uploadStatus");
  const uploadResult = document.getElementById("uploadResult");
  const resultLink = document.getElementById("resultLink");

  btnGoUpload.addEventListener("click", () => {
    clearErr();
    uploadStatus.textContent = "";
    uploadResult.style.display = "none";
    setScreen("Upload");
  });

  btnBack.addEventListener("click", async () => {
    clearErr();
    setScreen("Vote");
    await loadNext();
  });

  btnUpload.addEventListener("click", async () => {
    clearErr();
    uploadStatus.textContent = "";
    uploadResult.style.display = "none";

    const left = fileLeft.files?.[0];
    const right = fileRight.files?.[0];
    if (!left || !right) {
      showErr("Выбери 2 файла (Фото 1 и Фото 2).");
      return;
    }

    uploadStatus.textContent = "Загружаем…";
    const telegram_id = getTelegramId();

    const fd = new FormData();
    fd.append("telegram_id", telegram_id);
    fd.append("left", left);
    fd.append("right", right);

    try {
      const r = await fetch(`${API_ORIGIN}/api/upload_pair`, {
        method: "POST",
        body: fd
      });

      const data = await r.json();

      if (!data.ok) {
        showErr(data.error || "Ошибка загрузки");
        uploadStatus.textContent = "";
        return;
      }

      uploadStatus.textContent = "Готово. Ссылка на результат ниже.";
      uploadResult.style.display = "block";
      resultLink.textContent = data.results_url;
      // сразу открываем results в этом же приложении
      location.hash = `#results=${encodeURIComponent(data.owner_token)}`;
      await openResultsFromHash();
    } catch (e) {
      showErr(String(e?.message || e));
      uploadStatus.textContent = "";
    }
  });

  // Results
  async function openResultsFromHash() {
    const h = location.hash || "";
    const m = /^#results=(.+)$/i.exec(h);
    if (!m) return false;

    const owner_token = decodeURIComponent(m[1]);
    setScreen("Results");

    const resHint = document.getElementById("resHint");
    const resBody = document.getElementById("resBody");
    resHint.textContent = "Загрузка…";
    resBody.innerHTML = "";

    try {
      const r = await fetch(`${API_ORIGIN}/api/results?owner_token=${encodeURIComponent(owner_token)}`);
      const data = await r.json();

      if (!data.ok) {
        resHint.textContent = "Не найдено";
        resBody.textContent = data.error || "Ошибка";
        return true;
      }

      const v = data.votes;
      const winnerText =
        v.winner === "draw" ? "Ничья" :
        v.winner === "left" ? "Победило фото 1" : "Победило фото 2";

      resHint.textContent = winnerText;

      resBody.innerHTML = `
        <div style="margin-top:10px" class="pill">Голоса</div>
        <div style="margin-top:8px; line-height:1.6">
          Фото 1: <b>${v.left}</b> (${v.left_percent}%)
          <br/>
          Фото 2: <b>${v.right}</b> (${v.right_percent}%)
          <br/>
          Всего: <b>${v.total}</b>
        </div>
        <div style="margin-top:12px" class="card" style="padding:0">
          <div class="grid">
            <div class="tile" style="min-height:32vh"><img src="${data.pair.photo_left_url}" alt=""></div>
            <div class="tile" style="min-height:32vh"><img src="${data.pair.photo_right_url}" alt=""></div>
          </div>
        </div>
      `;
      return true;
    } catch (e) {
      resHint.textContent = "Ошибка";
      resBody.textContent = String(e?.message || e);
      return true;
    }
  }

  window.addEventListener("hashchange", openResultsFromHash);

  // Start
  (async () => {
    if (await openResultsFromHash()) return;
    setScreen("Vote");
    await loadNext();
  })();
</script>
</body>
</html>
