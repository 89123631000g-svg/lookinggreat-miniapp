<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LookingGreat</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --stroke: rgba(0,0,0,.08);
      --stroke2: rgba(0,0,0,.06);
      --text:#0f172a;
      --muted: rgba(15,23,42,.60);

      --r:18px;

      --safeT: env(safe-area-inset-top, 0px);
      --safeB: env(safe-area-inset-bottom, 0px);

      --navH: 64px;

      /* –î–ï–°–ö–¢–û–ü/–û–ë–©–ï–ï: –≤—ã—Å–æ—Ç–∞ –±–ª–æ–∫–∞ —Å —Ñ–æ—Ç–æ */
      --pairH: clamp(360px, 62vh, 620px);

      /* –í–æ–∑–¥—É—Ö —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É —É —Ñ–æ—Ç–æ (–º–µ–Ω—è–µ—à—å —Ç—É—Ç) */
      --pairPad: 12px;
    }

    /* –ú–û–ë–ò–õ–¨–ù–û–ï: —É–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã —Ñ—É—Ç–µ—Ä –ø–æ–¥–Ω—è–ª—Å—è –∫ —Ñ–æ—Ç–æ */
    @media (max-width: 520px){
      :root{
        --pairH: clamp(280px, 46vh, 420px);
      }
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }

    html,body{
      height:100%;
      margin:0;
      overflow:hidden;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background: var(--bg);
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      background: var(--bg);
    }

    .top{
      padding: calc(10px + var(--safeT)) 14px 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex: 0 0 auto;
      background: var(--bg);
    }
    .brand{ line-height:1.1; }
    .brand .t{ font-weight:800; font-size:18px; letter-spacing:.2px; }
    .brand .s{ margin-top:4px; font-size:13px; color:var(--muted); }

    .feed{
      flex:1 1 auto;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 0 12px calc(var(--navH) + var(--safeB) + 16px);
      background: var(--bg);
      scrollbar-width:none;
    }
    .feed::-webkit-scrollbar{ display:none; }

    .card{
      display:flex;
      flex-direction:column;

      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      overflow:hidden;
      box-shadow: 0 12px 34px rgba(15,23,42,.10);

      margin: 0 0 12px 0;
    }

    .cardHead{
      padding: 10px 12px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: var(--card);
      border-bottom: 1px solid var(--stroke2);
      flex: 0 0 auto;
    }
    .pairTitle{ font-weight:850; font-size:22px; }
    .pairSub{ margin-top:2px; font-size:13px; color:var(--muted); }

    .caption{
      padding: 10px 12px 0;
      background: #fff;
      color: var(--text);
      font-weight: 800;
      font-size: 14px;
      letter-spacing: .1px;
    }
    .caption:empty{ display:none; }

    .pairWrap{
      height: var(--pairH);
      position:relative;
      display:grid;
      grid-template-columns: 1fr 1fr;
      background:#fff;

      padding: var(--pairPad) 0;
      box-sizing: border-box;
    }

    .pane{
      position:relative;
      overflow:hidden;
      background:#fff;
      cursor:pointer;
      user-select:none;
    }

    .divider{
      position:absolute;
      top:0; bottom:0;
      left:50%;
      width:1px;
      background: rgba(0,0,0,.08);
      transform: translateX(-.5px);
      pointer-events:none;
      z-index: 2;
    }

    .img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: contain;
      object-position: center;
      background:#fff;
      transform: translateZ(0);
    }

    /* Heart overlay (–ø—É—Å—Ç–æ–µ/–∑–∞–ª–∏—Ç–æ–µ) */
    .heart{
      position:absolute;
      right: 10px;
      bottom: 10px;
      width: 34px;
      height: 34px;
      display:grid;
      place-items:center;
      border-radius: 999px;
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 22px rgba(15,23,42,.16);
      z-index: 3;
      pointer-events:none; /* —á—Ç–æ–±—ã –∫–ª–∏–∫ —à–µ–ª –ø–æ —Ñ–æ—Ç–æ */
      transition: transform .10s ease, background .18s ease, border-color .18s ease;
    }
    .heart svg{ width: 18px; height: 18px; display:block; }
    .heart.isOn{
      background: rgba(15,23,42,.92);
      border-color: rgba(15,23,42,.14);
    }
    .heart.isOn svg path{
      fill: #ffffff;
      stroke: #ffffff;
    }

    /* Right stats rail (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è) */
    .statsRail{
      position:absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      display:none;
      flex-direction: column;
      gap: 10px;
      z-index: 4;
      pointer-events: none;
    }
    .statsRail.show{ display:flex; }
    .statIco{
      width: 34px;
      height: 34px;
      display:grid;
      place-items:center;
      border-radius: 999px;
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 22px rgba(15,23,42,.16);
      color: var(--text);
      position: relative;
    }
    .statIco svg{ width: 18px; height: 18px; display:block; }
    .statIco .num{
      position:absolute;
      bottom: 2px;
      right: 6px;
      font-size: 11px;
      font-weight: 900;
      color: rgba(15,23,42,.75);
    }

    .cardFooter{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 8px 12px 10px;
      background: #fff;
      border-top: 1px solid var(--stroke2);
      flex: 0 0 auto;
    }

    .votes{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:14px;
      color: var(--text);
      font-weight:750;
      letter-spacing:.1px;
    }

    .shareBtn{
      border: 1px solid var(--stroke);
      background: rgba(15,23,42,.04);
      color: var(--text);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight:800;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      transition: transform .10s ease, background .18s ease, border-color .18s ease;
    }
    .shareBtn:active{ transform: scale(.98); }
    .shareIco{ width:16px; height:16px; display:block; opacity:.9; }

    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      height: calc(var(--navH) + var(--safeB));
      padding: 8px 18px calc(8px + var(--safeB));
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      background: rgba(255,255,255,.92);
      border-top: 1px solid var(--stroke);
      z-index:50;
      backdrop-filter: blur(10px);
    }

    .navBtn{
      width:44px; height:44px;
      display:grid;
      place-items:center;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(15,23,42,.04);
      color: var(--text);
      user-select:none;
      cursor:pointer;
      transition: transform .10s ease, background .18s ease;
    }
    .navBtn:active{ transform: scale(.98); }
    .navBtn svg{ width:22px; height:22px; opacity:.95; }

    .plus{
      width:54px; height:54px;
      border-radius:18px;
      background: #0f172a;
      color:#fff;
      border: 1px solid rgba(15,23,42,.15);
      box-shadow: 0 10px 26px rgba(15,23,42,.22);
    }
    .plus svg{ width:26px; height:26px; opacity:1; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(var(--navH) + var(--safeB) + 18px);
      transform: translateX(-50%);
      background: rgba(15,23,42,.92);
      border: 1px solid rgba(255,255,255,.18);
      color: #fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 18px 40px rgba(0,0,0,.20);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 60;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }

    .skeleton{
      height: 100%;
      background: linear-gradient(110deg, rgba(15,23,42,.05) 20%, rgba(15,23,42,.10) 35%, rgba(15,23,42,.05) 50%);
      background-size: 200% 100%;
      animation: shimmer 1.1s linear infinite;
    }
    @keyframes shimmer{
      0%{ background-position: 200% 0; }
      100%{ background-position: -200% 0; }
    }

    /* ===== MODAL UPLOAD (—ç—Ç–∞–ª–æ–Ω, –Ω–µ –º–µ–Ω—è—Ç—å —Å—Ç–∏–ª—å) ===== */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 12px 12px calc(12px + var(--safeB));
      z-index: 80;
    }
    .modal{
      width: min(720px, 100%);
      background: #fff;
      border: 1px solid var(--stroke);
      border-radius: 18px;
      box-shadow: 0 25px 60px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modalHead{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid var(--stroke2);
    }
    .modalTitle{
      font-weight: 850;
      font-size: 16px;
    }
    .modalBody{
      padding: 12px;
      display:grid;
      gap: 10px;
    }
    .uploadGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .pick{
      border: 1px dashed rgba(0,0,0,.22);
      border-radius: 14px;
      padding: 12px;
      background: rgba(15,23,42,.03);
      cursor: pointer;
      user-select:none;
      min-height: 110px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .pickTitle{ font-weight: 850; font-size: 14px; }
    .pickHint{ font-size: 12px; color: var(--muted); }
    .fileName{ font-size: 12px; font-weight: 800; word-break: break-word; }

    .field{
      border: 1px solid var(--stroke2);
      border-radius: 14px;
      padding: 10px 12px;
      background: #fff;
      font-size: 14px;
      outline: none;
      width: 100%;
    }
    .field::placeholder{ color: rgba(15,23,42,.45); }

    .modalActions{
      display:flex;
      gap: 10px;
      margin-top: 4px;
    }
    .wideBtn{ flex:1; justify-content:center; }
    input[type="file"]{ display:none; }
  
    /* ===== PROFILE (v1) ===== */
    .statGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .statCard{
      border: 1px solid var(--stroke2);
      border-radius: 14px;
      padding: 10px 12px;
      background:#fff;
    }
    .statLabel{ font-size: 12px; color: var(--muted); font-weight: 750; }
    .statValue{ margin-top: 4px; font-size: 18px; font-weight: 900; letter-spacing: .2px; }
    .myListTitle{
      margin-top: 6px;
      font-weight: 900;
      font-size: 14px;
      color: var(--text);
    }
    .myPair{
      border: 1px solid var(--stroke2);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    .myPairHead{
      padding: 10px 12px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid var(--stroke2);
    }
    .myPairTitle{ font-weight: 900; font-size: 14px; }
    .myPairStats{ font-size: 12px; color: var(--muted); font-weight: 800; }
    .myPairGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: rgba(0,0,0,.06);
    }
    .myPairGrid img{
      width:100%;
      height: 150px;
      object-fit: cover;
      background:#fff;
      display:block;
    }
    .myPairFoot{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-top: 1px solid var(--stroke2);
    }
    .miniMute{ font-size: 12px; color: var(--muted); font-weight: 800; }

  
    /* PATCH v2.5.5: allow scrolling inside modals (profile) on desktop/miniapp */
    .modalOverlay { overflow: hidden; }
    .modal {
      max-height: calc(100dvh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modalBody {
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }


    /* PATCH v2.5.6: profile body scroll + prevent grid squeezing items */
    .modalBody { flex: 1; min-height: 0; }
    #profileBody { display: block !important; overflow: auto; }
    #profileBody > * { margin-bottom: 10px; }
    #profileBody .myPair { margin-bottom: 10px; }


.linkBtn{
  background: transparent;
  border: 0;
  padding: 0;
  margin: 0;
  color: rgba(17,17,17,.55);
  font-size: 12px;
  text-decoration: underline;
  cursor: pointer;
}
.linkBtn:active{ opacity:.7; }

.reportReasonRow{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin: 10px 0 8px;
}
.reasonBtn{
  border: 1px solid rgba(0,0,0,.14);
  background: #fff;
  border-radius: 999px;
  padding: 8px 10px;
  font-size: 13px;
  cursor:pointer;
}
.reasonBtn.isOn{
  border-color: rgba(0,0,0,.35);
}

    /* ===== PATCH v2.8.8: Admin modal scroll (no squeezing) ===== */
    #adminOverlay .modalBody{
      display: block;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      flex: 1;
      min-height: 0;
    }
    #adminBody{ display:block; }

    .pairThumbs{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: rgba(0,0,0,.06);
    }
    .pairThumb img{
      width: 100%;
      height: 140px;
      object-fit: cover;
      background: #fff;
      display: block;
    }

</style>
</head>

<body>
  <div class="app">
    <div class="top">
      <div class="brand">
        <div class="t">LookingGreat</div>
        <div class="s">–°—Ä–∞–≤–Ω–∏ –∏ –≤—ã–±–µ—Ä–∏ –ª—É—á—à–µ–µ —Ñ–æ—Ç–æ ¬∑ <span id="ver"></span></div>
      </div>
      <div style="opacity:.0; width:1px; height:1px;"></div>
    </div>

    <div id="feed" class="feed"></div>

    <div class="nav">
      <div class="navBtn" id="navHome" title="–î–æ–º">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M4 10.5L12 4l8 6.5V20a1.6 1.6 0 0 1-1.6 1.6H5.6A1.6 1.6 0 0 1 4 20v-9.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <path d="M9.5 21v-7h5v7" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </svg>
      </div>

      <div class="navBtn plus" id="navPlus" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.4" stroke-linecap="round"/>
        </svg>
      </div>

      <div class="navBtn" id="navProfile" title="–ü—Ä–æ—Ñ–∏–ª—å">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 12.2a4.2 4.2 0 1 0-4.2-4.2A4.2 4.2 0 0 0 12 12.2Z" stroke="currentColor" stroke-width="2"/>
          <path d="M20 20.2c-1.8-3.4-5-5.2-8-5.2s-6.2 1.8-8 5.2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <!-- Upload Modal -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Ä—É</div>
        <button class="shareBtn" id="closeModal" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modalBody">
        <div class="uploadGrid">
          <label class="pick" for="fileLeft">
            <div class="pickTitle">–§–æ—Ç–æ 1</div>
            <div class="pickHint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å</div>
            <div class="fileName" id="leftName">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
          </label>
          <label class="pick" for="fileRight">
            <div class="pickTitle">–§–æ—Ç–æ 2</div>
            <div class="pickHint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å</div>
            <div class="fileName" id="rightName">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
          </label>
        </div>

        <input id="fileLeft" type="file" accept="image/*" />
        <input id="fileRight" type="file" accept="image/*" />

        <input id="pairCaption" class="field" type="text"
               placeholder="–ü–æ–¥–ø–∏—Å—å –∫ –ø–∞—Ä–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–∫–æ–π –æ–±—Ä–∞–∑ –ª—É—á—à–µ?)"
               maxlength="80" />

        <div class="modalActions">
          <button class="shareBtn wideBtn" id="doUpload" type="button">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>

        <div class="pairSub" id="uploadStatus" style="display:none; margin:0;"></div>
      </div>
    </div>
  </div>

  
  <!-- Profile Modal -->
  <div class="modalOverlay" id="profileOverlay">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
        <button class="shareBtn" id="closeProfile" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modalBody" id="profileBody">
        <div class="pairSub">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </div>
  </div>

  
  <!-- Report Modal -->
  <div class="modalOverlay" id="reportOverlay" style="display:none;">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle">–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</div>
        <button class="shareBtn" id="closeReport" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modalBody">
        <div class="pairSub" style="margin:0 0 6px;">–í—ã–±–µ—Ä–∏ –ø—Ä–∏—á–∏–Ω—É</div>
        <div class="reportReasonRow">
          <button class="reasonBtn" type="button" data-reason="–°–ø–∞–º">–°–ø–∞–º</button>
          <button class="reasonBtn" type="button" data-reason="–ù–µ–ø—Ä–∏–µ–º–ª–µ–º–æ–µ">–ù–µ–ø—Ä–∏–µ–º–ª–µ–º–æ–µ</button>
          <button class="reasonBtn" type="button" data-reason="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</button>
        </div>
        <textarea id="reportComment" class="captionInput" rows="3" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" maxlength="500"></textarea>
        <div class="modalActions">
          <button class="shareBtn wideBtn" id="sendReport" type="button" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <div class="pairSub" id="reportStatus" style="display:none; margin:0;"></div>
      </div>
    </div>
  </div>

  <!-- Admin Modal (only for tg_id 531932411) -->
  <div class="modalOverlay" id="adminOverlay" style="display:none;">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle">–ê–¥–º–∏–Ω</div>
        <button class="shareBtn" id="closeAdmin" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modalBody" id="adminBody">
        <div class="pairSub">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </div>
  </div>

<script>
    const APP_VERSION = "v2.8.9";
    const API_BASE = "https://api.lookingreat.ru";
    const ADMIN_TG_ID = "531932411";
    const DUEL_LABEL = "–ü–∞—Ä–∞"; // –∑–∞–º–µ–Ω—É –Ω–∞–∑–≤–∞–Ω–∏—è –¥–µ–ª–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç—É—Ç

    const tg = window.Telegram?.WebApp;
    try { tg?.ready(); tg?.expand(); tg?.disableVerticalSwipes?.(); } catch(e) {}

    function getTgId() {
      const id = tg?.initDataUnsafe?.user?.id;
      if (id) return String(id);
      return localStorage.getItem("DEV_TG_ID") || "531932411";
    }

    let tg_id = "";
    function refreshTgId(){ tg_id = getTgId(); return tg_id; }
    refreshTgId();

    if (!tg?.initDataUnsafe?.user?.id) {
      console.log("DEV MODE (not in Telegram). tg_id =", tg_id);
      window.setDevTgId = (v) => { localStorage.setItem("DEV_TG_ID", String(v)); location.reload(); };
    }

    const feedEl = document.getElementById("feed");
    const toastEl = document.getElementById("toast");
    document.getElementById("ver").textContent = APP_VERSION;

    let toastTimer = null;
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toastEl.classList.remove("show"), 1600);
    }
    function haptic(type="light"){
      try { tg?.HapticFeedback?.impactOccurred?.(type); } catch(e) {}
    }

    async function apiGet(path){
      const res = await fetch(API_BASE + path, { method:"GET", cache:"no-store" });
      return res.json();
    }
    async function apiPost(path, body){
      const res = await fetch(API_BASE + path, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      return res.json();
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }


    function pluralVotes(n){
      n = Math.abs(Number(n)) || 0;
      const mod10 = n % 10;
      const mod100 = n % 100;
      if (mod10 === 1 && mod100 !== 11) return "–≥–æ–ª–æ—Å";
      if (mod10 >= 2 && mod10 <= 4 && !(mod100 >= 12 && mod100 <= 14)) return "–≥–æ–ª–æ—Å–∞";
      return "–≥–æ–ª–æ—Å–æ–≤";
    }

    function sharePair(pairId){
      const shareText = `–°—Ä–∞–≤–Ω–∏ ${DUEL_LABEL.toLowerCase()} #${pairId} –≤ LookingGreat`;
      const link = `https://t.me/share/url?url=${encodeURIComponent("https://lookingreat.ru")}&text=${encodeURIComponent(shareText)}`;
      try { tg?.openTelegramLink?.(link); } catch(e) { window.open(link, "_blank"); }
    }

    function photoUrlFromKey(key){
      if (!key) return "";
      return `${API_BASE}/r2/${encodeURIComponent(String(key))}`;
    }

    // Admin calls silentRefreshTop(); map to existing refreshFeedTopSilently()
    function silentRefreshTop(){
      refreshFeedTopSilently();
    }

    function choiceKey(pairId){ return `LG_VOTE_${tg_id}_${pairId}`; }
    function getLocalChoice(pairId){
      try { return localStorage.getItem(choiceKey(pairId)) || ""; } catch(e) { return ""; }
    }
    function setLocalChoice(pairId, choice){
      try { localStorage.setItem(choiceKey(pairId), choice); } catch(e) {}
    }

    function heartSvg(){
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 21s-7.2-4.7-9.6-9C.8 8.6 2.7 5.6 5.8 5c2-.4 4 .3 5.2 1.7C12.2 5.3 14.2 4.6 16.2 5c3.1.6 5 3.6 3.4 7C19.2 16.3 12 21 12 21Z"
                stroke="rgba(15,23,42,.92)" stroke-width="1.9" stroke-linejoin="round"/>
        </svg>
      `;
    }
    function statThumbSvg(){
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M9.5 10.2V20a2 2 0 0 1-2 2H5.2A2.2 2.2 0 0 1 3 19.8v-7.3a2.2 2.2 0 0 1 2.2-2.2h1.4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M9.5 10.2l4.5-6.5c.6-.9 2-.5 2 .6v5.9h3.3c1.3 0 2.2 1.2 1.9 2.4l-1.3 6.3c-.2 1-1.1 1.7-2.1 1.7H9.5" stroke="currentColor" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
        </svg>
      `;
    }

    function cardTemplate(item){
      const pairNum = item?.id ?? "‚Äî";
      const totalVotes = Number(item?.total_votes ?? item?.votes_total ?? item?.votes ?? 0);
      const votesLeft = Number(item?.votes_left ?? item?.left_votes ?? 0);
      const votesRight = Number(item?.votes_right ?? item?.right_votes ?? 0);
      const denom = (Number.isFinite(totalVotes) && totalVotes > 0) ? totalVotes : (votesLeft + votesRight);
      const base = denom > 0 ? denom : 0;
      const pctL = base ? Math.round((votesLeft / base) * 100) : 0;
      const pctR = base ? (100 - pctL) : 0;
      const votesText = `üëç ${isFinite(totalVotes) ? totalVotes : 0} ${pluralVotes(isFinite(totalVotes) ? totalVotes : 0)}`;

      const leftUrl =
        item?.photo_left_url ||
        (item?.photo_left_key ? `${API_BASE}/r2/${encodeURIComponent(item.photo_left_key)}` : "");

      const rightUrl =
        item?.photo_right_url ||
        (item?.photo_right_key ? `${API_BASE}/r2/${encodeURIComponent(item.photo_right_key)}` : "");

      const caption = (item?.caption ?? item?.title ?? item?.question ?? "").toString().trim();

      const headTitle = caption ? caption : `${DUEL_LABEL} #${pairNum}`;

      const serverChoice = (item?.my_choice || item?.myChoice || "").toString().trim();
      const localChoice = getLocalChoice(pairNum);
      const choice = (serverChoice || localChoice || "").toLowerCase();
      const voted = choice === "left" || choice === "right";

      const subHtml = voted ? "" : `<div class="pairSub">–ß—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å ‚Äî –Ω–∞–∂–º–∏ –Ω–∞ —Ñ–æ—Ç–æ</div>`;
      const footerText = (voted && (isFinite(totalVotes) ? totalVotes : 0) > 0)
        ? `üëç ${isFinite(totalVotes) ? totalVotes : 0} ${pluralVotes(isFinite(totalVotes) ? totalVotes : 0)} ¬∑ ${pctL}% / ${pctR}%`
        : `üëç ${isFinite(totalVotes) ? totalVotes : 0} ${pluralVotes(isFinite(totalVotes) ? totalVotes : 0)}`;

      return `
        <div class="card" data-pair-id="${escapeHtml(pairNum)}" data-choice="${escapeHtml(choice)}">
          <div class="cardHead">
            <div>
              <div class="pairTitle">${escapeHtml(headTitle)}</div>
              ${subHtml}
            </div>
            <div></div>
          </div>

          <div class="caption"></div>

          <div class="pairWrap">
            <div class="divider"></div>

            <div class="pane" data-choice="left">
              ${leftUrl ? `<img class="img" src="${escapeHtml(leftUrl)}" alt="–§–æ—Ç–æ 1" />` : `<div class="skeleton"></div>`}
              <div class="heart ${choice==="left" ? "isOn": ""}" data-heart="left" aria-hidden="true">${heartSvg()}</div>
            </div>

            <div class="pane" data-choice="right">
              ${rightUrl ? `<img class="img" src="${escapeHtml(rightUrl)}" alt="–§–æ—Ç–æ 2" />` : `<div class="skeleton"></div>`}
              <div class="heart ${choice==="right" ? "isOn": ""}" data-heart="right" aria-hidden="true">${heartSvg()}</div>
            </div>
          </div>

          <div class="cardFooter">
            <div>
              <div class="votes" data-votes>${escapeHtml(footerText)}</div>
              <button class="linkBtn reportBtn" type="button" data-report="${escapeHtml(pairNum)}">–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</button>
            </div>
            <button class="shareBtn" type="button" aria-label="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
              <svg class="shareIco" viewBox="0 0 24 24" fill="none">
                <path d="M16 8.5l-8 4m8 3.5l-8-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M18.5 9.8a2.3 2.3 0 1 0 0-4.6 2.3 2.3 0 0 0 0 4.6Z" stroke="currentColor" stroke-width="2"/>
                <path d="M18.5 21a2.3 2.3 0 1 0 0-4.6 2.3 2.3 0 0 0 0 4.6Z" stroke="currentColor" stroke-width="2"/>
                <path d="M5.5 15.4a2.3 2.3 0 1 0 0-4.6 2.3 2.3 0 0 0 0 4.6Z" stroke="currentColor" stroke-width="2"/>
              </svg>
              –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
            </button>
          </div>
        </div>
      `;
    }

    let loading = false;
    let lastScrollTop = 0;
    let feedItems = [];
    let nextBeforeId = null;
    let reachedEnd = false;
    let loadingMore = false;
    let lastTopSig = "";

const FEED_PAGE_SIZE = 10;

async function fetchFeedPage(beforeId=null, limit=FEED_PAGE_SIZE){
  refreshTgId();
  const qs = new URLSearchParams({ tg_id: tg_id, limit: String(limit) });
  if (beforeId) qs.set("before_id", String(beforeId));
  const data = await apiGet(`/feed?${qs.toString()}`);

  let items = [];
  if (data?.ok && Array.isArray(data?.items)) items = data.items;
  else if (data?.ok && data?.item) items = [data.item];
  else if (Array.isArray(data)) items = data;
  else if (data?.item) items = [data.item];

  const next = data?.next_before_id ?? (items.length ? (items[items.length-1]?.id ?? null) : null);
  return { items, next_before_id: next };
}

function buildTopSig(items){
  return items.map(it => {
    const pid = it?.id ?? it?.pair_id ?? it?.photo_pair_id ?? "";
    const vL = Number(it?.votes_left ?? it?.left_votes ?? it?.votesLeft ?? 0);
    const vR = Number(it?.votes_right ?? it?.right_votes ?? it?.votesRight ?? 0);
    const t  = Number(it?.total_votes ?? it?.votes_total ?? it?.total ?? (vL+vR));
    const c  = (it?.my_choice || it?.myChoice || getLocalChoice(pid) || "");
    return `${pid}:${t}:${c}`;
  }).join("|");
}

function renderFeed(items, { preserveScroll=true, showLoading=null } = {}){
  if (showLoading === null) showLoading = !feedEl.innerHTML.trim();
  if (preserveScroll) lastScrollTop = feedEl.scrollTop;

  if (showLoading) {
    feedEl.innerHTML = `
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="pairTitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
            <div class="pairSub">–ß—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å ‚Äî –Ω–∞–∂–º–∏ –Ω–∞ —Ñ–æ—Ç–æ</div>
          </div>
          <div></div>
        </div>
        <div class="pairWrap">
          <div class="divider"></div>
          <div class="pane"><div class="skeleton"></div></div>
          <div class="pane"><div class="skeleton"></div></div>
        </div>
        <div class="cardFooter">
          <div class="votes">üëç 0 –≥–æ–ª–æ—Å–æ–≤</div>
          <button class="shareBtn" type="button">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
        </div>
      </div>
    `;
  }

  if (!items.length){
    feedEl.innerHTML = `
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="pairTitle">–ü–æ–∫–∞ –Ω–µ—Ç –ø–∞—Ä</div>
            <div class="pairSub">–ù–∞–∂–º–∏ ‚Äú+‚Äù —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
          </div>
        </div>
        <div class="pairWrap">
          <div class="divider"></div>
          <div class="pane"></div>
          <div class="pane"></div>
        </div>
        <div class="cardFooter">
          <div class="votes">üëç 0 –≥–æ–ª–æ—Å–æ–≤</div>
          <button class="shareBtn" type="button">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
        </div>
      </div>
    `;
    bindEvents();
    return;
  }

  feedEl.innerHTML = items.map(cardTemplate).join("");
  bindEvents();

  if (preserveScroll) feedEl.scrollTop = Math.min(lastScrollTop, feedEl.scrollHeight);
}

function appendFeed(moreItems){
  if (!moreItems.length) return;
  feedEl.insertAdjacentHTML("beforeend", moreItems.map(cardTemplate).join(""));
  bindEvents();
}

async function loadFeedFirst({ preserveScroll=true, showLoading=null } = {}){
  if (loading) return;
  loading = true;
  reachedEnd = false;
  nextBeforeId = null;

  try{
    const { items, next_before_id } = await fetchFeedPage(null, FEED_PAGE_SIZE);

    feedItems = items;
    nextBeforeId = next_before_id || null;
    reachedEnd = !nextBeforeId || !items.length;

    lastTopSig = buildTopSig(items);

    renderFeed(feedItems, { preserveScroll, showLoading });
  } catch(e){
    feedEl.innerHTML = `
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="pairTitle">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
            <div class="pairSub">–ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏</div>
          </div>
        </div>
        <div class="pairWrap">
          <div class="divider"></div>
          <div class="pane"></div>
          <div class="pane"></div>
        </div>
        <div class="cardFooter">
          <div class="votes">üëç 0 –≥–æ–ª–æ—Å–æ–≤</div>
          <button class="shareBtn" type="button" id="retryBtn">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
        </div>
      </div>
    `;
    document.getElementById("retryBtn")?.addEventListener("click", ()=>loadFeedFirst({preserveScroll:false, showLoading:true}));
  } finally {
    loading = false;
  }
}

async function loadFeedMore(){
  if (loadingMore || loading) return;
  if (reachedEnd || !nextBeforeId) return;

  loadingMore = true;
  try{
    const { items, next_before_id } = await fetchFeedPage(nextBeforeId, FEED_PAGE_SIZE);

    if (!items.length){
      reachedEnd = true;
      nextBeforeId = null;
      return;
    }

    feedItems = feedItems.concat(items);
    nextBeforeId = next_before_id || null;
    if (!nextBeforeId) reachedEnd = true;

    appendFeed(items);
  } catch(e){
    console.log("AUTO /feed failed:", e);ly ignore; next scroll will retry
  } finally {
    loadingMore = false;
  }
}

async function refreshFeedTopSilently(){
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Ö —Ç–∏—Ö–æ –∏ –±–µ–∑ –¥–µ—Ä–≥–∞–Ω–∏—è: —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–≤–µ—Ä—Ö—É,
  // –∏ –∫–æ–≥–¥–∞ –Ω–µ –æ—Ç–∫—Ä—ã—Ç—ã –º–æ–¥–∞–ª–∫–∏ (–ø—Ä–æ—Ñ–∏–ª—å/–∑–∞–≥—Ä—É–∑–∫–∞).
  try{
    const profileOpen = !!profileOverlay && profileOverlay.style.display !== "none";
    const uploadOpen  = !!modalOverlay && modalOverlay.style.display !== "none";
    const reportOpen  = !!reportOverlay && reportOverlay.style.display !== "none";
    const adminOpen   = !!adminOverlay && adminOverlay.style.display !== "none";
    if (profileOpen || uploadOpen || reportOpen || adminOpen) return;
  } catch(e){}

  if (feedEl.scrollTop > 120) return;

  try{
    const { items } = await fetchFeedPage(null, FEED_PAGE_SIZE);
    const sig = buildTopSig(items);

    if (sig === lastTopSig) return;

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–∞—Ä—ã —Å–≤–µ—Ä—Ö—É (–ø–æ id)
    const existingIds = new Set(feedItems.map(x => x?.id));
    const newOnTop = items.filter(x => !existingIds.has(x?.id));

    if (!newOnTop.length){
      // –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –≥–æ–ª–æ—Å–∞/–≤—ã–±–æ—Ä—ã –≤ –≤–µ—Ä—Ö–Ω–∏—Ö –∫–∞—Ä—Ç–æ—á–∫–∞—Ö ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ—Ä—Ö—É, –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å
      feedItems = items.concat(feedItems.filter(x => !items.some(t => t?.id === x?.id)));
      renderFeed(feedItems, { preserveScroll:true, showLoading:false });
    } else {
      feedItems = newOnTop.concat(feedItems);
      renderFeed(feedItems, { preserveScroll:true, showLoading:false });
    }

    lastTopSig = sig;
  } catch(e){
    console.log("AUTO /feed failed:", e);
  }
}

// Backward compatibility (older call-sites)
function loadFeed(opts){ return loadFeedFirst(opts); }

    function setHeart(cardEl, choice){
      const hL = cardEl.querySelector('[data-heart="left"]');
      const hR = cardEl.querySelector('[data-heart="right"]');
      if (hL) hL.classList.toggle("isOn", choice === "left");
      if (hR) hR.classList.toggle("isOn", choice === "right");
      cardEl.setAttribute("data-choice", choice || "");
    }

    function bumpVotesUI(cardEl, delta, choice){
      const v = cardEl.querySelector("[data-votes]");
      if (!v) return;
      const m = v.textContent.match(/(\d+)/);
      const cur = m ? Number(m[1]) : 0;
      const next = Math.max(0, cur + delta);
      v.textContent = `üëç ${next} ${pluralVotes(next)}`;
    }

    async function vote(pairId, choice, cardEl){
      haptic("light");

      const existing = (cardEl?.getAttribute("data-choice") || "").toLowerCase();
      if (existing === "left" || existing === "right") {
        toast("–¢—ã —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª");
        return false;
      }

      try{
        setHeart(cardEl, choice);
        bumpVotesUI(cardEl, +1, choice);

        const body = { tg_id, pair_id: Number(pairId), choice };
        const res = await apiPost(`/vote`, body);

        if (!res?.ok){
          setHeart(cardEl, "");
          bumpVotesUI(cardEl, -1, choice);

          if (res?.error === "cannot_vote_own_pair"){
            toast("–ù–µ–ª—å–∑—è –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –∑–∞ —Å–≤–æ—é –ø–∞—Ä—É");
            haptic("error");
            return false;
          }
          if (res?.error === "already_voted"){
            toast("–¢—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª –∑–∞ —ç—Ç—É –ø–∞—Ä—É");
            setLocalChoice(pairId, choice);
            setHeart(cardEl, choice);
            return false;
          }

          toast("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å");
          haptic("error");
          return false;
        }

        // –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É ‚Äî –æ–±–Ω–æ–≤–∏–º —Ñ—É—Ç–µ—Ä —Ç–æ—á–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        try{
          if (cardEl && typeof res.votes_left !== "undefined" && typeof res.votes_right !== "undefined"){
            const vL = Number(res.votes_left||0);
            const vR = Number(res.votes_right||0);
            const t = Number(res.total_votes|| (vL+vR) || 0);
            const pL = t ? Math.round((vL/t)*100) : 0;
            const pR = t ? (100 - pL) : 0;
            const footer = cardEl.querySelector("[data-votes]");
            if (footer) footer.textContent = (t > 0) ? `üëç ${t} ${pluralVotes(t)} ¬∑ ${pL}% / ${pR}%` : `üëç 0 –≥–æ–ª–æ—Å–æ–≤`;
          }
        }catch(e){}

        setLocalChoice(pairId, choice);
        toast("–ì–æ–ª–æ—Å —É—á—Ç—ë–Ω");
        haptic("success");
        return true;

      } catch(e){
        setHeart(cardEl, "");
        bumpVotesUI(cardEl, -1, choice);
        toast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
        haptic("error");
        return false;
      }
    }

    function bindEvents(){
      document.querySelectorAll(".card .pane").forEach(pane=>{
        pane.addEventListener("click", async ()=>{
          const card = pane.closest(".card");
          const pairId = card?.getAttribute("data-pair-id");
          const choice = pane.getAttribute("data-choice");
          if (!pairId || !choice) return;
          await vote(pairId, choice, card);
        });
      });

      document.querySelectorAll(".card .shareBtn").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const card = btn.closest(".card");
          const pairId = card?.getAttribute("data-pair-id") || "";
          sharePair(pairId);
        });
      });

      document.querySelectorAll(".card .reportBtn").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const card = btn.closest(".card");
          const pairId = btn.getAttribute("data-report") || card?.getAttribute("data-pair-id") || "";
          if (!pairId) return;
          openReport(pairId);
        });
      });

      document.getElementById("navHome")?.addEventListener("click", ()=> {
        feedEl.scrollTo({ top: 0, behavior: "smooth" });
      });

      document.getElementById("navPlus")?.addEventListener("click", ()=> {
        openUploadModal();
      });

      document.getElementById("navProfile")?.addEventListener("click", ()=> {
        openProfile();
      });
    }


    // Profile modal logic (v1)
    const profileOverlay = document.getElementById("profileOverlay");
    const profileBody = document.getElementById("profileBody");
    const closeProfileBtn = document.getElementById("closeProfile");

    function openProfile(){
      profileBody.innerHTML = `<div class="pairSub">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>`;
      profileOverlay.style.display = "flex";
      loadProfile();
    }
    function closeProfile(){ profileOverlay.style.display = "none"; }

    closeProfileBtn.addEventListener("click", closeProfile);
    profileOverlay.addEventListener("click", (e)=>{ if (e.target === profileOverlay) closeProfile(); });

    
    // Report modal logic
    const reportOverlay = document.getElementById("reportOverlay");
    const closeReportBtn = document.getElementById("closeReport");
    const sendReportBtn = document.getElementById("sendReport");
    const reportCommentEl = document.getElementById("reportComment");
    const reportStatusEl = document.getElementById("reportStatus");
    let reportPairId = "";
    let reportReason = "";

    function openReport(pairId){
      reportPairId = String(pairId || "");
      reportReason = "";
      if (reportCommentEl) reportCommentEl.value = "";
      if (reportStatusEl) reportStatusEl.style.display = "none";
      if (sendReportBtn) sendReportBtn.disabled = true;
      document.querySelectorAll(".reasonBtn").forEach(b=>b.classList.remove("isOn"));
      if (reportOverlay) reportOverlay.style.display = "flex";
    }
    function closeReport(){
      if (reportOverlay) reportOverlay.style.display = "none";
    }
    closeReportBtn?.addEventListener("click", closeReport);
    reportOverlay?.addEventListener("click", (e)=>{ if (e.target === reportOverlay) closeReport(); });

    document.querySelectorAll(".reasonBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        reportReason = btn.getAttribute("data-reason") || "";
        document.querySelectorAll(".reasonBtn").forEach(b=>b.classList.remove("isOn"));
        btn.classList.add("isOn");
        if (sendReportBtn) sendReportBtn.disabled = !reportReason;
      });
    });

    sendReportBtn?.addEventListener("click", async ()=>{
      try{
        if (!reportPairId || !reportReason) return;
        refreshTgId();
        sendReportBtn.disabled = true;
        if (reportStatusEl){ reportStatusEl.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶"; reportStatusEl.style.display = "block"; }
        const payload = {
          tg_id,
          pair_id: Number(reportPairId),
          reason: reportReason,
          comment: (reportCommentEl?.value || "").trim()
        };
        const res = await apiPost("/report", payload);
        if (!res?.ok) throw new Error(res?.error || "report_failed");
        toast("–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞");
        closeReport();
      } catch(e){
        toast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å");
        if (reportStatusEl){ reportStatusEl.textContent = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏"; reportStatusEl.style.display = "block"; }
      } finally {
        if (sendReportBtn) sendReportBtn.disabled = false;
      }
    });

    // Admin modal logic
    const adminOverlay = document.getElementById("adminOverlay");
    const adminBody = document.getElementById("adminBody");
    const closeAdminBtn = document.getElementById("closeAdmin");

    function isAdminClient(){ return String(tg_id) === ADMIN_TG_ID; }

    function openAdmin(){
      if (!isAdminClient()) return;
      if (adminBody) adminBody.innerHTML = `<div class="pairSub">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>`;
      if (adminOverlay) adminOverlay.style.display = "flex";
      loadAdminReports();
    }
    function closeAdmin(){ if (adminOverlay) adminOverlay.style.display = "none"; }

    closeAdminBtn?.addEventListener("click", closeAdmin);
    adminOverlay?.addEventListener("click", (e)=>{ if (e.target === adminOverlay) closeAdmin(); });

    async function loadAdminReports(){
  try{
    refreshTgId();
    const data = await apiGet(`/admin/reports?tg_id=${encodeURIComponent(tg_id)}&limit=50`);
    if (!data?.ok) throw new Error(data?.error || "bad_response");

    // Worker returns { ok:true, items:[ ... ] }
    const items = Array.isArray(data.items) ? data.items : [];

    if (!items.length){
      adminBody.innerHTML = `<div class="pairSub">–ñ–∞–ª–æ–± –ø–æ–∫–∞ –Ω–µ—Ç</div>`;
      return;
    }

    const statusLabel = (st)=>{
      if (st === "hidden") return "—Å–∫—Ä—ã—Ç–∞";
      if (st === "deleted") return "—É–¥–∞–ª–µ–Ω–∞";
      return "–≤–∏–¥–Ω–∞";
    };

    adminBody.innerHTML = items.map(r=>{
      const st = (r.status || "visible").toLowerCase();
      const caption = (r.caption || "").trim();
      const title = caption ? caption : `–ü–∞—Ä–∞ #${r.pair_id}`;
      const when = r.created_at ? new Date(Number(r.created_at)*1000).toLocaleString("ru-RU") : "";
      const leftUrl = photoUrlFromKey(r.photo_left_key);
      const rightUrl = photoUrlFromKey(r.photo_right_key);

      const actions = [];
      if (st === "visible"){
        actions.push(`<button class="shareBtn" type="button" data-setstatus="hidden">–°–∫—Ä—ã—Ç—å</button>`);
        actions.push(`<button class="shareBtn" type="button" data-setstatus="deleted">–£–¥–∞–ª–∏—Ç—å</button>`);
      } else if (st === "hidden"){
        actions.push(`<button class="shareBtn" type="button" data-setstatus="visible">–ü–æ–∫–∞–∑–∞—Ç—å</button>`);
        actions.push(`<button class="shareBtn" type="button" data-setstatus="deleted">–£–¥–∞–ª–∏—Ç—å</button>`);
      } else if (st === "deleted"){
        actions.push(`<button class="shareBtn" type="button" data-setstatus="visible">–ü–æ–∫–∞–∑–∞—Ç—å</button>`);
      }

      return `
        <div class="card" data-admin-pair="${escapeHtml(r.pair_id)}">
          <div class="cardHead">
            <div>
              <div class="pairTitle">${escapeHtml(title)}</div>
              <div class="pairSub">–ü—Ä–∏—á–∏–Ω–∞: ${escapeHtml(r.reason || "")}${r.comment ? " ¬∑ " + escapeHtml(r.comment) : ""}</div>
              <div class="pairSub">–°—Ç–∞—Ç—É—Å: ${escapeHtml(statusLabel(st))}${when ? " ¬∑ " + escapeHtml(when) : ""}</div>
            </div>
            <div></div>
          </div>

          <div class="pairThumbs">
            <div class="pairThumb"><img src="${leftUrl}" alt=""></div>
            <div class="pairThumb"><img src="${rightUrl}" alt=""></div>
          </div>

          <div class="cardFooter">
            <div class="votes">–ü–∞—Ä–∞: #${escapeHtml(r.pair_id)} ¬∑ –ñ–∞–ª–æ–±–∞: #${escapeHtml(r.id)}</div>
            <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
              ${actions.join("")}
            </div>
          </div>
        </div>
      `;
    }).join("");

    adminBody.querySelectorAll("button[data-setstatus]").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        e.stopPropagation();
        const card = btn.closest(".card");
        const pairId = card?.getAttribute("data-admin-pair");
        const status = btn.getAttribute("data-setstatus");
        if (!pairId || !status) return;

        try{
          btn.disabled = true;
          const res = await apiPost("/admin/pair_status", { tg_id, pair_id: Number(pairId), status });
          if (!res?.ok) throw new Error(res?.error || "update_failed");
          toast("–ì–æ—Ç–æ–≤–æ");
          // refresh both admin list and feed silently
          loadAdminReports();
          silentRefreshTop();
        } catch(err){
          toast("–û—à–∏–±–∫–∞");
        } finally {
          btn.disabled = false;
        }
      });
    });

  } catch(e){
    adminBody.innerHTML = `<div class="pairSub">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>`;
  }
}

	function fmtPct(v){
      const n = Number(v) || 0;
      return `${n}%`;
    }

    async function loadProfile(){
      try{
        refreshTgId();
        const data = await apiGet(`/my_pairs?tg_id=${encodeURIComponent(tg_id)}`);
        if (!data?.ok) throw new Error(data?.error || "bad_response");

        const stats = data.stats || {};
        const items = Array.isArray(data.items) ? data.items : [];

        const pairsCount = Number(stats.pairs_count || 0);
        const totalVotes = Number(stats.total_votes || 0);
        const avgPercent = Number(stats.avg_percent || 0);
        const bestPairId = stats.best_pair_id;
        const bestPercent = Number(stats.best_percent || 0);

        const bestText = (bestPairId ? `${DUEL_LABEL} #${bestPairId} ‚Äî ${bestPercent}%` : "‚Äî");

        const statsHtml = `
          ${isAdminClient() ? '<div class="modalActions"><button class="shareBtn wideBtn" id="openAdminBtn" type="button">–ê–¥–º–∏–Ω</button></div>' : ''}
          <div class="statGrid">
            <div class="statCard">
              <div class="statLabel">–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–∞—Ä</div>
              <div class="statValue">${pairsCount}</div>
            </div>
            <div class="statCard">
              <div class="statLabel">–í—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤</div>
              <div class="statValue">${totalVotes}</div>
            </div>
            <div class="statCard">
              <div class="statLabel">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
              <div class="statValue">${fmtPct(avgPercent)}</div>
            </div>
            <div class="statCard">
              <div class="statLabel">–õ—É—á—à–∞—è –ø–∞—Ä–∞</div>
              <div class="statValue" style="font-size:14px; line-height:1.15">${escapeHtml(bestText)}</div>
            </div>
          </div>
          <div class="myListTitle">–ú–æ–∏ –ø–∞—Ä—ã</div>
        `;

        const listHtml = items.map((it)=>{
          const id = it?.id ?? "‚Äî";
          const vL = Number(it?.votes_left || 0);
          const vR = Number(it?.votes_right || 0);
          const t = Number(it?.total_votes || (vL+vR) || 0);
          const pL = Number(it?.pct_left || (t ? Math.round((vL/t)*100) : 0));
          const pR = Number(it?.pct_right || (t ? (100-pL) : 0));
          const leftUrl = it?.photo_left_key ? `${API_BASE}/r2/${encodeURIComponent(it.photo_left_key)}` : "";
          const rightUrl = it?.photo_right_key ? `${API_BASE}/r2/${encodeURIComponent(it.photo_right_key)}` : "";

          const statLine = (t > 0) ? `üëç ${t} ${pluralVotes(t)} ¬∑ ${pL}% / ${pR}%` : `üëç 0 –≥–æ–ª–æ—Å–æ–≤`;

          return `
            <div class="myPair" data-my-id="${escapeHtml(id)}">
              <div class="myPairHead">
                <div class="myPairTitle">${escapeHtml(DUEL_LABEL)} #${escapeHtml(id)}</div>
                <div class="myPairStats">${escapeHtml(statLine)}</div>
              </div>
              <div class="myPairGrid">
                ${leftUrl ? `<img src="${escapeHtml(leftUrl)}" alt="–§–æ—Ç–æ 1" />` : `<div class="skeleton"></div>`}
                ${rightUrl ? `<img src="${escapeHtml(rightUrl)}" alt="–§–æ—Ç–æ 2" />` : `<div class="skeleton"></div>`}
              </div>
              <div class="myPairFoot">
                <div class="miniMute">üëç ${t}</div>
                <button class="shareBtn" type="button" data-share="${escapeHtml(id)}">
                  <svg class="shareIco" viewBox="0 0 24 24" fill="none">
                    <path d="M16 8.5l-8 4m8 3.5l-8-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M18.5 9.8a2.3 2.3 0 1 0 0-4.6 2.3 2.3 0 0 0 0 4.6Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M18.5 21a2.3 2.3 0 1 0 0-4.6 2.3 2.3 0 0 0 0 4.6Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M5.5 15.4a2.3 2.3 0 1 0 0-4.6 2.3 2.3 0 0 0 0 4.6Z" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                </button>
              </div>
            </div>
          `;
        }).join("");

        profileBody.innerHTML = statsHtml + (listHtml || `<div class="pairSub">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–∞—Ä</div>`);

        profileBody.querySelector("#openAdminBtn")?.addEventListener("click", openAdmin);

        // bind share buttons inside profile
        profileBody.querySelectorAll('[data-share]').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            e.stopPropagation();
            const id = btn.getAttribute('data-share') || "";
            sharePair(id);
          });
        });

      }catch(e){
        profileBody.innerHTML = `<div class="pairSub">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å. –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏.</div>`;
      }
    }

    // Upload modal logic (—ç—Ç–∞–ª–æ–Ω)
    const modalOverlay = document.getElementById("modalOverlay");
    const closeModalBtn = document.getElementById("closeModal");
    const doUploadBtn = document.getElementById("doUpload");
    const fileLeft = document.getElementById("fileLeft");
    const fileRight = document.getElementById("fileRight");
    const leftName = document.getElementById("leftName");
    const rightName = document.getElementById("rightName");
    const uploadStatus = document.getElementById("uploadStatus");
    const pairCaptionEl = document.getElementById("pairCaption");

    function openUploadModal(){
      uploadStatus.style.display = "none";
      uploadStatus.textContent = "";
      modalOverlay.style.display = "flex";
    }
    function closeUploadModal(){ modalOverlay.style.display = "none"; }

    closeModalBtn.addEventListener("click", closeUploadModal);
    modalOverlay.addEventListener("click", (e)=>{ if (e.target === modalOverlay) closeUploadModal(); });

    fileLeft.addEventListener("change", ()=>{
      leftName.textContent = fileLeft.files?.[0]?.name ? fileLeft.files[0].name : "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
    });
    fileRight.addEventListener("change", ()=>{
      rightName.textContent = fileRight.files?.[0]?.name ? fileRight.files[0].name : "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
    });

    doUploadBtn.addEventListener("click", async ()=>{
      const f1 = fileLeft.files?.[0];
      const f2 = fileRight.files?.[0];
      const caption = (pairCaptionEl?.value || "").trim();

      if (!f1 || !f2){
        uploadStatus.style.display = "block";
        uploadStatus.textContent = "–í—ã–±–µ—Ä–∏ –æ–±–∞ —Ñ–æ—Ç–æ.";
        return;
      }

      uploadStatus.style.display = "block";
      uploadStatus.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
      haptic("light");

      try{
        refreshTgId();
        const fd = new FormData();
        fd.append("tg_id", String(tg_id));
        fd.append("left", f1);
        fd.append("right", f2);
        if (caption) fd.append("caption", caption);

        const res = await fetch(API_BASE + "/upload_pair", { method: "POST", body: fd });
        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data?.ok) throw new Error(data?.error || ("HTTP " + res.status));

        uploadStatus.textContent = "–ì–æ—Ç–æ–≤–æ! –ü–∞—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.";
        haptic("success");

        fileLeft.value = "";
        fileRight.value = "";
        leftName.textContent = "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
        rightName.textContent = "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
        pairCaptionEl.value = "";

        setTimeout(()=>{
          closeUploadModal();
          loadFeed({ preserveScroll:false, showLoading:true });

            }, 900);

      } catch(e){
        uploadStatus.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.";
        haptic("error");
      }
    });

    loadFeed({ preserveScroll:false, showLoading:true });

// Infinite scroll: load next page when close to bottom
feedEl.addEventListener("scroll", () => {
  try{
    const nearBottom = (feedEl.scrollTop + feedEl.clientHeight) >= (feedEl.scrollHeight - 260);
    if (nearBottom) loadFeedMore();
  } catch(e){}
});


    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ–Ω—Ç—ã –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ (—Ç–∏—Ö–æ, –±–µ–∑ –¥–µ—Ä–≥–∞–Ω–∏—è UI)
    // –ü–∞—É–∑–∞, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –ø—Ä–æ—Ñ–∏–ª—å –∏–ª–∏ –º–æ–¥–∞–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    // ===== PATCH v2.8.9: robust auto-refresh (debuggable) =====
    // –í–∞–∂–Ω–æ: –∏–Ω–æ–≥–¥–∞ WebView/–±—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ—Ç –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å/—Ç—Ä–æ—Ç—Ç–ª–∏—Ç—å —Ç–∞–π–º–µ—Ä—ã.
    // –ü–æ—ç—Ç–æ–º—É: cache:no-store –≤ apiGet + —è–≤–Ω—ã–π –ª–æ–≥ –∫–∞–∂–¥–æ–≥–æ —Ç–∏–∫–∞.
    window.__autoTimer = null;

    function startAutoRefresh(){
      if (window.__autoTimer) clearInterval(window.__autoTimer);

      // –ø–µ—Ä–≤—ã–π –ø—Ä–æ–≥–æ–Ω —Å—Ä–∞–∑—É
      try{
        console.log("AUTO start");
        refreshFeedTopSilently();
      } catch(e){
        console.log("AUTO first tick error:", e);
      }

      window.__autoTimer = setInterval(()=>{
        try{
          console.log("AUTO tick", Date.now());
          refreshFeedTopSilently();
        } catch(e){
          console.log("AUTO tick error:", e);
        }
      }, 10000);
    }

    startAutoRefresh();
</script>
</body>
</html>
