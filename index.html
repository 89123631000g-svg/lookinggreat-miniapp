<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LookingGreat</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* { box-sizing: border-box; }

html, body {
  margin: 0;
  padding: 0;
  height: 100dvh;
  overflow: hidden;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: #ffffff;
  color: #111;
}

.app {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.tabs {
  display: flex;
  gap: 8px;
  padding: 12px;
}

.tab {
  flex: 1;
  padding: 10px;
  border-radius: 12px;
  border: 1px solid #eee;
  background: #f5f5f5;
  text-align: center;
  font-weight: 600;
  cursor: pointer;
}

.tab.active {
  background: #111;
  color: #fff;
}

.content {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 12px;
  min-height: 0;
}

.vote-grid {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  min-height: 0;
}

.vote-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 16px;
  cursor: pointer;
}

.controls {
  padding-top: 12px;
}

button {
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  border: none;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
}

.primary {
  background: #111;
  color: #fff;
}

.secondary {
  background: #eee;
  margin-top: 8px;
}

.upload-grid {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  min-height: 0;
}

.upload-card {
  border: 2px dashed #ccc;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  text-align: center;
  cursor: pointer;
  overflow: hidden;
}

.upload-card img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.hidden {
  display: none;
}

.status {
  text-align: center;
  font-size: 14px;
  padding-top: 6px;
}
  .vote-wrap {
  flex: 1;
  min-height: 0;
  position: relative;
}

. {
position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 18px;
  background: transparent;            /* без размытия */
  border-radius: 16px;
  pointer-events: none;               /* не мешает кликам */
}

.overlay-card {
  background: rgba(17,17,17,0.88);
  color: #fff;
  padding: 14px 16px;
  border-radius: 14px;
  font-weight: 700;
  text-align: center;
  max-width: 320px;
  width: 100%;
}

.overlay-sub {
  margin-top: 6px;
  font-size: 13px;
  font-weight: 600;
  opacity: 0.85;
}

</style>
</head>

<body>
<div class="app">

  <div class="tabs">
    <div class="tab active" id="tabVote">Голосование</div>
    <div class="tab" id="tabUpload">Загрузка пары</div>
  </div>

  <div class="content">

    <!-- VOTE -->
<div class="vote-wrap" id="voteWrap">
  <div id="voteScreen" class="vote-grid">
    <img id="leftImg" class="vote-img" />
    <img id="rightImg" class="vote-img" />
  </div>

  <div id="emptyOverlay" class="overlay hidden">
    <div class="overlay-card">
      Пока нет новых пар
      <div class="overlay-sub">Ожидаем новые…</div>
    </div>
  </div>
</div>

    <!-- UPLOAD -->
    <div id="uploadScreen" class="upload-grid hidden">
      <div class="upload-card" id="cardLeft">Нажмите чтобы загрузить<br>Фото 1</div>
      <div class="upload-card" id="cardRight">Нажмите чтобы загрузить<br>Фото 2</div>
    </div>

    <div class="controls">
      <button id="nextBtn" class="primary">Следующая</button>
      <button id="sendBtn" class="primary hidden">Отправить пару</button>
      <button id="clearBtn" class="secondary hidden">Очистить</button>
      <div class="status" id="status"></div>
    </div>

  </div>
</div>

<input type="file" id="fileLeft" accept="image/*" class="hidden">
<input type="file" id="fileRight" accept="image/*" class="hidden">

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const API_BASE = "https://api.lookingreat.ru";

let tg_id = tg.initDataUnsafe?.user?.id || "0";
let currentPair = null;
let leftFile = null;
let rightFile = null;
let emptyPollTimer = null;
let loadingFeed = false;


const voteScreen = document.getElementById("voteScreen");
const uploadScreen = document.getElementById("uploadScreen");
const emptyOverlay = document.getElementById("emptyOverlay");


const tabVote = document.getElementById("tabVote");
const tabUpload = document.getElementById("tabUpload");

const leftImg = document.getElementById("leftImg");
const rightImg = document.getElementById("rightImg");

const nextBtn = document.getElementById("nextBtn");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");

const cardLeft = document.getElementById("cardLeft");
const cardRight = document.getElementById("cardRight");

const fileLeft = document.getElementById("fileLeft");
const fileRight = document.getElementById("fileRight");

const statusEl = document.getElementById("status");

function setStatus(text) {
  statusEl.textContent = text || "";
}

function switchTab(mode) {
  if (emptyPollTimer) { clearInterval(emptyPollTimer); emptyPollTimer = null; }
emptyOverlay.classList.add("hidden");
  if (mode === "vote") {
    tabVote.classList.add("active");
    tabUpload.classList.remove("active");
    voteScreen.classList.remove("hidden");
    uploadScreen.classList.add("hidden");
    nextBtn.classList.remove("hidden");
    sendBtn.classList.add("hidden");
    clearBtn.classList.add("hidden");
    loadNext();
  } else {
    tabUpload.classList.add("active");
    tabVote.classList.remove("active");
    voteScreen.classList.add("hidden");
    uploadScreen.classList.remove("hidden");
    nextBtn.classList.add("hidden");
    sendBtn.classList.remove("hidden");
    clearBtn.classList.remove("hidden");
  }
}

tabVote.onclick = () => switchTab("vote");
tabUpload.onclick = () => switchTab("upload");

async function loadNext() {
  if (loadingFeed) return;
  loadingFeed = true;

  try {
    setStatus("Загрузка...");
    const res = await fetch(`${API_BASE}/feed?tg_id=${tg_id}`);
    const data = await res.json();

    if (data.empty) {
      setStatus("");
      emptyOverlay.classList.remove("hidden");

      // авто-проверка новых пар
      if (!emptyPollTimer) {
        emptyPollTimer = setInterval(() => {
          // обновляем только если мы на вкладке голосования
          if (!voteScreen.classList.contains("hidden")) loadNext();
        }, 3000);
      }
      return;
    }

    // есть пара — отключаем авто-пулл
    if (emptyPollTimer) { clearInterval(emptyPollTimer); emptyPollTimer = null; }
    emptyOverlay.classList.add("hidden");

    currentPair = data.item;
    leftImg.src = currentPair.left_url;
    rightImg.src = currentPair.right_url;
    setStatus("");
  } catch (e) {
    setStatus("Ошибка загрузки");
  } finally {
    loadingFeed = false;
  }
}

async function vote(choice) {
  if (!currentPair) return;

  // мгновенный визуальный отклик
  setStatus("Голос учтён");

  const res = await fetch(`${API_BASE}/vote`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      tg_id,
      pair_id: currentPair.id,
      choice
    })
  });

  // если вдруг ошибка — покажем её, но не ломаем экран
  if (!res.ok) {
    setStatus("Ошибка голосования");
    return;
  }

  // через 0.5 сек подгружаем следующую пару
  setTimeout(() => {
    setStatus("Загрузка...");
    loadNext();
  }, 500);
}

leftImg.onclick = () => vote("left");
rightImg.onclick = () => vote("right");
nextBtn.onclick = loadNext;

cardLeft.onclick = () => fileLeft.click();
cardRight.onclick = () => fileRight.click();

fileLeft.onchange = () => {
  leftFile = fileLeft.files[0];
  previewImage(leftFile, cardLeft);
};

fileRight.onchange = () => {
  rightFile = fileRight.files[0];
  previewImage(rightFile, cardRight);
};

function previewImage(file, card) {
  const reader = new FileReader();
  reader.onload = e => {
    card.innerHTML = `<img src="${e.target.result}">`;
  };
  reader.readAsDataURL(file);
}

sendBtn.onclick = async () => {
  if (!leftFile || !rightFile) {
    setStatus("Загрузите оба фото");
    return;
  }

  setStatus("Отправка...");

  const form = new FormData();
  form.append("tg_id", tg_id);
  form.append("left", leftFile);
  form.append("right", rightFile);

  const res = await fetch(`${API_BASE}/upload_pair`, {
    method: "POST",
    body: form
  });

  if (!res.ok) {
    setStatus("Ошибка загрузки");
    return;
  }

  const data = await res.json();
  if (!data.ok) {
    setStatus("Ошибка: " + (data.error || "upload_failed"));
    return;
  }

  setStatus("Пара успешно загружена");
  clearUpload();
};

clearBtn.onclick = clearUpload;

function clearUpload() {
  leftFile = null;
  rightFile = null;
  fileLeft.value = "";
  fileRight.value = "";
  cardLeft.innerHTML = "Нажмите чтобы загрузить<br>Фото 1";
  cardRight.innerHTML = "Нажмите чтобы загрузить<br>Фото 2";
  setStatus("");
}

loadNext();
</script>
</body>
</html>
