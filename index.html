<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LookingGreat</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --stroke: rgba(0,0,0,.08);
      --stroke2: rgba(0,0,0,.06);
      --text:#0f172a;
      --muted: rgba(15,23,42,.60);

      --r:18px;

      --safeT: env(safe-area-inset-top, 0px);
      --safeB: env(safe-area-inset-bottom, 0px);

      --navH: 64px;

      /* –î–ï–°–ö–¢–û–ü/–û–ë–©–ï–ï: –≤—ã—Å–æ—Ç–∞ –±–ª–æ–∫–∞ —Å —Ñ–æ—Ç–æ */
      --pairH: clamp(360px, 62vh, 620px);

      /* –í–æ–∑–¥—É—Ö —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É —É —Ñ–æ—Ç–æ (–º–µ–Ω—è–µ—à—å —Ç—É—Ç) */
      --pairPad: 12px;
    }

    /* –ú–û–ë–ò–õ–¨–ù–û–ï: —É–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã —Ñ—É—Ç–µ—Ä –ø–æ–¥–Ω—è–ª—Å—è –∫ —Ñ–æ—Ç–æ */
    @media (max-width: 520px){
      :root{
        --pairH: clamp(280px, 46vh, 420px);
      }
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }

    html,body{
      height:100%;
      margin:0;
      overflow:hidden;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background: var(--bg);
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      background: var(--bg);
    }

    .top{
      padding: calc(10px + var(--safeT)) 14px 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex: 0 0 auto;
      background: var(--bg);
    }
    .brand{ line-height:1.1; }
    .brand .t{ font-weight:800; font-size:18px; letter-spacing:.2px; }
    .brand .s{ margin-top:4px; font-size:13px; color:var(--muted); }

    .feed{
      flex:1 1 auto;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 0 12px calc(var(--navH) + var(--safeB) + 16px);
      background: var(--bg);
      scrollbar-width:none;
    }
    .feed::-webkit-scrollbar{ display:none; }

    .card{
      display:flex;
      flex-direction:column;

      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      overflow:hidden;
      box-shadow: 0 12px 34px rgba(15,23,42,.10);

      margin: 0 0 12px 0;
    }

    .cardHead{
      padding: 10px 12px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: var(--card);
      border-bottom: 1px solid var(--stroke2);
      flex: 0 0 auto;
    }
    .pairTitle{ font-weight:850; font-size:22px; }
    .pairSub{ margin-top:2px; font-size:13px; color:var(--muted); }

    .pairWrap{
      height: var(--pairH);
      position:relative;
      display:grid;
      grid-template-columns: 1fr 1fr;
      background:#fff;

      padding: var(--pairPad) 0;
      box-sizing: border-box;
    }

    .pane{
      position:relative;
      overflow:hidden;
      background:#fff;
    }

    .divider{
      position:absolute;
      top:0; bottom:0;
      left:50%;
      width:1px;
      background: rgba(0,0,0,.08);
      transform: translateX(-.5px);
      pointer-events:none;
    }

    .img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: contain;
      object-position: center;
      background:#fff;
      transform: translateZ(0);
    }

    .cardFooter{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 8px 12px 10px;
      background: #fff;
      border-top: 1px solid var(--stroke2);
      flex: 0 0 auto;
    }

    .votes{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:14px;
      color: var(--text);
      font-weight:750;
      letter-spacing:.1px;
    }

    .shareBtn{
      border: 1px solid var(--stroke);
      background: rgba(15,23,42,.04);
      color: var(--text);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight:800;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      transition: transform .10s ease, background .18s ease, border-color .18s ease;
    }
    .shareBtn:active{ transform: scale(.98); }
    .shareIco{ width:16px; height:16px; display:block; opacity:.9; }

    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      height: calc(var(--navH) + var(--safeB));
      padding: 8px 18px calc(8px + var(--safeB));
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      background: rgba(255,255,255,.92);
      border-top: 1px solid var(--stroke);
      z-index:50;
      backdrop-filter: blur(10px);
    }

    .navBtn{
      width:44px; height:44px;
      display:grid;
      place-items:center;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(15,23,42,.04);
      color: var(--text);
      user-select:none;
      cursor:pointer;
      transition: transform .10s ease, background .18s ease;
    }
    .navBtn:active{ transform: scale(.98); }
    .navBtn svg{ width:22px; height:22px; opacity:.95; }

    .plus{
      width:54px; height:54px;
      border-radius:18px;
      background: #0f172a;
      color:#fff;
      border: 1px solid rgba(15,23,42,.15);
      box-shadow: 0 10px 26px rgba(15,23,42,.22);
    }
    .plus svg{ width:26px; height:26px; opacity:1; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(var(--navH) + var(--safeB) + 18px);
      transform: translateX(-50%);
      background: rgba(15,23,42,.92);
      border: 1px solid rgba(255,255,255,.18);
      color: #fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 18px 40px rgba(0,0,0,.20);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 60;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }

    .skeleton{
      height: 100%;
      background: linear-gradient(110deg, rgba(15,23,42,.05) 20%, rgba(15,23,42,.10) 35%, rgba(15,23,42,.05) 50%);
      background-size: 200% 100%;
      animation: shimmer 1.1s linear infinite;
    }
    @keyframes shimmer{
      0%{ background-position: 200% 0; }
      100%{ background-position: -200% 0; }
    }

    /* ===== MODAL UPLOAD (–Ω–æ–≤–æ–µ) ===== */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 12px 12px calc(12px + var(--safeB));
      z-index: 80;
    }
    .modal{
      width: min(720px, 100%);
      background: #fff;
      border: 1px solid var(--stroke);
      border-radius: 18px;
      box-shadow: 0 25px 60px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modalHead{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid var(--stroke2);
    }
    .modalTitle{
      font-weight: 850;
      font-size: 16px;
    }
    .modalBody{
      padding: 12px;
      display:grid;
      gap: 10px;
    }
    .uploadGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .pick{
      border: 1px dashed rgba(0,0,0,.22);
      border-radius: 14px;
      padding: 12px;
      background: rgba(15,23,42,.03);
      cursor: pointer;
      user-select:none;
      min-height: 110px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .pickTitle{ font-weight: 850; font-size: 14px; }
    .pickHint{ font-size: 12px; color: var(--muted); }
    .fileName{ font-size: 12px; font-weight: 800; word-break: break-word; }
    .modalActions{
      display:flex;
      gap: 10px;
      margin-top: 4px;
    }
    .wideBtn{ flex:1; justify-content:center; }
    input[type="file"]{ display:none; }

    /* ===== PROFILE (–Ω–æ–≤–æ–µ) ===== */
    .block{
      padding: 12px;
    }
    .statGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .stat{
      border: 1px solid var(--stroke2);
      border-radius: 14px;
      padding: 10px;
      background: rgba(15,23,42,.02);
    }
    .statK{ font-size: 12px; color: var(--muted); }
    .statV{ margin-top: 2px; font-weight: 900; font-size: 18px; }
    .miniPair{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      height: 150px;
      border: 1px solid var(--stroke2);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    .miniImg{
      width:100%; height:100%;
      object-fit: cover;
      background:#fff;
      display:block;
    }
    .miniMeta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 2px 0;
      color: var(--muted);
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="top">
      <div class="brand">
        <div class="t">LookingGreat</div>
        <div class="s">–°—Ä–∞–≤–Ω–∏ –∏ –≤—ã–±–µ—Ä–∏ –ª—É—á—à–µ–µ —Ñ–æ—Ç–æ ¬∑ <span id="ver"></span></div>
      </div>
      <div style="opacity:.0; width:1px; height:1px;"></div>
    </div>

    <div id="feed" class="feed"></div>

    <div class="nav">
      <div class="navBtn" id="navHome" title="–î–æ–º">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M4 10.5L12 4l8 6.5V20a1.6 1.6 0 0 1-1.6 1.6H5.6A1.6 1.6 0 0 1 4 20v-9.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <path d="M9.5 21v-7h5v7" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </svg>
      </div>

      <div class="navBtn plus" id="navPlus" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.4" stroke-linecap="round"/>
        </svg>
      </div>

      <div class="navBtn" id="navProfile" title="–ü—Ä–æ—Ñ–∏–ª—å">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 12.2a4.2 4.2 0 1 0-4.2-4.2A4.2 4.2 0 0 0 12 12.2Z" stroke="currentColor" stroke-width="2"/>
          <path d="M20 20.2c-1.8-3.4-5-5.2-8-5.2s-6.2 1.8-8 5.2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <!-- Upload Modal -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Ä—É</div>
        <button class="shareBtn" id="closeModal" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modalBody">
        <div class="uploadGrid">
          <label class="pick" for="fileLeft">
            <div class="pickTitle">–§–æ—Ç–æ 1</div>
            <div class="pickHint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å</div>
            <div class="fileName" id="leftName">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
          </label>
          <label class="pick" for="fileRight">
            <div class="pickTitle">–§–æ—Ç–æ 2</div>
            <div class="pickHint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å</div>
            <div class="fileName" id="rightName">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
          </label>
        </div>

        <input id="fileLeft" type="file" accept="image/*" />
        <input id="fileRight" type="file" accept="image/*" />

        <div class="modalActions">
          <button class="shareBtn wideBtn" id="doUpload" type="button">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>

        <div class="pairSub" id="uploadStatus" style="display:none; margin:0;"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== VERSION (–º–µ–Ω—è—é –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏) =====
    const APP_VERSION = "v2.2";

    // ===== CONFIG =====
    const API_BASE = "https://api.lookingreat.ru";

    // ===== TELEGRAM INIT =====
    const tg = window.Telegram?.WebApp;
    try { tg?.ready(); tg?.expand(); tg?.disableVerticalSwipes?.(); } catch(e) {}

    function getTgId() {
      const id = tg?.initDataUnsafe?.user?.id;
      if (id) return String(id);
      return localStorage.getItem("DEV_TG_ID") || "531932411"; // DEV fallback
    }

    let tg_id = "";
    function refreshTgId(){ tg_id = getTgId(); return tg_id; }
    refreshTgId();

    if (!tg?.initDataUnsafe?.user?.id) {
      console.log("DEV MODE (not in Telegram). tg_id =", tg_id);
      window.setDevTgId = (v) => { localStorage.setItem("DEV_TG_ID", String(v)); location.reload(); };
    }

    const feedEl = document.getElementById("feed");
    const toastEl = document.getElementById("toast");

    // –í–µ—Ä—Å–∏—è –≤ —à–∞–ø–∫–µ + –≤ –∫–æ–Ω—Å–æ–ª–∏
    document.getElementById("ver").textContent = APP_VERSION;
    console.log("LookingGreat version:", APP_VERSION);

    let toastTimer = null;
    function toast(msg){
      if (!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toastEl.classList.remove("show"), 1600);
    }
    function haptic(type="light"){
      try { tg?.HapticFeedback?.impactOccurred?.(type); } catch(e) {}
    }

    async function apiGet(path){
      const res = await fetch(API_BASE + path, { method:"GET" });
      return res.json();
    }
    async function apiPost(path, body){
      const res = await fetch(API_BASE + path, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      return res.json();
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function sharePair(pairId){
      const shareText = `–°—Ä–∞–≤–Ω–∏ –ø–∞—Ä—É #${pairId} –≤ LookingGreat`;
      const link = `https://t.me/share/url?url=${encodeURIComponent("https://lookingreat.ru")}&text=${encodeURIComponent(shareText)}`;
      try { tg?.openTelegramLink?.(link); } catch(e) { window.open(link, "_blank"); }
    }

    function cardTemplate(item){
      const pairNum = item?.id ?? "‚Äî";
      const totalVotes = Number(item?.total_votes ?? item?.votes_total ?? item?.votes ?? 0);
      const votesText = `üëç ${isFinite(totalVotes) ? totalVotes : 0} –≥–æ–ª–æ—Å–æ–≤`;

      const leftUrl =
        item?.photo_left_url ||
        (item?.photo_left_key ? `${API_BASE}/r2/${encodeURIComponent(item.photo_left_key)}` : "");

      const rightUrl =
        item?.photo_right_url ||
        (item?.photo_right_key ? `${API_BASE}/r2/${encodeURIComponent(item.photo_right_key)}` : "");

      return `
        <div class="card" data-pair-id="${pairNum}">
          <div class="cardHead">
            <div>
              <div class="pairTitle">–ü–∞—Ä–∞ #${pairNum}</div>
              <div class="pairSub">–°—Ä–∞–≤–Ω–∏ –∏ –≤—ã–±–µ—Ä–∏ –ª—É—á—à–µ–µ —Ñ–æ—Ç–æ</div>
            </div>
            <div style="width:28px;height:28px;border-radius:10px;border:1px solid rgba(0,0,0,.08);background:rgba(15,23,42,.04);"></div>
          </div>

          <div class="pairWrap">
            <div class="divider"></div>

            <div class="pane" data-choice="left">
              ${leftUrl ? `<img class="img" src="${escapeHtml(leftUrl)}" alt="left" />` : `<div class="skeleton"></div>`}
            </div>

            <div class="pane" data-choice="right">
              ${rightUrl ? `<img class="img" src="${escapeHtml(rightUrl)}" alt="right" />` : `<div class="skeleton"></div>`}
            </div>
          </div>

          <div class="cardFooter">
            <div class="votes">${votesText}</div>
            <button class="shareBtn" type="button" aria-label="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
              <svg class="shareIco" viewBox="0 0 24 24" fill="none">
                <path d="M16 8.5l-8 4m8 3.5l-8-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M18.5 9.8a2.3 2.3 0 1 0 0-4.6 2.3 2.3 0 0 0 0 4.6Z" stroke="currentColor" stroke-width="2"/>
                <path d="M18.5 21a2.3 2.3 0 1 0 0-4.6 2.3 2.3 0 0 0 0 4.6Z" stroke="currentColor" stroke-width="2"/>
                <path d="M5.5 15.4a2.3 2.3 0 1 0 0-4.6 2.3 2.3 0 0 0 0 4.6Z" stroke="currentColor" stroke-width="2"/>
              </svg>
              –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
            </button>
          </div>
        </div>
      `;
    }

    function profileTemplate(state){
      const tgText = escapeHtml(tg_id);
      const stats = state?.stats || null;
      const pairs = Array.isArray(state?.pairs) ? state.pairs : [];

      const totalPairs = stats?.total_pairs ?? pairs.length ?? 0;
      const totalVotes = stats?.total_votes ?? pairs.reduce((a,p)=>a + Number(p.total_votes||p.votes_total||0), 0);
      const avgVotes = totalPairs ? Math.round(totalVotes / totalPairs) : 0;

      const pairsHtml = pairs.length ? pairs.map(p=>{
        const id = p.id ?? "‚Äî";
        const votes = Number(p.total_votes ?? p.votes_total ?? 0) || 0;

        const leftUrl =
          p.photo_left_url ||
          (p.photo_left_key ? `${API_BASE}/r2/${encodeURIComponent(p.photo_left_key)}` : "");

        const rightUrl =
          p.photo_right_url ||
          (p.photo_right_key ? `${API_BASE}/r2/${encodeURIComponent(p.photo_right_key)}` : "");

        return `
          <div class="card">
            <div class="cardHead">
              <div>
                <div class="pairTitle">–ú–æ—è –ø–∞—Ä–∞ #${id}</div>
                <div class="pairSub">üëç ${votes} –≥–æ–ª–æ—Å–æ–≤</div>
              </div>
              <div style="width:28px;height:28px;border-radius:10px;border:1px solid rgba(0,0,0,.08);background:rgba(15,23,42,.04);"></div>
            </div>
            <div class="block">
              <div class="miniPair">
                ${leftUrl ? `<img class="miniImg" src="${escapeHtml(leftUrl)}" alt="">` : `<div class="skeleton"></div>`}
                ${rightUrl ? `<img class="miniImg" src="${escapeHtml(rightUrl)}" alt="">` : `<div class="skeleton"></div>`}
              </div>
              <div class="miniMeta">
                <span>ID: ${escapeHtml(id)}</span>
                <button class="shareBtn" type="button" data-share="${escapeHtml(id)}">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
              </div>
            </div>
          </div>
        `;
      }).join("") : `
        <div class="card">
          <div class="cardHead">
            <div>
              <div class="pairTitle">–ú–æ–∏ –ø–∞—Ä—ã</div>
              <div class="pairSub">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
            </div>
          </div>
          <div class="block">
            <div class="pairSub">–ù–∞–∂–º–∏ ‚Äú+‚Äù, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä–≤—É—é –ø–∞—Ä—É.</div>
          </div>
        </div>
      `;

      return `
        <div class="card">
          <div class="cardHead">
            <div>
              <div class="pairTitle">–ü—Ä–æ—Ñ–∏–ª—å</div>
              <div class="pairSub">–í–∞—à Telegram ID: ${tgText}</div>
            </div>
            <div style="width:28px;height:28px;border-radius:10px;border:1px solid rgba(0,0,0,.08);background:rgba(15,23,42,.04);"></div>
          </div>
          <div class="block">
            <div class="statGrid">
              <div class="stat">
                <div class="statK">–ü–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–æ</div>
                <div class="statV">${escapeHtml(totalPairs)}</div>
              </div>
              <div class="stat">
                <div class="statK">–í—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤</div>
                <div class="statV">${escapeHtml(totalVotes)}</div>
              </div>
              <div class="stat">
                <div class="statK">–°—Ä–µ–¥–Ω–µ–µ –Ω–∞ –ø–∞—Ä—É</div>
                <div class="statV">${escapeHtml(avgVotes)}</div>
              </div>
              <div class="stat">
                <div class="statK">–í–µ—Ä—Å–∏—è</div>
                <div class="statV">${escapeHtml(APP_VERSION)}</div>
              </div>
            </div>
          </div>
        </div>

        ${pairsHtml}
      `;
    }

    let loading = false;
    let currentView = "feed";

    async function loadFeed(){
      currentView = "feed";
      if (loading) return;
      loading = true;

      feedEl.innerHTML = `
        <div class="card">
          <div class="cardHead">
            <div>
              <div class="pairTitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
              <div class="pairSub">–°—Ä–∞–≤–Ω–∏ –∏ –≤—ã–±–µ—Ä–∏ –ª—É—á—à–µ–µ —Ñ–æ—Ç–æ</div>
            </div>
            <div style="width:28px;height:28px;border-radius:10px;border:1px solid rgba(0,0,0,.08);background:rgba(15,23,42,.04);"></div>
          </div>
          <div class="pairWrap">
            <div class="divider"></div>
            <div class="pane"><div class="skeleton"></div></div>
            <div class="pane"><div class="skeleton"></div></div>
          </div>
          <div class="cardFooter">
            <div class="votes">üëç 0 –≥–æ–ª–æ—Å–æ–≤</div>
            <button class="shareBtn" type="button">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
          </div>
        </div>
      `;

      try{
        refreshTgId();
        const data = await apiGet(`/feed?tg_id=${encodeURIComponent(tg_id)}`);

        let items = [];
        if (data?.ok && Array.isArray(data?.items)) items = data.items;
        else if (data?.ok && data?.item) items = [data.item];
        else if (Array.isArray(data)) items = data;
        else if (data?.item) items = [data.item];

        if (!items.length){
          feedEl.innerHTML = `
            <div class="card">
              <div class="cardHead">
                <div>
                  <div class="pairTitle">–ü–æ–∫–∞ –Ω–µ—Ç –ø–∞—Ä</div>
                  <div class="pairSub">–ù–∞–∂–º–∏ ‚Äú+‚Äù —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
                </div>
              </div>
              <div class="pairWrap">
                <div class="divider"></div>
                <div class="pane"></div>
                <div class="pane"></div>
              </div>
              <div class="cardFooter">
                <div class="votes">üëç 0 –≥–æ–ª–æ—Å–æ–≤</div>
                <button class="shareBtn" type="button">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
              </div>
            </div>
          `;
          loading = false;
          bindEvents();
          return;
        }

        feedEl.innerHTML = items.map(cardTemplate).join("");
        loading = false;
        bindEvents();
      } catch(e){
        loading = false;
        feedEl.innerHTML = `
          <div class="card">
            <div class="cardHead">
              <div>
                <div class="pairTitle">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                <div class="pairSub">–ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏</div>
              </div>
            </div>
            <div class="pairWrap">
              <div class="divider"></div>
              <div class="pane"></div>
              <div class="pane"></div>
            </div>
            <div class="cardFooter">
              <div class="votes">üëç 0 –≥–æ–ª–æ—Å–æ–≤</div>
              <button class="shareBtn" type="button" id="retryBtn">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
            </div>
          </div>
        `;
        document.getElementById("retryBtn")?.addEventListener("click", loadFeed);
      }
    }

    async function loadProfile(){
      currentView = "profile";
      feedEl.scrollTo({ top: 0 });

      feedEl.innerHTML = `
        <div class="card">
          <div class="cardHead">
            <div>
              <div class="pairTitle">–ü—Ä–æ—Ñ–∏–ª—å</div>
              <div class="pairSub">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
            </div>
          </div>
          <div class="block">
            <div class="skeleton" style="height:180px;border-radius:14px;"></div>
          </div>
        </div>
      `;

      try{
        refreshTgId();
        const data = await apiGet(`/my_pairs?tg_id=${encodeURIComponent(tg_id)}`);

        // –æ–∂–∏–¥–∞–µ–º –æ–¥–∏–Ω –∏–∑ —Ñ–æ—Ä–º–∞—Ç–æ–≤:
        // { ok:true, pairs:[...], stats:{...} }
        // –∏–ª–∏ { ok:true, items:[...] }
        const state = {
          pairs: data?.pairs || data?.items || [],
          stats: data?.stats || null
        };

        feedEl.innerHTML = profileTemplate(state);
        bindProfileEvents();
      } catch(e){
        // –µ—Å–ª–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –µ—â—ë –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–µ –ª–æ–º–∞—è UI
        feedEl.innerHTML = `
          <div class="card">
            <div class="cardHead">
              <div>
                <div class="pairTitle">–ü—Ä–æ—Ñ–∏–ª—å</div>
                <div class="pairSub">–ú–æ–∏ –ø–∞—Ä—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</div>
              </div>
            </div>
            <div class="block">
              <div class="pairSub">–ù—É–∂–µ–Ω API: <b>/my_pairs?tg_id=...</b> —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å ‚Äú–ú–æ–∏ –ø–∞—Ä—ã‚Äù –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.</div>
            </div>
          </div>
        `;
      }
    }

    async function vote(pairId, choice){
      haptic("light");
      try{
        const body = { tg_id, pair_id: Number(pairId), choice };
        const res = await apiPost(`/vote`, body);

        if (!res?.ok){
          if (res?.error === "cannot_vote_own_pair"){
            toast("–ù–µ–ª—å–∑—è –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –∑–∞ —Å–≤–æ—é –ø–∞—Ä—É");
            haptic("error");
            return false;
          }
          toast("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å");
          haptic("error");
          return false;
        }

        toast("–ì–æ–ª–æ—Å —É—á—Ç—ë–Ω");
        haptic("success");
        await loadFeed();
        return true;

      } catch(e){
        toast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
        haptic("error");
        return false;
      }
    }

    function bindEvents(){
      document.querySelectorAll(".card .pane").forEach(pane=>{
        pane.addEventListener("click", async ()=>{
          const card = pane.closest(".card");
          const pairId = card?.getAttribute("data-pair-id");
          const choice = pane.getAttribute("data-choice");
          if (!pairId || !choice) return;
          await vote(pairId, choice);
        });
      });

      document.querySelectorAll(".card .shareBtn").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const card = btn.closest(".card");
          const pairId = card?.getAttribute("data-pair-id") || "";
          sharePair(pairId);
        });
      });

      document.getElementById("navHome")?.addEventListener("click", ()=> {
        if (currentView !== "feed") loadFeed();
        else feedEl.scrollTo({ top: 0, behavior: "smooth" });
      });

      document.getElementById("navPlus")?.addEventListener("click", ()=> {
        openUploadModal();
      });

      document.getElementById("navProfile")?.addEventListener("click", ()=> {
        loadProfile();
      });
    }

    function bindProfileEvents(){
      document.querySelectorAll("[data-share]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const id = btn.getAttribute("data-share");
          sharePair(id);
        });
      });
    }

    // ===== Upload modal logic =====
    const modalOverlay = document.getElementById("modalOverlay");
    const closeModalBtn = document.getElementById("closeModal");
    const doUploadBtn = document.getElementById("doUpload");
    const fileLeft = document.getElementById("fileLeft");
    const fileRight = document.getElementById("fileRight");
    const leftName = document.getElementById("leftName");
    const rightName = document.getElementById("rightName");
    const uploadStatus = document.getElementById("uploadStatus");

    function openUploadModal(){
      uploadStatus.style.display = "none";
      uploadStatus.textContent = "";
      modalOverlay.style.display = "flex";
    }
    function closeUploadModal(){
      modalOverlay.style.display = "none";
    }

    closeModalBtn.addEventListener("click", closeUploadModal);
    modalOverlay.addEventListener("click", (e)=>{ if (e.target === modalOverlay) closeUploadModal(); });

    fileLeft.addEventListener("change", ()=>{
      leftName.textContent = fileLeft.files?.[0]?.name ? fileLeft.files[0].name : "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
    });
    fileRight.addEventListener("change", ()=>{
      rightName.textContent = fileRight.files?.[0]?.name ? fileRight.files[0].name : "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
    });

    doUploadBtn.addEventListener("click", async ()=>{
      const f1 = fileLeft.files?.[0];
      const f2 = fileRight.files?.[0];
      if (!f1 || !f2){
        uploadStatus.style.display = "block";
        uploadStatus.textContent = "–í—ã–±–µ—Ä–∏ –æ–±–∞ —Ñ–æ—Ç–æ.";
        return;
      }

      uploadStatus.style.display = "block";
      uploadStatus.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
      haptic("light");

      try{
        refreshTgId();
        const fd = new FormData();
        fd.append("tg_id", String(tg_id));
        fd.append("left", f1);
        fd.append("right", f2);

        const res = await fetch(API_BASE + "/upload_pair", {
          method: "POST",
          body: fd
        });

        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data?.ok) throw new Error(data?.error || ("HTTP " + res.status));

        uploadStatus.textContent = "–ì–æ—Ç–æ–≤–æ! –ü–∞—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.";
        haptic("success");

        fileLeft.value = "";
        fileRight.value = "";
        leftName.textContent = "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
        rightName.textContent = "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";

        setTimeout(()=>{
          closeUploadModal();
          loadFeed();
        }, 300);

      } catch(e){
        uploadStatus.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.";
        haptic("error");
      }
    });

    // —Å—Ç–∞—Ä—Ç
    loadFeed();
  </script>
</body>
</html>
