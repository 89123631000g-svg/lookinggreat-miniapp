<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LookingGreat</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* { box-sizing: border-box; }

html, body {
  margin: 0;
  padding: 0;
  height: 100dvh;
  overflow: hidden;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: #ffffff;
  color: #111;
}

.app { height: 100%; display: flex; flex-direction: column; }

.tabs {
  display: flex;
  gap: 8px;
  padding: 12px;
}

.tab {
  flex: 1;
  padding: 10px;
  border-radius: 12px;
  border: 1px solid #eee;
  background: #f5f5f5;
  text-align: center;
  font-weight: 700;
  cursor: pointer;
  user-select: none;
}

.tab.active { background: #111; color: #fff; border-color:#111; }

.content {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 12px;
  min-height: 0;
}

.hidden { display: none !important; }

.vote-wrap { flex: 1; min-height: 0; position: relative; }
.vote-grid {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  min-height: 0;
}

.vote-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 16px;
  cursor: pointer;

  opacity: 1;
  transition: opacity 180ms ease;
  will-change: opacity;
}

.vote-img.fading { opacity: 0; }

.vote-grid.loading .vote-img {
  filter: blur(2px);
  opacity: 0.6;
  transition: opacity 120ms ease, filter 120ms ease;
}

.overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 18px;
  background: transparent;
  border-radius: 16px;
  pointer-events: none;
}

.overlay-card {
  background: rgba(17,17,17,0.88);
  color: #fff;
  padding: 14px 16px;
  border-radius: 14px;
  font-weight: 800;
  text-align: center;
  max-width: 340px;
  width: 100%;
}

.overlay-sub {
  margin-top: 6px;
  font-size: 13px;
  font-weight: 600;
  opacity: 0.85;
}

.toast {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  z-index: 50;
  padding: 14px 16px;
  border-radius: 14px;
  background: linear-gradient(135deg, #111, #2a2a2a);
  color: #fff;
  font-weight: 900;
  font-size: 18px;
  letter-spacing: 0.2px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  pointer-events: none;
  max-width: 340px;
  width: calc(100% - 36px);
  animation: pop 0.25s ease;
  opacity: 1;
  transition: opacity 0.2s ease;
}

.toast.fadeout { opacity: 0; }

@keyframes pop {
  from { transform: translate(-50%, -50%) scale(0.92); opacity: 0; }
  to   { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}

.controls { padding-top: 12px; }
button {
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  border: none;
  font-size: 16px;
  font-weight: 800;
  cursor: pointer;
}
.primary { background: #111; color: #fff; }
.secondary { background: #eee; margin-top: 8px; }

.status { text-align: center; font-size: 14px; padding-top: 6px; color:#333; }

/* Upload */
.upload-grid {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  min-height: 0;
}

.upload-card {
  border: 2px dashed #ccc;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  text-align: center;
  cursor: pointer;
  overflow: hidden;
  padding: 12px;
  line-height: 1.15;
  color:#111;
  background:#fafafa;
}

.upload-card img { width: 100%; height: 100%; object-fit: cover; }

/* My pairs */
.my-wrap { flex: 1; min-height: 0; display:flex; flex-direction:column; gap:10px; }
.my-summary {
  border: 1px solid #eee;
  border-radius: 14px;
  padding: 12px;
  background: #fafafa;
}

.my-summary .title { font-weight: 900; margin-bottom: 6px; }
.my-summary .row { display:flex; justify-content:space-between; font-weight:700; font-size:14px; padding:4px 0; }

.my-list {
  flex: 1;
  min-height: 0;
  overflow: auto;
  padding-bottom: 6px;
}

.pair-card {
  border: 1px solid #eee;
  border-radius: 16px;
  padding: 10px;
  margin-bottom: 10px;
  background: #fff;
}

.pair-top { display:flex; justify-content:space-between; align-items:center; gap:10px; }
.pair-top .meta { font-size: 13px; font-weight: 800; color:#111; }
.pair-top .sub { font-size: 12px; color:#666; font-weight:700; margin-top:2px; }

.del-btn {
  border: none;
  background: #eee;
  border-radius: 12px;
  padding: 10px 12px;
  font-weight: 900;
  cursor: pointer;
}

.pair-grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
.pair-imgwrap { position:relative; border-radius:14px; overflow:hidden; }
.pair-imgwrap img { width:100%; height:160px; object-fit:cover; display:block; }

.badge {
  position:absolute;
  left:10px; top:10px;
  background: rgba(17,17,17,0.86);
  color:#fff;
  border-radius: 999px;
  padding: 6px 10px;
  font-weight: 900;
  font-size: 12px;
}

.badge.win { background: rgba(0,0,0,0.88); }
.badge.draw { background: rgba(17,17,17,0.72); }

.bar {
  margin-top: 10px;
  height: 10px;
  border-radius: 999px;
  background: #eee;
  overflow:hidden;
  display:flex;
}

.bar .left { height:100%; background:#111; width:50%; }
.bar .right { height:100%; background:#bbb; width:50%; }

.pair-stats {
  display:flex;
  justify-content:space-between;
  font-weight: 900;
  font-size: 13px;
  margin-top: 8px;
}

.pair-stats span { color:#111; }
.pair-stats small { color:#666; font-weight:800; }

</style>
</head>

<body>
<div class="app">
  <div class="tabs">
    <div class="tab active" id="tabVote">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</div>
    <div class="tab" id="tabUpload">–ó–∞–≥—Ä—É–∑–∫–∞</div>
    <div class="tab" id="tabMy">–ú–æ–∏ –ø–∞—Ä—ã</div>
  </div>

  <div class="content">

    <!-- VOTE -->
    <div class="vote-wrap" id="voteWrap">
      <div id="voteScreen" class="vote-grid">
        <img id="leftImg" class="vote-img" />
        <img id="rightImg" class="vote-img" />
      </div>

      <div id="emptyOverlay" class="overlay hidden">
        <div class="overlay-card">
          –ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤—ã—Ö –ø–∞—Ä
          <div class="overlay-sub">–ï—Å–ª–∏ –≤—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏ –ø–∞—Ä—É ‚Äî –µ—ë —É–≤–∏–¥—è—Ç –¥—Ä—É–≥–∏–µ</div>
        </div>
      </div>

      <div id="toast" class="toast hidden">–ì–æ–ª–æ—Å —É—á—Ç—ë–Ω</div>
    </div>

    <!-- UPLOAD -->
    <div id="uploadScreen" class="upload-grid hidden">
      <div class="upload-card" id="cardLeft">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 1</div>
      <div class="upload-card" id="cardRight">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 2</div>
    </div>

    <!-- MY -->
    <div id="myScreen" class="my-wrap hidden">
      <div class="my-summary" id="mySummary">
        <div class="title">–í–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
        <div class="row"><span>–ü–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–æ</span><span id="sumPairs">‚Äî</span></div>
        <div class="row"><span>–í—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤</span><span id="sumVotes">‚Äî</span></div>
        <div class="row"><span>–°—Ä–µ–¥–Ω–∏–π –ª—É—á—à–∏–π %</span><span id="sumAvg">‚Äî</span></div>
        <div class="row"><span>–õ—É—á—à–∞—è –ø–∞—Ä–∞</span><span id="sumBest">‚Äî</span></div>
      </div>

      <div class="my-list" id="myList"></div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
      <button id="skipBtn" class="primary">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
      <button id="sendBtn" class="primary hidden">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ä—É</button>
      <button id="clearBtn" class="secondary hidden">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <div class="status" id="status"></div>
    </div>

  </div>
</div>

<input type="file" id="fileLeft" accept="image/*" class="hidden">
<input type="file" id="fileRight" accept="image/*" class="hidden">

<script>
const tg = window.Telegram.WebApp;
try { tg.ready(); } catch(e) {}
try { tg.expand(); } catch(e) {}
try { tg.disableVerticalSwipes?.(); } catch(e) {}

const API_BASE = "https://api.lookingreat.ru";
let tg_id = tg.initDataUnsafe?.user?.id || "0";

let currentPair = null;
let loadingFeed = false;
let votingLock = false;
let toastTimer = null;
let emptyPollTimer = null;

let leftFile = null;
let rightFile = null;

let myPollTimer = null;

const tabVote = document.getElementById("tabVote");
const tabUpload = document.getElementById("tabUpload");
const tabMy = document.getElementById("tabMy");

const voteWrap = document.getElementById("voteWrap");
const voteScreen = document.getElementById("voteScreen");
const uploadScreen = document.getElementById("uploadScreen");
const myScreen = document.getElementById("myScreen");

const emptyOverlay = document.getElementById("emptyOverlay");
const toast = document.getElementById("toast");

const leftImg = document.getElementById("leftImg");
const rightImg = document.getElementById("rightImg");

const skipBtn = document.getElementById("skipBtn");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");

const fileLeft = document.getElementById("fileLeft");
const fileRight = document.getElementById("fileRight");

const cardLeft = document.getElementById("cardLeft");
const cardRight = document.getElementById("cardRight");

const statusEl = document.getElementById("status");
function setStatus(t){ statusEl.textContent = t || ""; }

function showToast(text, ms = 1200) {
  if (toastTimer) clearTimeout(toastTimer);
  toast.textContent = "‚úÖ " + text;
  toast.classList.remove("hidden");
  toast.classList.remove("fadeout");
  toastTimer = setTimeout(() => {
    toast.classList.add("fadeout");
    setTimeout(() => {
      toast.classList.add("hidden");
      toastTimer = null;
    }, 200);
  }, ms);
}

function stopAllTimers() {
  if (emptyPollTimer) { clearInterval(emptyPollTimer); emptyPollTimer = null; }
  if (myPollTimer) { clearInterval(myPollTimer); myPollTimer = null; }
}

function switchTab(mode) {
  stopAllTimers();
  emptyOverlay.classList.add("hidden");
  setStatus("");

  tabVote.classList.remove("active");
  tabUpload.classList.remove("active");
  tabMy.classList.remove("active");

  voteWrap.classList.add("hidden");
  uploadScreen.classList.add("hidden");
  myScreen.classList.add("hidden");

  skipBtn.classList.add("hidden");
  sendBtn.classList.add("hidden");
  clearBtn.classList.add("hidden");

  if (mode === "vote") {
    tabVote.classList.add("active");
    voteWrap.classList.remove("hidden");
    skipBtn.classList.remove("hidden");
    loadNext();
  } else if (mode === "upload") {
    tabUpload.classList.add("active");
    uploadScreen.classList.remove("hidden");
    sendBtn.classList.remove("hidden");
    clearBtn.classList.remove("hidden");
  } else {
    tabMy.classList.add("active");
    myScreen.classList.remove("hidden");
    loadMyPairs(true);
    myPollTimer = setInterval(() => loadMyPairs(false), 5000);
  }
}

tabVote.onclick = () => switchTab("vote");
tabUpload.onclick = () => switchTab("upload");
tabMy.onclick = () => switchTab("my");

/* ===== Vote flow ===== */

function preloadImage(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(true);
    img.onerror = reject;
    img.src = url;
  });
}

async function fadeSwapPair(item) {
  if (!item?.left_url || !item?.right_url) return false;

  function cleanup() {
    leftImg.classList.remove("fading");
    rightImg.classList.remove("fading");
    voteScreen.classList.remove("loading");
  }

  voteScreen.classList.add("loading");
  try {
    await Promise.all([ preloadImage(item.left_url), preloadImage(item.right_url) ]);
  } catch (e) {
    cleanup();
    setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—é‚Ä¶");
    setTimeout(loadNext, 180);
    return false;
  }

  leftImg.classList.add("fading");
  rightImg.classList.add("fading");
  await new Promise(r => setTimeout(r, 180));

  leftImg.src = item.left_url;
  rightImg.src = item.right_url;

  try {
    if (leftImg.decode) await leftImg.decode();
    if (rightImg.decode) await rightImg.decode();
  } catch(e) {}

  if (leftImg.naturalWidth === 0 || rightImg.naturalWidth === 0) {
    cleanup();
    setStatus("–§–æ—Ç–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–æ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—é‚Ä¶");
    setTimeout(loadNext, 180);
    return false;
  }

  leftImg.classList.remove("fading");
  rightImg.classList.remove("fading");
  voteScreen.classList.remove("loading");
  return true;
}

async function loadNext() {
  if (loadingFeed) return;
  loadingFeed = true;

  try {
    setStatus("–ó–∞–≥—Ä—É–∑–∫–∞...");
    const res = await fetch(`${API_BASE}/feed?tg_id=${encodeURIComponent(tg_id)}`);
    const data = await res.json();

    if (!data.item) {
      setStatus("");
      emptyOverlay.classList.remove("hidden");
      if (!emptyPollTimer) {
        emptyPollTimer = setInterval(() => {
          if (!voteWrap.classList.contains("hidden")) loadNext();
        }, 3000);
      }
      return;
    }

    if (emptyPollTimer) { clearInterval(emptyPollTimer); emptyPollTimer = null; }
    emptyOverlay.classList.add("hidden");
    currentPair = data.item;

    const ok = await fadeSwapPair(currentPair);
    if (ok === false) return;

    setStatus("");

  } catch(e) {
    setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏.");
  } finally {
    loadingFeed = false;
  }
}

async function vote(choice) {
  if (!currentPair) return;
  if (votingLock) return;
  votingLock = true;

  try {
    showToast("–ì–æ–ª–æ—Å —É—á—Ç—ë–Ω", 1100);
    setStatus("");

    const res = await fetch(`${API_BASE}/vote`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ tg_id, pair_id: currentPair.id, choice })
    });

    let data = null;
    try { data = await res.json(); } catch(e) {}

    if (!res.ok) {
      const err = data?.error || "vote_failed";
      if (err === "cannot_vote_own_pair") setStatus("–ù–µ–ª—å–∑—è –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –∑–∞ —Å–≤–æ—é –ø–∞—Ä—É");
      else if (err === "already_voted") setStatus("–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ —ç—Ç—É –ø–∞—Ä—É");
      else setStatus("–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è");
      return;
    }

    setTimeout(() => { setStatus("–ó–∞–≥—Ä—É–∑–∫–∞..."); loadNext(); }, 250);
  } finally {
    setTimeout(() => { votingLock = false; }, 400);
  }
}

leftImg.onclick = () => vote("left");
rightImg.onclick = () => vote("right");
skipBtn.onclick = () => loadNext();

/* ===== Upload flow ===== */

cardLeft.onclick = () => fileLeft.click();
cardRight.onclick = () => fileRight.click();

fileLeft.onchange = () => {
  leftFile = fileLeft.files[0] || null;
  if (leftFile) previewImage(leftFile, cardLeft);
};
fileRight.onchange = () => {
  rightFile = fileRight.files[0] || null;
  if (rightFile) previewImage(rightFile, cardRight);
};

function previewImage(file, card) {
  const reader = new FileReader();
  reader.onload = e => { card.innerHTML = `<img src="${e.target.result}">`; };
  reader.readAsDataURL(file);
}

function clearUpload() {
  leftFile = null;
  rightFile = null;
  fileLeft.value = "";
  fileRight.value = "";
  cardLeft.innerHTML = "–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 1";
  cardRight.innerHTML = "–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 2";
  setStatus("");
}

clearBtn.onclick = clearUpload;

sendBtn.onclick = async () => {
  if (!leftFile || !rightFile) { setStatus("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ —Ñ–æ—Ç–æ"); return; }

  setStatus("–û—Ç–ø—Ä–∞–≤–∫–∞...");
  const form = new FormData();
  form.append("tg_id", tg_id);
  form.append("left", leftFile);
  form.append("right", rightFile);

  const res = await fetch(`${API_BASE}/upload_pair`, { method:"POST", body: form });
  let data = null;
  try { data = await res.json(); } catch(e) {}

  if (!res.ok || !data?.ok) {
    setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
    return;
  }

  setStatus("–ü–∞—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ ‚úÖ");
  clearUpload();

  // –º—è–≥–∫–æ –æ—Ç–ø—Ä–∞–≤–∏–º –≤ "–ú–æ–∏ –ø–∞—Ä—ã" ‚Äî —Ç–∞–º —á–µ–ª–æ–≤–µ–∫ —É–≤–∏–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  setTimeout(() => switchTab("my"), 500);
};

/* ===== My pairs ===== */

const myList = document.getElementById("myList");
const sumPairs = document.getElementById("sumPairs");
const sumVotes = document.getElementById("sumVotes");
const sumAvg = document.getElementById("sumAvg");
const sumBest = document.getElementById("sumBest");

function fmtTs(ts) {
  // ts –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
  const d = new Date(Number(ts) * 1000);
  return d.toLocaleString("ru-RU", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
}

function renderSummary(profile) {
  sumPairs.textContent = profile?.pairs_total ?? "‚Äî";
  sumVotes.textContent = profile?.votes_total ?? "‚Äî";
  sumAvg.textContent = (profile?.avg_best_pct == null) ? "‚Äî" : (profile.avg_best_pct + "%");
  sumBest.textContent = (profile?.best_pair_id == null) ? "‚Äî" : (`#${profile.best_pair_id} ¬∑ ${profile.best_pair_pct}%`);
}

function badgeText(stats) {
  if (!stats.total) return { text: "–ù–µ—Ç –≥–æ–ª–æ—Å–æ–≤", cls:"draw" };
  if (stats.winner === "draw") return { text: "–ù–∏—á—å—è", cls:"draw" };
  return { text: "–ü–æ–±–µ–¥–∏–ª–æ", cls:"win" };
}

function renderPairs(pairs) {
  if (!pairs?.length) {
    myList.innerHTML = `<div class="pair-card"><div class="pair-top"><div class="meta">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–∞—Ä</div></div></div>`;
    return;
  }

  myList.innerHTML = pairs.map(p => {
    const s = p.stats || {left:0,right:0,total:0,left_pct:0,right_pct:0,winner:null};
    const b = badgeText(s);

    const leftWinner = (s.winner === "left");
    const rightWinner = (s.winner === "right");

    const leftLabel = s.total ? `${s.left_pct}%` : "‚Äî";
    const rightLabel = s.total ? `${s.right_pct}%` : "‚Äî";

    const leftW = Math.max(0, Math.min(100, s.left_pct || 0));
    const rightW = 100 - leftW;

    return `
      <div class="pair-card" data-pair-id="${p.id}">
        <div class="pair-top">
          <div>
            <div class="meta">–ü–∞—Ä–∞ #${p.id}</div>
            <div class="sub">${fmtTs(p.created_at)}</div>
          </div>
          <button class="del-btn" data-del="${p.id}">–£–¥–∞–ª–∏—Ç—å</button>
        </div>

        <div class="pair-grid">
          <div class="pair-imgwrap">
            <img src="${p.left_url}" alt="">
            <div class="badge ${leftWinner ? 'win' : b.cls}">
              ${leftWinner ? 'üëë ' : ''}${leftLabel} ¬∑ ${s.left} –≥–æ–ª–æ—Å–æ–≤
            </div>
          </div>
          <div class="pair-imgwrap">
            <img src="${p.right_url}" alt="">
            <div class="badge ${rightWinner ? 'win' : b.cls}">
              ${rightWinner ? 'üëë ' : ''}${rightLabel} ¬∑ ${s.right} –≥–æ–ª–æ—Å–æ–≤
            </div>
          </div>
        </div>

        <div class="bar" aria-hidden="true">
          <div class="left" style="width:${leftW}%;"></div>
          <div class="right" style="width:${rightW}%;"></div>
        </div>

        <div class="pair-stats">
          <span>–õ–µ–≤–æ–µ <small>${s.left}</small></span>
          <span>–í—Å–µ–≥–æ <small>${s.total}</small></span>
          <span>–ü—Ä–∞–≤–æ–µ <small>${s.right}</small></span>
        </div>
      </div>
    `;
  }).join("");

  // bind delete buttons
  myList.querySelectorAll("[data-del]").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute("data-del");
      if (!id) return;
      const ok = confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–∞—Ä—É? –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –ø–æ –Ω–µ–π –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è.");
      if (!ok) return;

      try {
        setStatus("–£–¥–∞–ª—è—é...");
        const res = await fetch(`${API_BASE}/pair?id=${encodeURIComponent(id)}&tg_id=${encodeURIComponent(tg_id)}`, {
          method: "DELETE"
        });
        const data = await res.json().catch(()=>null);
        if (!res.ok || !data?.ok) {
          setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å");
          return;
        }
        showToast("–£–¥–∞–ª–µ–Ω–æ", 1000);
        setStatus("");
        loadMyPairs(true);
      } catch(e) {
        setStatus("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
      }
    };
  });
}

async function loadMyPairs(showLoading) {
  try {
    if (showLoading) setStatus("–ó–∞–≥—Ä—É–∑–∫–∞...");
    const res = await fetch(`${API_BASE}/my_pairs?tg_id=${encodeURIComponent(tg_id)}`);
    const data = await res.json();

    if (!res.ok || !data?.ok) {
      setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∞—à–∏ –ø–∞—Ä—ã");
      return;
    }

    renderSummary(data.profile);
    renderPairs(data.pairs);
    if (showLoading) setStatus("");
  } catch(e) {
    setStatus("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
  }
}

switchTab("vote");
</script>
</body>
</html>
