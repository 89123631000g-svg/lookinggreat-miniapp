<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LookingGreat</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    * { box-sizing: border-box; }

    :root{
      --bg: #ffffff;
      --text: #111111;
      --muted: #6b7280;
      --card: #ffffff;
      --stroke: rgba(17,17,17,.08);
      --shadow: 0 10px 30px rgba(17,17,17,.08);

      /* –í—ã—Å–æ—Ç–∞ –±–ª–æ–∫–∞ —Ñ–æ—Ç–æ (–∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ) */
      --pairH: clamp(360px, 62vh, 620px);
      --gap: 12px;

      --radius: 18px;

      /* SAFE AREA */
      --sat: env(safe-area-inset-top);
      --sab: env(safe-area-inset-bottom);
      --sal: env(safe-area-inset-left);
      --sar: env(safe-area-inset-right);
    }

    @media (max-width:520px){
      :root{ --pairH: clamp(280px, 46vh, 420px); }
    }

    html, body {
      margin: 0; padding: 0;
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow: hidden; /* –≤–∞–∂–Ω–æ –¥–ª—è Telegram Desktop/Web */
    }

    .app {
      height: 100dvh;
      display: flex;
      flex-direction: column;
      padding:
        calc(10px + var(--sat))
        calc(12px + var(--sar))
        calc(10px + var(--sab))
        calc(12px + var(--sal));
      gap: var(--gap);
    }

    /* –®–∞–ø–∫–∞ */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      padding: 2px 2px 0 2px;
      flex: 0 0 auto;
    }
    .titleWrap{ display:flex; flex-direction:column; gap:2px; }
    .title{
      font-size: 18px;
      font-weight: 800;
      line-height: 1.1;
      letter-spacing: .2px;
    }
    .subtitle{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .ver{
      font-size: 12px;
      color: var(--muted);
      padding: 2px 8px;
      border: 1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(17,17,17,.02);
      white-space: nowrap;
      margin-top: 1px;
      flex: 0 0 auto;
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏, –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    .main{
      flex: 1 1 auto;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 10px;
    }
    .main::-webkit-scrollbar{ width: 0; height: 0; }

    /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .cardHead{
      padding: 12px 14px 10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(17,17,17,.06);
    }
    .pairLabel{
      font-weight: 800;
      font-size: 14px;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    /* –ë–ª–æ–∫ —Ñ–æ—Ç–æ */
    .pairWrap{
      padding: 12px 0;              /* ‚úÖ –¥–æ–±–∞–≤–∏–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –≤–æ–∑–¥—É—Ö —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É */
    }
    .pairGrid{
      height: var(--pairH);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      padding: 0 12px;
    }
    .imgBox{
      position: relative;
      height: 100%;
      border-radius: 14px;
      border: 1px solid rgba(17,17,17,.08);
      background: #fafafa;
      overflow: hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .img{
      width: 100%;
      height: 100%;
      object-fit: contain;          /* –Ω–µ —Ä–µ–∂–µ–º */
      object-position: center;      /* ‚úÖ —Ü–µ–Ω—Ç—Ä, –∞ –Ω–µ center top */
      display:block;
      background: #fff;
    }

    /* –ù–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .cardFoot{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-top: 1px solid rgba(17,17,17,.06);
      background: rgba(17,17,17,.015);
    }
    .votes{
      font-weight: 700;
      font-size: 14px;
    }
    .btn{
      border: 1px solid var(--stroke);
      background: #fff;
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 800;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .btn:active{ transform: translateY(1px); }

    /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å–Ω–∏–∑—É ‚Äú—Å–ª–µ–¥—É—é—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –≤–∏–¥–Ω–∞‚Äù */
    .peekSpacer{
      height: 14px;
    }
    .nextPeek{
      margin-top: 12px;
      opacity: .75;
      border-radius: var(--radius);
      border: 1px dashed rgba(17,17,17,.14);
      background: rgba(17,17,17,.02);
      height: 90px;
    }

    /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é */
    .bottomNav{
      flex: 0 0 auto;
      display:flex;
      gap: 10px;
      padding: 2px 0 0 0;
    }
    .navBtn{
      flex:1;
      border: 1px solid var(--stroke);
      background: #fff;
      border-radius: 14px;
      padding: 12px 10px;
      font-weight: 900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
    }
    .navBtn.primary{
      background: #111;
      color: #fff;
      border-color: rgba(17,17,17,.2);
    }

    /* –≠–∫—Ä–∞–Ω/—Å–æ—Å—Ç–æ—è–Ω–∏—è */
    .state{
      padding: 14px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.35;
    }
    .err{
      color: #b42318;
      font-weight: 700;
    }

    /* –ú–æ–¥–∞–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä—ã */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:
        12px
        calc(12px + var(--sar))
        calc(12px + var(--sab))
        calc(12px + var(--sal));
      z-index: 50;
    }
    .modal{
      width: min(720px, 100%);
      border-radius: 18px;
      background: #fff;
      border: 1px solid var(--stroke);
      box-shadow: 0 25px 60px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 14px 10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(17,17,17,.06);
      gap: 10px;
    }
    .modalTitle{
      font-weight: 900;
      font-size: 16px;
    }
    .modalBody{
      padding: 12px 14px 14px 14px;
      display:grid;
      gap: 10px;
    }
    .uploadGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .pick{
      border: 1px dashed rgba(17,17,17,.25);
      border-radius: 14px;
      padding: 14px;
      background: rgba(17,17,17,.02);
      display:flex;
      flex-direction:column;
      gap: 10px;
      cursor:pointer;
      user-select:none;
      min-height: 120px;
    }
    .pickTitle{
      font-weight: 900;
      font-size: 14px;
    }
    .pickHint{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.25;
    }
    .fileName{
      font-size: 12px;
      font-weight: 800;
      color: #111;
      word-break: break-word;
    }
    .modalActions{
      display:flex;
      gap: 10px;
      margin-top: 6px;
    }
    .btnWide{ flex: 1; justify-content:center; }

    input[type="file"]{ display:none; }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="titleWrap">
        <div class="title">LookingGreat</div>
        <div class="subtitle">
          <span id="who">–õ–µ–Ω—Ç–∞</span>
        </div>
      </div>
      <div class="ver" id="verBadge">v‚Äî</div>
    </div>

    <div class="main" id="main">
      <div class="card" id="card">
        <div class="state" id="state">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>

      <div class="peekSpacer"></div>
      <div class="nextPeek"></div>
    </div>

    <div class="bottomNav">
      <button class="navBtn" id="navHome">–î–æ–º</button>
      <button class="navBtn primary" id="navAdd">+</button>
      <button class="navBtn" id="navProfile">–ü—Ä–æ—Ñ–∏–ª—å</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Ä—É</div>
        <button class="btn" id="btnCloseModal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="modalBody">
        <div class="uploadGrid">
          <label class="pick" id="pickLeft" for="fileLeft">
            <div class="pickTitle">–§–æ—Ç–æ 1</div>
            <div class="pickHint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
            <div class="fileName" id="leftName">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
          </label>
          <label class="pick" id="pickRight" for="fileRight">
            <div class="pickTitle">–§–æ—Ç–æ 2</div>
            <div class="pickHint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
            <div class="fileName" id="rightName">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
          </label>
        </div>

        <input id="fileLeft" type="file" accept="image/*" />
        <input id="fileRight" type="file" accept="image/*" />

        <div class="modalActions">
          <button class="btn btnWide" id="btnUpload">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>

        <div class="state" id="uploadState" style="padding:0; display:none;"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ‚úÖ –í–ê–ñ–ù–û: API_BASE –≤—Å–µ–≥–¥–∞ —è–≤–Ω—ã–π
  const API_BASE = "https://api.lookingreat.ru";

  // ‚úÖ –í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –∞–ø–¥–µ–π—Ç
  const APP_VERSION = "v2.1";

  const $ = (id) => document.getElementById(id);

  const elVer = $("verBadge");
  const elState = $("state");
  const elCard = $("card");
  const elMain = $("main");

  const modalOverlay = $("modalOverlay");
  const btnCloseModal = $("btnCloseModal");
  const btnUpload = $("btnUpload");
  const uploadState = $("uploadState");

  const fileLeft = $("fileLeft");
  const fileRight = $("fileRight");
  const leftName = $("leftName");
  const rightName = $("rightName");

  const navHome = $("navHome");
  const navAdd = $("navAdd");
  const navProfile = $("navProfile");

  elVer.textContent = APP_VERSION;

  // Telegram init
  const tg = window.Telegram?.WebApp;
  try {
    tg?.ready();
    tg?.expand();
    tg?.disableVerticalSwipes?.();
  } catch (e) {}

  const DEV_FALLBACK_TG_ID = "531932411"; // —Ç–≤–æ–π –∞–¥–º–∏–Ω tg_id
  const tg_id = (() => {
    const id = tg?.initDataUnsafe?.user?.id;
    if (id) return String(id);
    return DEV_FALLBACK_TG_ID;
  })();

  // Helpers
  function showState(msg, isErr=false){
    elState.className = "state" + (isErr ? " err" : "");
    elState.textContent = msg;
  }

  function jsonFetch(url, opts){
    return fetch(url, opts).then(async (r) => {
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data?.error || ("HTTP " + r.status));
      return data;
    });
  }

  function safeText(s){ return (s == null ? "" : String(s)); }

  function renderPair(item){
    const pairId = item?.id;
    const votes = item?.votes_total ?? 0;

    const leftUrl = item?.photo_left_url || item?.photo_left || item?.left || "";
    const rightUrl = item?.photo_right_url || item?.photo_right || item?.right || "";

    elCard.innerHTML = `
      <div class="cardHead">
        <div class="pairLabel">–ü–∞—Ä–∞ #${pairId ?? "‚Äî"}</div>
        <div class="hint">–ù–∞–∂–º–∏ –Ω–∞ —Ñ–æ—Ç–æ</div>
      </div>

      <div class="pairWrap">
        <div class="pairGrid">
          <div class="imgBox" id="tapLeft">
            ${leftUrl ? `<img class="img" src="${leftUrl}" alt="–§–æ—Ç–æ 1" loading="eager" />` : `<div class="state">–ù–µ—Ç —Ñ–æ—Ç–æ</div>`}
          </div>
          <div class="imgBox" id="tapRight">
            ${rightUrl ? `<img class="img" src="${rightUrl}" alt="–§–æ—Ç–æ 2" loading="eager" />` : `<div class="state">–ù–µ—Ç —Ñ–æ—Ç–æ</div>`}
          </div>
        </div>
      </div>

      <div class="cardFoot">
        <div class="votes">üëç ${votes} –≥–æ–ª–æ—Å–æ–≤</div>
        <button class="btn" id="btnShare">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
      </div>
    `;

    const tapLeft = document.getElementById("tapLeft");
    const tapRight = document.getElementById("tapRight");
    const btnShare = document.getElementById("btnShare");

    tapLeft?.addEventListener("click", () => vote(pairId, "left"));
    tapRight?.addEventListener("click", () => vote(pairId, "right"));

    btnShare?.addEventListener("click", async () => {
      const shareText = `LookingGreat ‚Äî –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –ø–∞—Ä—É #${pairId}`;
      try {
        if (tg?.shareMessage) {
          tg.shareMessage(shareText);
        } else if (navigator.share) {
          await navigator.share({ text: shareText });
        } else {
          await navigator.clipboard.writeText(shareText);
          tg?.showPopup?.({ title: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ", message: "–¢–µ–∫—Å—Ç –¥–ª—è —à–∞—Ä–∏–Ω–≥–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω.", buttons: [{type:"ok"}] });
        }
      } catch(e) {}
    });
  }

  async function loadFeed(){
    showState("–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶");
    try {
      const data = await jsonFetch(`${API_BASE}/feed?tg_id=${encodeURIComponent(tg_id)}`, { method: "GET" });
      if (!data?.ok) throw new Error(data?.error || "feed_error");

      const item = data?.item;
      if (!item) {
        showState("–ü–æ–∫–∞ –Ω–µ—Ç –ø–∞—Ä –¥–ª—è –ø–æ–∫–∞–∑–∞.");
        return;
      }
      renderPair(item);
    } catch (e) {
      showState("–û—à–∏–±–∫–∞: " + safeText(e.message || e), true);
    }
  }

  async function vote(pair_id, choice){
    try {
      // –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ: –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å ‚Äú–ø—Ä–∏–Ω—è—Ç–æ‚Äù
      tg?.HapticFeedback?.impactOccurred?.("light");

      const data = await jsonFetch(`${API_BASE}/vote`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tg_id: String(tg_id), pair_id: Number(pair_id), choice: String(choice) })
      });

      if (!data?.ok) throw new Error(data?.error || "vote_error");
      await loadFeed();
    } catch (e) {
      const msg = safeText(e.message || e);
      if (msg.includes("cannot_vote_own_pair")) {
        tg?.showPopup?.({ title: "–ù–µ–ª—å–∑—è", message: "–ù–µ–ª—å–∑—è –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –∑–∞ —Å–≤–æ—é –ø–∞—Ä—É.", buttons: [{type:"ok"}] });
        return;
      }
      tg?.showPopup?.({ title: "–û—à–∏–±–∫–∞", message: msg, buttons: [{type:"ok"}] });
    }
  }

  // Modal upload
  function openModal(){
    uploadState.style.display = "none";
    uploadState.textContent = "";
    modalOverlay.style.display = "flex";
  }
  function closeModal(){
    modalOverlay.style.display = "none";
  }

  fileLeft.addEventListener("change", () => {
    leftName.textContent = fileLeft.files?.[0]?.name ? fileLeft.files[0].name : "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
  });
  fileRight.addEventListener("change", () => {
    rightName.textContent = fileRight.files?.[0]?.name ? fileRight.files[0].name : "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
  });

  btnCloseModal.addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", (e) => { if (e.target === modalOverlay) closeModal(); });

  btnUpload.addEventListener("click", async () => {
    const f1 = fileLeft.files?.[0];
    const f2 = fileRight.files?.[0];
    if (!f1 || !f2){
      uploadState.style.display = "block";
      uploadState.className = "state err";
      uploadState.textContent = "–í—ã–±–µ—Ä–∏ –æ–±–∞ —Ñ–∞–π–ª–∞: –§–æ—Ç–æ 1 –∏ –§–æ—Ç–æ 2.";
      return;
    }

    uploadState.style.display = "block";
    uploadState.className = "state";
    uploadState.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

    try {
      const fd = new FormData();
      fd.append("tg_id", String(tg_id));
      fd.append("left", f1);
      fd.append("right", f2);

      const r = await fetch(`${API_BASE}/upload_pair`, { method: "POST", body: fd });
      const data = await r.json().catch(() => ({}));
      if (!r.ok || !data?.ok) throw new Error(data?.error || ("HTTP " + r.status));

      uploadState.className = "state";
      uploadState.textContent = "–ì–æ—Ç–æ–≤–æ! –ü–∞—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.";

      // —Å–±—Ä–æ—Å
      fileLeft.value = "";
      fileRight.value = "";
      leftName.textContent = "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
      rightName.textContent = "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";

      setTimeout(() => {
        closeModal();
        loadFeed();
      }, 400);
    } catch (e) {
      uploadState.className = "state err";
      uploadState.textContent = "–û—à–∏–±–∫–∞: " + safeText(e.message || e);
    }
  });

  // Bottom nav
  navHome.addEventListener("click", () => {
    elMain.scrollTo({ top: 0, behavior: "smooth" });
    loadFeed();
  });

  navAdd.addEventListener("click", openModal);

  navProfile.addEventListener("click", () => {
    tg?.showPopup?.({
      title: "–ü—Ä–æ—Ñ–∏–ª—å",
      message: `–í–∞—à Telegram ID: ${tg_id}`,
      buttons: [{ type: "ok" }]
    });
  });

  // —Å—Ç–∞—Ä—Ç
  loadFeed();
})();
</script>
</body>
</html>
