<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LookingGreat</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --text:#101114;
      --muted:#6b7280;
      --border:#e5e7eb;
      --btn:#111827;
      --btnText:#fff;
      --btn2:#f3f4f6;
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --radius:18px;
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:420px;margin:0 auto;padding:14px 14px 28px;}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      margin:10px 0;
    }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:6px 0 10px;
    }
    .logo{font-weight:900;letter-spacing:.2px;}
    .link{
      font-size:13px;
      color:#111827;
      text-decoration:underline;
      cursor:pointer;
      user-select:none;
    }

    .h1{font-size:22px;font-weight:900;line-height:1.15;margin:0 0 6px;}
    .sub{font-size:13px;color:var(--muted);line-height:1.35;margin:0 0 12px;}
    .muted{color:var(--muted);font-size:13px;line-height:1.35;}
    .btn{
      width:100%;
      border:0;
      background:var(--btn);
      color:var(--btnText);
      padding:12px 14px;
      border-radius:14px;
      font-size:15px;
      font-weight:800;
      cursor:pointer;
    }
    .btn2{
      width:100%;
      border:1px solid var(--border);
      background:var(--btn2);
      color:#111827;
      padding:12px 14px;
      border-radius:14px;
      font-size:15px;
      font-weight:800;
      cursor:pointer;
    }
    .btnRow{display:flex;gap:10px;margin-top:10px;}
    .btnRow .btn, .btnRow .btn2{width:auto;flex:1;}

    .pillRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .pillActive{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }

    .hidden{display:none !important;}

    /* Vote */
    .voteGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .voteTile{
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background:#fafafa;
      cursor:pointer;
      position:relative;
      min-height:170px;
    }
    .voteTile img{
      width:100%;
      height:220px;
      object-fit:cover;
      display:block;
      background:#ddd;
    }
    .voteBadge{
      position:absolute;
      left:10px;
      top:10px;
      background:rgba(17,24,39,.85);
      color:#fff;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      backdrop-filter: blur(4px);
    }
    .centerNote{font-size:12px;color:var(--muted);text-align:center;margin-top:10px;}

    /* Create */
    .field{margin:10px 0;}
    .label{font-size:13px;font-weight:800;margin:0 0 6px;}
    .file{
      width:100%;
      padding:10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
    }
    .status{margin-top:10px;font-size:14px;}

    /* Results cards */
    .pairGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    .pairGrid img{width:100%;border-radius:12px;display:block;background:#f5f5f5;}
    .kpiRow{display:flex;gap:10px;margin-top:10px;}
    .kpi{
      flex:1;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background:#fff;
    }
    .kpi .n{font-size:18px;font-weight:900;}
    .kpi .t{font-size:12px;color:var(--muted);margin-top:2px;}

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      background:rgba(17,24,39,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      box-shadow:var(--shadow);
      display:none;
      max-width:min(520px,92vw);
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">LookingGreat</div>
      <div class="link" id="goVoteTop">Голосовать</div>
    </div>

    <!-- VIEW: VOTE -->
    <div class="card" id="viewVote">
      <div class="h1">Кто выглядит лучше?</div>
      <div class="sub">Анонимное голосование. Просто выбери один вариант.</div>

      <div class="voteGrid">
        <div class="voteTile" id="tileLeft" data-side="left">
          <div class="voteBadge">ЛЕВО</div>
          <img id="imgLeft" alt="Левое фото" />
        </div>
        <div class="voteTile" id="tileRight" data-side="right">
          <div class="voteBadge">ПРАВО</div>
          <img id="imgRight" alt="Правое фото" />
        </div>
      </div>

      <div class="btnRow">
        <button class="btn2" id="btnNext">Другое</button>
        <button class="btn" id="btnCreateFromVote">Создать своё</button>
      </div>

      <div class="centerNote" id="voteHint">Нажми на фото, чтобы проголосовать</div>
      <div class="status" id="voteStatus"></div>
    </div>

    <!-- VIEW: CREATE -->
    <div class="card hidden" id="viewCreate">
      <div class="h1">Создай голосование</div>
      <div class="sub">Загрузи 2 фото. Люди будут выбирать анонимно.</div>

      <div class="field">
        <div class="label">Фото слева</div>
        <input class="file" id="fileLeft" type="file" accept="image/*" />
      </div>

      <div class="field">
        <div class="label">Фото справа</div>
        <input class="file" id="fileRight" type="file" accept="image/*" />
      </div>

      <button class="btn" id="btnUploadCreate">Загрузить и создать</button>
      <div style="height:8px"></div>
      <button class="btn2" id="btnBackFromCreate">Назад к голосованию</button>
      <div class="status" id="uploadStatus"></div>
    </div>

    <!-- VIEW: RESULTS -->
    <div class="card hidden" id="viewResults">
      <div class="h1">Мои результаты</div>
      <div class="sub">Твои созданные пары и их результаты.</div>

      <div class="kpiRow">
        <div class="kpi"><div class="n" id="kpiPairs">—</div><div class="t">пар создано</div></div>
        <div class="kpi"><div class="n" id="kpiVotes">—</div><div class="t">голосов всего</div></div>
      </div>

      <div style="height:10px"></div>
      <button class="btn2" id="btnLoadMy">Обновить результаты</button>
      <div style="height:8px"></div>
      <button class="btn2" id="btnBackFromResults">Назад</button>

      <div class="status" id="myStatus"></div>
      <div id="myResults"></div>
    </div>

    <div class="pillRow">
      <div class="pill pillActive" id="pillVote">Голосовать</div>
      <div class="pill" id="pillCreate">Создать</div>
      <div class="pill" id="pillResults">Мои результаты</div>
    </div>

    <!-- скрытый контейнер для совместимости (мы не показываем ленту списком на первом экране) -->
    <div class="hidden" id="feed"></div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  // Потом просто заменишь на https://api.lookingreat.ru
  const API_BASE = "https://orange-math-fa5e.89123631000g.workers.dev";

  function toast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toast._tm);
    toast._tm = setTimeout(()=>{ t.style.display="none"; }, 1600);
  }

  function setStatus(id, msg) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = msg || "";
  }

  function getTelegramId() {
    const tg = window.Telegram?.WebApp;
    const id = tg?.initDataUnsafe?.user?.id;
    return id ? String(id) : null;
  }

  async function fetchJson(url, options) {
    const resp = await fetch(url, options);
    const data = await resp.json().catch(() => null);
    if (!resp.ok) {
      throw new Error(data?.error || `HTTP ${resp.status}`);
    }
    return data;
  }

  function normalizeImageUrl(u) {
    if (!u) return u;
    try {
      const url = new URL(u);
      if (url.pathname === "/r2img") return u;
      if (url.pathname.startsWith("/r2/")) {
        const key = url.pathname.slice("/r2/".length);
        return `${url.origin}/r2img?key=${encodeURIComponent(key)}`;
      }
      return u;
    } catch {
      return u;
    }
  }

  function makeImgEl(imgEl, src) {
    imgEl.src = normalizeImageUrl(src);
    imgEl.onerror = () => {
      imgEl.style.opacity = "0.35";
      imgEl.title = "Не удалось загрузить изображение";
    };
    imgEl.onload = () => {
      imgEl.style.opacity = "1";
      imgEl.title = "";
    };
  }

  async function uploadTwoPhotosToR2(leftFile, rightFile, telegramId) {
    const fd = new FormData();
    fd.append("left", leftFile);
    fd.append("right", rightFile);
    fd.append("telegram_id", telegramId);

    try {
      const resp = await fetch(`${API_BASE}/api/upload_photos`, { method: "POST", body: fd });
      const data = await resp.json().catch(() => null);
      if (!resp.ok || !data?.ok) throw new Error(data?.error || `HTTP ${resp.status}`);
      return data;
    } catch (e) {
      throw new Error(e?.message || "Load failed");
    }
  }

  async function createPair(leftUrl, rightUrl, telegramId) {
    return await fetchJson(`${API_BASE}/api/create_pair`, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({
        telegram_id: telegramId,
        photo_left_url: normalizeImageUrl(leftUrl),
        photo_right_url: normalizeImageUrl(rightUrl),
      }),
    });
  }

  async function loadFeed(telegramId) {
    return await fetchJson(`${API_BASE}/api/feed?telegram_id=${encodeURIComponent(telegramId)}&limit=30`, {
      method: "GET",
    });
  }

  async function vote(photoPairId, choice, telegramId) {
    return await fetchJson(`${API_BASE}/api/vote`, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({
        telegram_id: telegramId,
        photo_pair_id: photoPairId,
        choice: choice,
      }),
    });
  }

  async function loadMy(telegramId) {
    return await fetchJson(`${API_BASE}/api/my_results?telegram_id=${encodeURIComponent(telegramId)}&limit=30`, {
      method: "GET",
    });
  }

  function el(tag, attrs = {}, children = []) {
    const n = document.createElement(tag);
    Object.entries(attrs).forEach(([k, v]) => {
      if (k === "class") n.className = v;
      else if (k === "html") n.innerHTML = v;
      else n.setAttribute(k, v);
    });
    children.forEach(c => n.appendChild(c));
    return n;
  }

  function showView(name) {
    document.getElementById("viewVote").classList.add("hidden");
    document.getElementById("viewCreate").classList.add("hidden");
    document.getElementById("viewResults").classList.add("hidden");
    document.getElementById(name).classList.remove("hidden");

    document.getElementById("pillVote").classList.remove("pillActive");
    document.getElementById("pillCreate").classList.remove("pillActive");
    document.getElementById("pillResults").classList.remove("pillActive");

    if (name === "viewVote") document.getElementById("pillVote").classList.add("pillActive");
    if (name === "viewCreate") document.getElementById("pillCreate").classList.add("pillActive");
    if (name === "viewResults") document.getElementById("pillResults").classList.add("pillActive");
  }

  // ----------------- Vote-first state -----------------
  let feedItems = [];
  let feedIndex = 0;
  let currentItem = null;
  let voteLocked = false;

  async function ensureTelegramId() {
    const id = getTelegramId();
    if (!id) throw new Error("Открой мини-приложение из Telegram.");
    return id;
  }

  function pickNextItem() {
    if (!feedItems || feedItems.length === 0) return null;
    // чтобы не зависать на одной паре — крутим индекс по кругу
    const item = feedItems[feedIndex % feedItems.length];
    feedIndex++;
    return item;
  }

  function renderCurrentVote() {
    const leftImg = document.getElementById("imgLeft");
    const rightImg = document.getElementById("imgRight");

    if (!currentItem) {
      leftImg.removeAttribute("src");
      rightImg.removeAttribute("src");
      document.getElementById("voteHint").textContent = "Пока нет голосований. Создай первое.";
      setStatus("voteStatus", "");
      return;
    }

    makeImgEl(leftImg, currentItem.photo_left_url);
    makeImgEl(rightImg, currentItem.photo_right_url);

    if (currentItem.my_choice) {
      voteLocked = true;
      document.getElementById("voteHint").textContent =
        `Ты уже голосовал: ${currentItem.my_choice === "left" ? "левое" : "правое"}`;
    } else {
      voteLocked = false;
      document.getElementById("voteHint").textContent = "Нажми на фото, чтобы проголосовать";
    }

    setStatus("voteStatus", "");
  }

  async function refreshFeedAndShow() {
    const id = await ensureTelegramId();
    setStatus("voteStatus", "Загружаю ленту…");
    const data = await loadFeed(id);
    feedItems = Array.isArray(data.items) ? data.items : [];
    feedIndex = 0;

    currentItem = pickNextItem();
    renderCurrentVote();
    setStatus("voteStatus", "");
  }

  async function showNextVote() {
    if (!feedItems || feedItems.length === 0) {
      await refreshFeedAndShow();
      return;
    }
    currentItem = pickNextItem();
    renderCurrentVote();
  }

  async function sendVote(choice) {
    if (!currentItem) return;
    if (voteLocked) return;

    try {
      voteLocked = true;
      const id = await ensureTelegramId();
      await vote(currentItem.id, choice, id);

      toast("Голос засчитан");
      currentItem.my_choice = choice;
      document.getElementById("voteHint").textContent = "Спасибо! Хочешь создать своё голосование?";
    } catch (e) {
      voteLocked = false;
      setStatus("voteStatus", "Ошибка: " + (e.message || e));
    }
  }

  // ----------------- Results render -----------------
  function renderMy(items) {
    const root = document.getElementById("myResults");
    root.innerHTML = "";

    if (!items || items.length === 0) {
      root.appendChild(el("div", { class: "muted", html: "У тебя пока нет созданных пар." }));
      document.getElementById("kpiPairs").textContent = "0";
      document.getElementById("kpiVotes").textContent = "0";
      return;
    }

    let totalVotesAll = 0;
    items.forEach(item => {
      const total = item.total_votes || 0;
      const l = item.left_votes || 0;
      const r = item.right_votes || 0;
      totalVotesAll += total;

      const card = el("div", { class: "card" });
      card.style.boxShadow = "none";
      card.style.margin = "10px 0 0";

      card.appendChild(el("div", { class: "muted", html: `Голосов: <b>${total}</b> (лево: ${l}, право: ${r})` }));

      const pair = el("div", { class: "pairGrid" }, [
        el("div", {}, [ el("img", { src: normalizeImageUrl(item.photo_left_url), alt: "left" }) ]),
        el("div", {}, [ el("img", { src: normalizeImageUrl(item.photo_right_url), alt: "right" }) ])
      ]);

      card.appendChild(pair);
      root.appendChild(card);
    });

    document.getElementById("kpiPairs").textContent = String(items.length);
    document.getElementById("kpiVotes").textContent = String(totalVotesAll);
  }

  // ----------------- Init & events -----------------
  (function init() {
    try {
      const tg = window.Telegram?.WebApp;
      tg?.ready?.();
      tg?.expand?.();
    } catch {}

    // vote first
    showView("viewVote");

    // первичная загрузка ленты
    (async () => {
      try {
        await refreshFeedAndShow();
      } catch (e) {
        setStatus("voteStatus", "Ошибка: " + (e.message || e));
        document.getElementById("voteHint").textContent = "Не удалось загрузить ленту.";
      }
    })();

    // vote clicks
    document.getElementById("tileLeft").addEventListener("click", () => sendVote("left"));
    document.getElementById("tileRight").addEventListener("click", () => sendVote("right"));

    document.getElementById("btnNext").addEventListener("click", async () => {
      try { await showNextVote(); } catch(e){ setStatus("voteStatus","Ошибка: "+(e.message||e)); }
    });

    document.getElementById("btnCreateFromVote").addEventListener("click", () => showView("viewCreate"));
    document.getElementById("btnBackFromCreate").addEventListener("click", () => showView("viewVote"));
    document.getElementById("btnBackFromResults").addEventListener("click", () => showView("viewVote"));

    document.getElementById("goVoteTop").addEventListener("click", () => showView("viewVote"));

    document.getElementById("pillVote").addEventListener("click", () => showView("viewVote"));
    document.getElementById("pillCreate").addEventListener("click", () => showView("viewCreate"));
    document.getElementById("pillResults").addEventListener("click", async () => {
      showView("viewResults");
      const statusEl = document.getElementById("myStatus");
      try {
        const id = await ensureTelegramId();
        statusEl.textContent = "Загружаю результаты…";
        const data = await loadMy(id);
        renderMy(data.items);
        statusEl.textContent = "";
      } catch (e) {
        statusEl.textContent = "Ошибка: " + (e.message || e);
      }
    });

    // Create flow
    document.getElementById("btnUploadCreate").addEventListener("click", async () => {
      const statusEl = document.getElementById("uploadStatus");
      const left = document.getElementById("fileLeft")?.files?.[0];
      const right = document.getElementById("fileRight")?.files?.[0];

      try {
        statusEl.textContent = "Проверяю Telegram ID…";
        const id = await ensureTelegramId();
        if (!left || !right) throw new Error("Выбери два фото (слева и справа).");

        statusEl.textContent = "Загружаю фото…";
        const up = await uploadTwoPhotosToR2(left, right, id);

        statusEl.textContent = "Создаю пару…";
        const created = await createPair(up.left_url, up.right_url, id);

        statusEl.textContent = `Готово! Пара создана (id: ${created.id}).`;
        document.getElementById("fileLeft").value = "";
        document.getElementById("fileRight").value = "";

        // после создания — возвращаем в голосование и обновляем ленту
        toast("Пара создана");
        showView("viewVote");
        await refreshFeedAndShow();
      } catch (e) {
        statusEl.textContent = "Ошибка: " + (e.message || e);
      }
    });

    // Results refresh button
    document.getElementById("btnLoadMy").addEventListener("click", async () => {
      const statusEl = document.getElementById("myStatus");
      try {
        const id = await ensureTelegramId();
        statusEl.textContent = "Загружаю результаты…";
        const data = await loadMy(id);
        renderMy(data.items);
        statusEl.textContent = "";
      } catch (e) {
        statusEl.textContent = "Ошибка: " + (e.message || e);
      }
    });
  })();
</script>
</body>
</html>
