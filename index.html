<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>LookingGreat</title>

  <!-- Telegram WebApp (если открыто внутри Telegram) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0c10;
      --card:#11131a;
      --text:#f2f3f5;
      --muted:#a8adbd;
      --stroke:rgba(255,255,255,.12);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --cta:#ffffff;
      --ctaText:#0b0c10;
      --danger:#ff4d4d;
      --ok:#2ecc71;
      --tap: rgba(255,255,255,.08);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --card:#ffffff;
        --text:#141824;
        --muted:#5b6375;
        --stroke:rgba(0,0,0,.10);
        --shadow: 0 12px 40px rgba(10,15,25,.12);
        --cta:#141824;
        --ctaText:#ffffff;
        --tap: rgba(10,15,25,.06);
      }
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    a{ color: inherit; text-decoration: none; }
    button{ font: inherit; }
    .wrap{
      max-width: 560px;
      margin: 0 auto;
      padding: 16px 16px 110px;
    }

    /* Header: ТОЛЬКО бренд. Без кнопок и ссылок "Голосовать" */
    header{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px 0 6px;
      position: sticky;
      top: 0;
      background: linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,0));
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    @media (prefers-color-scheme: light){
      header{
        background: linear-gradient(to bottom, rgba(246,247,251,.85), rgba(246,247,251,0));
      }
    }
    .brand{
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 16px;
      padding: 10px 14px;
      border: 1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(255,255,255,.02);
    }
    @media (prefers-color-scheme: light){
      .brand{ background: rgba(0,0,0,.02); }
    }

    /* Screens */
    .screen{ display:none; }
    .screen.active{ display:block; }

    /* Home hero */
    .hero{
      margin-top: 16px;
      background: radial-gradient(1200px 420px at 50% -120px, rgba(255,255,255,.08), transparent 60%);
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .h1{
      font-size: 30px;
      line-height: 1.1;
      letter-spacing: -0.6px;
      font-weight: 900;
      margin: 0 0 10px;
    }
    .sub{
      margin: 0 0 14px;
      color: var(--muted);
      font-size: 14px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
    }
    .pill{
      padding: 6px 10px;
      border: 1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(255,255,255,.03);
    }
    @media (prefers-color-scheme: light){
      .pill{ background: rgba(0,0,0,.02); }
    }

    .previewCard{
      margin-top: 12px;
      border-radius: var(--radius2);
      border: 1px solid var(--stroke);
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    @media (prefers-color-scheme: light){
      .previewCard{ background: rgba(0,0,0,.02); }
    }
    .pairGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: var(--stroke);
    }
    .imgBox{
      aspect-ratio: 1 / 1;
      position: relative;
      overflow:hidden;
      background: rgba(255,255,255,.03);
    }
    .imgBox img{
      width:100%;
      height:100%;
      object-fit: cover;
      filter: blur(10px) brightness(.9);
      transform: scale(1.08);
      display:block;
    }
    .imgBox::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(to bottom, rgba(0,0,0,.10), rgba(0,0,0,.25));
      pointer-events:none;
    }

    .cta{
      width:100%;
      margin-top: 14px;
      padding: 14px 16px;
      border-radius: 14px;
      border: 0;
      background: var(--cta);
      color: var(--ctaText);
      font-weight: 900;
      font-size: 16px;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
    }
    .cta:active{ transform: translateY(1px); }

    .micro{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
    }

    /* Soft nav (не в шапке) */
    .softNav{
      margin-top: 14px;
      display:flex;
      justify-content:center;
      gap: 12px;
      font-size: 13px;
      color: var(--muted);
    }
    .softNav a{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
    }
    .softNav a:active{ background: var(--tap); }

    /* Vote screen */
    .blockTitle{
      font-size: 18px;
      font-weight: 900;
      margin: 12px 0 10px;
      letter-spacing: -0.2px;
    }
    .voteCard{
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    @media (prefers-color-scheme: light){
      .voteCard{ background: rgba(0,0,0,.02); }
    }
    .voteGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: var(--stroke);
    }
    .voteBtn{
      padding:0;
      border:0;
      background: transparent;
      cursor:pointer;
      position:relative;
    }
    .voteBtn .imgBox img{
      filter: none;
      transform:none;
    }
    /* ВАЖНО: никаких "ЛЕВО/ПРАВО" */
    .voteBtn:active{
      outline: 3px solid rgba(255,255,255,.22);
      outline-offset: -3px;
    }
    .voteHint{
      padding: 12px 12px 14px;
      color: var(--muted);
      font-size: 13px;
      text-align:center;
    }

    .row{
      display:flex;
      gap: 10px;
      margin-top: 12px;
    }
    .ghost{
      flex: 1;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: transparent;
      color: var(--text);
      cursor:pointer;
      font-weight: 800;
    }
    .ghost:active{ background: var(--tap); }

    .toast{
      margin-top: 10px;
      padding: 10px 12px;
      border: 1px solid var(--stroke);
      border-radius: 14px;
      color: var(--muted);
      font-size: 13px;
      display:none;
    }
    .toast.show{ display:block; }

    /* Bottom nav (после первого действия; показываем не на Home) */
    .bottomNav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 14px calc(10px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(0,0,0,.60), rgba(0,0,0,0));
      backdrop-filter: blur(12px);
      z-index: 20;
      display:none;
    }
    @media (prefers-color-scheme: light){
      .bottomNav{
        background: linear-gradient(to top, rgba(246,247,251,.92), rgba(246,247,251,0));
      }
    }
    .bottomNavInner{
      max-width: 560px;
      margin: 0 auto;
      display:flex;
      gap: 10px;
    }
    .tab{
      flex:1;
      text-align:center;
      padding: 12px 10px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      color: var(--muted);
      font-weight: 900;
      font-size: 13px;
      background: rgba(255,255,255,.03);
    }
    @media (prefers-color-scheme: light){
      .tab{ background: rgba(0,0,0,.02); }
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(255,255,255,.22);
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">LookingGreat</div>
  </header>

  <div class="wrap">
    <!-- HOME (первый экран) -->
    <section id="screen-home" class="screen active" aria-label="Главная">
      <div class="hero">
        <h1 class="h1">Кто выглядит лучше?</h1>
        <div class="sub">
          <span class="pill">Анонимно</span>
          <span class="pill">1 тап</span>
          <span class="pill">Без регистрации</span>
        </div>

        <!-- Превью-пара (замыленная, не интерактив) -->
        <div class="previewCard" aria-hidden="true">
          <div class="pairGrid">
            <div class="imgBox"><img id="homePrevA" alt="" /></div>
            <div class="imgBox"><img id="homePrevB" alt="" /></div>
          </div>
        </div>

        <button id="btnStartVote" class="cta">Начать голосовать</button>
        <div class="micro">Сначала голосуешь — потом можешь загрузить свои фото</div>

        <!-- Навигация НЕ в шапке -->
        <nav class="softNav" aria-label="Навигация">
          <a href="#create" id="linkCreateSoft">Создать</a>
          <a href="#results" id="linkResultsSoft">Мои результаты</a>
        </nav>
      </div>
    </section>

    <!-- VOTE -->
    <section id="screen-vote" class="screen" aria-label="Голосование">
      <div class="blockTitle">Выбери, что лучше</div>

      <div class="voteCard">
        <div class="voteGrid" id="voteGrid">
          <button class="voteBtn" id="voteA" aria-label="Выбрать фото A">
            <div class="imgBox"><img id="voteImgA" alt="Фото A" /></div>
          </button>
          <button class="voteBtn" id="voteB" aria-label="Выбрать фото B">
            <div class="imgBox"><img id="voteImgB" alt="Фото B" /></div>
          </button>
        </div>
        <div class="voteHint">Просто тапни по фото. Без комментариев.</div>
      </div>

      <div class="row">
        <button class="ghost" id="btnSkip">Пропустить</button>
        <button class="ghost" id="btnNext">Дальше</button>
      </div>

      <div id="toast" class="toast" role="status" aria-live="polite"></div>
    </section>

    <!-- CREATE -->
    <section id="screen-create" class="screen" aria-label="Создать пару">
      <div class="blockTitle">Создать пару</div>
      <div class="toast show">
        Здесь будет ваш текущий экран создания пары (форма/загрузка).<br><br>
        Я оставил заглушку, чтобы первый экран был «эмоциональный» и не показывал формы сразу.
      </div>
    </section>

    <!-- RESULTS -->
    <section id="screen-results" class="screen" aria-label="Мои результаты">
      <div class="blockTitle">Мои результаты</div>
      <div class="toast show">
        Здесь будет ваш текущий экран результатов.<br><br>
        Если он уже есть — просто перенесём сюда ваш рендер.
      </div>
    </section>
  </div>

  <!-- Bottom nav (не показываем на Home) -->
  <nav class="bottomNav" id="bottomNav" aria-label="Нижняя навигация">
    <div class="bottomNavInner">
      <a class="tab" href="#vote" id="tabVote">Голосовать</a>
      <a class="tab" href="#create" id="tabCreate">Создать</a>
      <a class="tab" href="#results" id="tabResults">Мои</a>
    </div>
  </nav>

  <script>
    /***********************
     * CONFIG
     ***********************/
    // Если фронт на GitHub Pages, а API на Worker — укажи API_BASE.
    // Можно оставить '' (тогда запросы идут на тот же домен).
    const API_BASE = ''; // пример: 'https://lookingreat.ru' или 'https://<your-domain>'
    const ENDPOINTS = {
      // Подстрой под свои реальные пути (если отличаются) — это единственное место.
      nextPair: '/api/vote/next',     // GET -> { pair_id, left_url, right_url }
      vote:     '/api/vote',          // POST -> { pair_id, choice: "A"|"B" }
      skip:     '/api/vote/skip'      // POST -> { pair_id }
    };

    /***********************
     * Telegram init (аккуратно)
     ***********************/
    try{
      if (window.Telegram && Telegram.WebApp){
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        // Цвета можно потом синхронизировать с темой Telegram, если захочешь.
      }
    }catch(e){}

    /***********************
     * Router
     ***********************/
    const screens = {
      home: document.getElementById('screen-home'),
      vote: document.getElementById('screen-vote'),
      create: document.getElementById('screen-create'),
      results: document.getElementById('screen-results')
    };
    const bottomNav = document.getElementById('bottomNav');
    const tabs = {
      vote: document.getElementById('tabVote'),
      create: document.getElementById('tabCreate'),
      results: document.getElementById('tabResults')
    };

    function showScreen(name){
      for (const k in screens){
        screens[k].classList.toggle('active', k === name);
      }
      // Bottom nav НЕ на первом экране
      bottomNav.style.display = (name === 'home') ? 'none' : 'block';

      // Tabs active
      for (const k in tabs){
        tabs[k].classList.toggle('active', k === name);
      }
    }

    function route(){
      const hash = (location.hash || '#home').replace('#','');
      const name = ['home','vote','create','results'].includes(hash) ? hash : 'home';
      showScreen(name);

      if (name === 'vote'){
        ensureVoteLoaded();
      }
    }
    window.addEventListener('hashchange', route);

    /***********************
     * Home preview images (замыленное превью)
     ***********************/
    const homePrevA = document.getElementById('homePrevA');
    const homePrevB = document.getElementById('homePrevB');

    // Можно заменить на ваши "дефолтные" картинки или брать из nextPair
    const FALLBACK_PREVIEW_A = 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=900&q=80';
    const FALLBACK_PREVIEW_B = 'https://images.unsplash.com/photo-1490474418585-ba9bad8fd0ea?auto=format&fit=crop&w=900&q=80';

    homePrevA.src = FALLBACK_PREVIEW_A;
    homePrevB.src = FALLBACK_PREVIEW_B;

    /***********************
     * Vote logic
     ***********************/
    const voteImgA = document.getElementById('voteImgA');
    const voteImgB = document.getElementById('voteImgB');
    const voteA = document.getElementById('voteA');
    const voteB = document.getElementById('voteB');
    const btnStartVote = document.getElementById('btnStartVote');
    const btnNext = document.getElementById('btnNext');
    const btnSkip = document.getElementById('btnSkip');
    const toast = document.getElementById('toast');

    let currentPair = null;
    let voteLoading = false;

    function apiUrl(path){
      return (API_BASE || '') + path;
    }

    function showToast(msg, ms=2200){
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.classList.remove('show'), ms);
    }

    async function fetchNextPair(){
      const url = apiUrl(ENDPOINTS.nextPair);
      const res = await fetch(url, { method:'GET', credentials:'include' });
      if (!res.ok) throw new Error('nextPair HTTP ' + res.status);
      return await res.json();
    }

    async function sendVote(pairId, choice){
      const url = apiUrl(ENDPOINTS.vote);
      const res = await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        credentials:'include',
        body: JSON.stringify({ pair_id: pairId, choice })
      });
      if (!res.ok) throw new Error('vote HTTP ' + res.status);
      return await res.json();
    }

    async function sendSkip(pairId){
      const url = apiUrl(ENDPOINTS.skip);
      const res = await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        credentials:'include',
        body: JSON.stringify({ pair_id: pairId })
      });
      // skip может быть опциональным: если нет — просто игнорируем
      return res.ok ? res.json().catch(()=> ({})) : {};
    }

    function setVoteImages(leftUrl, rightUrl){
      // ВАЖНО: никаких бейджей "лево/право" — просто картинки
      voteImgA.src = leftUrl || FALLBACK_PREVIEW_A;
      voteImgB.src = rightUrl || FALLBACK_PREVIEW_B;
    }

    async function ensureVoteLoaded(force=false){
      if (voteLoading) return;
      if (currentPair && !force) return;

      voteLoading = true;
      try{
        // Пытаемся взять реальную пару с бэка
        const data = await fetchNextPair();

        // Ожидаем поля: pair_id, left_url, right_url
        const pairId = data.pair_id ?? data.id ?? data.pairId;
        const leftUrl = data.left_url ?? data.photo_left_url ?? data.left ?? data.a;
        const rightUrl = data.right_url ?? data.photo_right_url ?? data.right ?? data.b;

        currentPair = { pairId, leftUrl, rightUrl };

        // Если бэк отдаёт /r2img?key=... — оно и нужно
        setVoteImages(leftUrl, rightUrl);

      }catch(e){
        // Если эндпоинты отличаются — голосование не ломаем, покажем заглушку и подсказку
        currentPair = { pairId: null, leftUrl: FALLBACK_PREVIEW_A, rightUrl: FALLBACK_PREVIEW_B };
        setVoteImages(currentPair.leftUrl, currentPair.rightUrl);
        showToast('Не удалось загрузить пару. Проверь ENDPOINTS в index.html.', 3500);
        console.warn(e);
      }finally{
        voteLoading = false;
      }
    }

    async function vote(choice){
      if (voteLoading) return;
      if (!currentPair) await ensureVoteLoaded(true);

      // Если pairId нет — просто перелистываем заглушку
      if (!currentPair.pairId){
        showToast('Демо-режим: эндпоинты не подключены.', 2200);
        await ensureVoteLoaded(true);
        return;
      }

      voteLoading = true;
      try{
        await sendVote(currentPair.pairId, choice);
        // быстрая “дофаминовая” микро-реакция
        showToast('Засчитано', 900);
        // следующий батл
        currentPair = null;
        await ensureVoteLoaded(true);
      }catch(e){
        showToast('Не получилось отправить голос', 2200);
        console.warn(e);
      }finally{
        voteLoading = false;
      }
    }

    async function skip(){
      if (voteLoading) return;
      if (!currentPair) await ensureVoteLoaded(true);

      voteLoading = true;
      try{
        if (currentPair?.pairId) await sendSkip(currentPair.pairId);
        currentPair = null;
        await ensureVoteLoaded(true);
      }catch(e){
        showToast('Не получилось пропустить', 2200);
        console.warn(e);
      }finally{
        voteLoading = false;
      }
    }

    /***********************
     * Events
     ***********************/
    btnStartVote.addEventListener('click', () => {
      // Уводим с первого экрана сразу в голосование (первое действие)
      location.hash = '#vote';
    });

    voteA.addEventListener('click', () => vote('A'));
    voteB.addEventListener('click', () => vote('B'));
    btnNext.addEventListener('click', () => ensureVoteLoaded(true));
    btnSkip.addEventListener('click', () => skip());

    /***********************
     * Boot
     ***********************/
    route();
  </script>
</body>
</html>
