<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LookingGreat</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0c10;
      --card:#11131a;
      --text:#ffffff;
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.52);
      --stroke:rgba(255,255,255,.10);
      --good:rgba(72,255,186,.95);
      --bad:rgba(255,96,96,.95);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 50% 0%, rgba(120,86,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, rgba(0,220,255,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    .wrap{
      max-width: 720px;
      margin: 0 auto;
      padding: 14px;
      padding-top: calc(14px + env(safe-area-inset-top));
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
    }

    /* top */
    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .brand{
      display:flex; flex-direction:column; gap:4px;
    }
    .brand .t1{
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 18px;
      line-height: 1.1;
    }
    .brand .t2{
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.25;
    }
    .chip{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      display:flex;
      gap:8px;
      align-items:center;
      user-select:none;
      -webkit-user-select:none;
      cursor:pointer;
      white-space:nowrap;
    }
    .chip:active{transform:scale(.98)}
    .dot{
      width:8px;height:8px;border-radius:99px;
      background: rgba(255,255,255,.35);
    }

    /* main battle card */
    .battle{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    .hero{
      padding: 12px 12px 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .hero .h1{
      font-weight:800;
      font-size: 16px;
      line-height:1.2;
      letter-spacing:.15px;
    }
    .hero .h2{
      margin-top:4px;
      font-size: 12.5px;
      color: var(--muted);
      line-height:1.25;
    }
    .count{
      font-size:12px;
      color: var(--muted2);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:6px 10px;
      border-radius:999px;
      user-select:none;
      -webkit-user-select:none;
      white-space:nowrap;
    }

    /* grid */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      padding: 10px;
    }

    .tile{
      position:relative;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      height: min(56vh, 520px);
      min-height: 270px;
      cursor: pointer;
      user-select:none;
      -webkit-user-select:none;
      touch-action: manipulation;
    }
    .tile:active{transform:scale(.995)}
    .tile img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      -webkit-user-drag:none;
    }

    .shine{
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.20), transparent 45%);
      opacity:.0;
      transition: opacity .25s ease;
      pointer-events:none;
    }
    .tile:hover .shine{opacity:.35}
    @media (hover:none){
      .tile:hover .shine{opacity:0}
    }

    /* overlay feedback */
    .pick{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.35);
      opacity:0;
      transition: opacity .16s ease;
      pointer-events:none;
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
    }
    .pick.show{opacity:1}
    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.30);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 800;
      letter-spacing:.2px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    .icon{
      width:18px;height:18px;border-radius:999px;
      background: rgba(255,255,255,.18);
      display:inline-block;
    }

    /* bottom helper */
    .help{
      padding: 10px 12px 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-top: 1px solid rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.3;
    }
    .mini{
      display:flex; gap:8px; align-items:center;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      white-space:nowrap;
    }
    .mini:active{transform:scale(.98)}

    /* loading */
    .skeleton{
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06));
      background-size: 200% 100%;
      animation: shimmer 1.1s infinite linear;
    }
    @keyframes shimmer{
      0%{background-position: 200% 0}
      100%{background-position: -200% 0}
    }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(14px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      max-width: min(640px, calc(100vw - 28px));
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-2px);
    }

    /* small screens */
    @media (max-width: 420px){
      .tile{min-height: 250px; height: min(58vh, 520px);}
      .brand .t1{font-size:17px}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div class="brand">
        <div class="t1">LookingGreat</div>
        <div class="t2">–ë–∞—Ç–ª: –≤—ã–±–µ—Ä–∏ —Ñ–æ—Ç–æ, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã–≥–ª—è–¥–∏—Ç –ª—É—á—à–µ</div>
      </div>

      <!-- –≤–∞–∂–Ω–æ: –Ω–∏–∫–∞–∫–æ–≥–æ "–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å" -->
      <div class="chip" id="btnResults" title="–ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã">
        <span class="dot"></span>
        <span>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</span>
      </div>
    </div>

    <div class="battle">
      <div class="hero">
        <div>
          <div class="h1">–¢–∞–ø–Ω–∏ –ø–æ —Ñ–æ—Ç–æ ‚Äî –∏ —Ä–µ—à–∏ —Å–ø–æ—Ä</div>
          <div class="h2">–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –¢–æ–ª—å–∫–æ —á–µ—Å—Ç–Ω—ã–π –≤—ã–±–æ—Ä.</div>
        </div>
        <div class="count" id="pairCounter">–ü–∞—Ä–∞ ‚Äî</div>
      </div>

      <div class="grid">
        <div class="tile" id="leftTile">
          <div class="skeleton" id="leftSkel"></div>
          <img id="leftImg" alt="" />
          <div class="shine"></div>
          <div class="pick" id="leftPick">
            <div class="badge"><span class="icon"></span>–í—ã–±—Ä–∞–Ω–æ</div>
          </div>
        </div>

        <div class="tile" id="rightTile">
          <div class="skeleton" id="rightSkel"></div>
          <img id="rightImg" alt="" />
          <div class="shine"></div>
          <div class="pick" id="rightPick">
            <div class="badge"><span class="icon"></span>–í—ã–±—Ä–∞–Ω–æ</div>
          </div>
        </div>
      </div>

      <div class="help">
        <div>–ë—ã—Å—Ç—Ä—ã–π –±–∞—Ç–ª. –ß–µ–º –±–æ–ª—å—à–µ –≥–æ–ª–æ—Å–æ–≤ ‚Äî —Ç–µ–º —Ç–æ—á–Ω–µ–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</div>
        <div class="mini" id="btnSkip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</div>
      </div>
    </div>

  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ---- Telegram WebApp init ----
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      tg.expand();
      // –±–µ–∑–æ–ø–∞—Å–Ω–æ: —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞ –≤ iOS
      tg.setHeaderColor && tg.setHeaderColor('#0b0c10');
      tg.setBackgroundColor && tg.setBackgroundColor('#0b0c10');
    }

    // ---- helpers ----
    const $ = (id) => document.getElementById(id);

    const leftTile = $('leftTile');
    const rightTile = $('rightTile');
    const leftImg = $('leftImg');
    const rightImg = $('rightImg');
    const leftSkel = $('leftSkel');
    const rightSkel = $('rightSkel');
    const leftPick = $('leftPick');
    const rightPick = $('rightPick');
    const toast = $('toast');
    const pairCounter = $('pairCounter');

    const btnResults = $('btnResults');
    const btnSkip = $('btnSkip');

    let telegramId = null;
    let currentItem = null;
    let busy = false;

    function showToast(text) {
      toast.textContent = text;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.remove('show'), 1500);
    }

    function getTelegramId() {
      // 1) –∏–∑ Telegram
      try {
        const id = tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id;
        if (id) return String(id);
      } catch(e) {}

      // 2) fallback –∏–∑ URL ?telegram_id=111 (–¥–ª—è —Ç–µ—Å—Ç–æ–≤ –≤–Ω–µ Telegram)
      const u = new URL(location.href);
      const q = u.searchParams.get('telegram_id') || u.searchParams.get('tg_id');
      if (q) return String(q);

      // 3) –¥–µ—Ñ–æ–ª—Ç (—á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –¥–µ–º–æ)
      return "111";
    }

    async function apiGet(url) {
      const r = await fetch(url, { method: 'GET', credentials: 'omit', cache: 'no-store' });
      return r.json();
    }

    async function apiPost(url, body) {
      const r = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
        credentials: 'omit',
        cache: 'no-store'
      });
      return r.json();
    }

    function resetPicks() {
      leftPick.classList.remove('show');
      rightPick.classList.remove('show');
    }

    function setLoading(isLoading) {
      leftSkel.style.display = isLoading ? 'block' : 'none';
      rightSkel.style.display = isLoading ? 'block' : 'none';
      if (isLoading) {
        leftImg.removeAttribute('src');
        rightImg.removeAttribute('src');
      }
    }

    function preload(url) {
      // –ø—Ä–æ—Å—Ç–æ–µ prefetch: –ø–æ–º–æ–≥–∞–µ—Ç –æ—â—É—â–µ–Ω–∏—é —Å–∫–æ—Ä–æ—Å—Ç–∏
      const img = new Image();
      img.decoding = "async";
      img.loading = "eager";
      img.src = url;
    }

    async function loadNextPair() {
      if (busy) return;
      busy = true;

      resetPicks();
      setLoading(true);
      pairCounter.textContent = "–ü–∞—Ä–∞‚Ä¶";

      try {
        const data = await apiGet(`/api/vote/next?telegram_id=${encodeURIComponent(telegramId)}`);
        if (!data || !data.ok || !data.item) {
          setLoading(false);
          showToast("–ü–∞—Ä—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å üòÖ");
          pairCounter.textContent = "–ü–∞—Ä—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å";
          busy = false;
          return;
        }

        currentItem = data.item;
        pairCounter.textContent = `–ü–∞—Ä–∞ #${currentItem.id}`;

        // —Å—Ç–∞–≤–∏–º src
        leftImg.src = currentItem.photo_left_url;
        rightImg.src = currentItem.photo_right_url;

        // –∫–æ–≥–¥–∞ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è ‚Äî —É–±–∏—Ä–∞–µ–º —Å–∫–µ–ª–µ—Ç
        let loaded = 0;
        const done = () => {
          loaded++;
          if (loaded >= 2) {
            setLoading(false);
            busy = false;
            // prefetch —Å–ª–µ–¥—É—é—â–µ–π –ø–∞—Ä—ã (–º—è–≥–∫–æ)
            setTimeout(async () => {
              try {
                const peek = await apiGet(`/api/vote/next?telegram_id=${encodeURIComponent(telegramId)}`);
                if (peek && peek.ok && peek.item) {
                  preload(peek.item.photo_left_url);
                  preload(peek.item.photo_right_url);
                }
              } catch(e) {}
            }, 150);
          }
        };

        // –µ—Å–ª–∏ –∫–µ—à —É–∂–µ –µ—Å—Ç—å, onload –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ä–µ–¥–∫–∏—Ö —Å–ª—É—á–∞—è—Ö ‚Äî —Å—Ç—Ä–∞—Ö—É–µ–º
        leftImg.onload = done;
        rightImg.onload = done;
        leftImg.onerror = done;
        rightImg.onerror = done;

        // –µ—Å–ª–∏ –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ ‚Äî —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ç–∞–π–º–µ—Ä
        setTimeout(() => {
          if (busy) { setLoading(false); busy = false; }
        }, 2500);

      catch (e) {
  // —Ç–∏—Ö–∏–π —Ä–µ—Ç—Ä–∞–π, –±–µ–∑ —Å–ª–æ–≤–∞ "–æ—à–∏–±–∫–∞" –≤ UI
  setLoading(false);
  busy = false;

  pairCounter.textContent = "–ó–∞–≥—Ä—É–∂–∞–µ–º‚Ä¶";

  setTimeout(() => {
    loadNextPair();
  }, 600);
}
      
    async function vote(choice) {
      if (busy) return;
      if (!currentItem) return;

      busy = true;

      // –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫
      if (choice === 'left') leftPick.classList.add('show');
      else rightPick.classList.add('show');

      try {
        const body = {
          telegram_id: telegramId,
          pair_id: currentItem.id,
          choice: choice
        };
        const res = await apiPost('/api/vote', body);

        if (!res || !res.ok) {
          showToast("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å");
          busy = false;
          resetPicks();
          return;
        }

        // –º–∞–ª–µ–Ω—å–∫–∞—è –ø–∞—É–∑–∞ —á—Ç–æ–±—ã —É—Å–ø–µ—Ç—å –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å "–≤—ã–±–æ—Ä"
        setTimeout(() => {
          busy = false;
          loadNextPair();
        }, 220);

      } catch(e) {
        showToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
        busy = false;
        resetPicks();
      }
    }

    async function openResults() {
      // –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ ‚Äî –ø—Ä–æ—Å—Ç—ã–º toast/alert,
      // —á—Ç–æ–±—ã –ø–µ—Ä–≤—ã–π —ç–∫—Ä–∞–Ω –±—ã–ª "–±–∞—Ç–ª", –±–µ–∑ –º–µ–Ω—é.
      try {
        const data = await apiGet(`/api/my_results?telegram_id=${encodeURIComponent(telegramId)}`);
        if (!data || !data.ok) {
          showToast("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã");
          return;
        }
        const voted = data.total_votes ?? data.voted ?? 0;
        const winrate = data.winrate ?? data.my_winrate ?? null;

        let text = `–¢–≤–æ–∏ –≥–æ–ª–æ—Å–∞: ${voted}`;
        if (winrate !== null && winrate !== undefined) {
          text += ` ‚Ä¢ –ü–æ–±–µ–¥—ã: ${Math.round(Number(winrate) * 100)}%`;
        }

        // Telegram alert —Å–º–æ—Ç—Ä–∏—Ç—Å—è –ª—É—á—à–µ
        if (tg && tg.showAlert) tg.showAlert(text);
        else alert(text);

      } catch(e) {
        showToast("–û—à–∏–±–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤");
      }
    }

    // ---- events ----
    leftTile.addEventListener('click', () => vote('left'));
    rightTile.addEventListener('click', () => vote('right'));
    btnSkip.addEventListener('click', () => loadNextPair());
    btnResults.addEventListener('click', () => openResults());

    // ---- start ----
    telegramId = getTelegramId();
    loadNextPair();
  </script>
</body>
</html>
