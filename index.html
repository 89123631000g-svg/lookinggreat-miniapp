<!-- index_v2.6.0.txt -->
<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LookingGreat</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  * { box-sizing: border-box; }

  :root{
    --bg:#ffffff;
    --text:#111111;
    --muted:rgba(0,0,0,.58);
    --border:rgba(0,0,0,.10);
    --card:#ffffff;
    --shadow: 0 10px 30px rgba(0,0,0,.10);
    --radius:16px;
  }

  html, body {
    margin: 0;
    padding: 0;
    height: 100dvh;
    overflow: hidden;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  .app {
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  /* Header */
  .topbar{
    padding: 12px 14px calc(10px + env(safe-area-inset-top));
    border-bottom: 1px solid var(--border);
    background: var(--bg);
  }
  .topbarRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .brand{
    display:flex;
    flex-direction:column;
    gap:2px;
    min-width:0;
  }
  .title{
    font-size: 18px;
    font-weight: 650;
    line-height: 1.15;
    margin: 0;
  }
  .sub{
    font-size: 12px;
    color: var(--muted);
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .tabs{
    display:flex;
    gap:8px;
    padding: 10px 0 0;
  }
  .tab{
    flex:1;
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 10px 10px;
    background:#fff;
    font-size: 13px;
    font-weight: 600;
    color: rgba(0,0,0,.7);
    cursor:pointer;
  }
  .tab.active{
    border-color: rgba(0,0,0,.18);
    color: rgba(0,0,0,.92);
    box-shadow: 0 6px 16px rgba(0,0,0,.06);
  }

  /* Main */
  .main{
    flex:1;
    overflow:hidden;
    padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
  }

  .view{
    height:100%;
    display:none;
  }
  .view.active{
    display:flex;
    flex-direction:column;
    height:100%;
  }

  /* Scroll areas */
  .scroll{
    flex:1;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 6px;
  }

  .card{
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--card);
    box-shadow: 0 10px 26px rgba(0,0,0,.06);
    overflow:hidden;
    margin: 0 0 12px 0;
  }

  .cardHead{
    padding: 12px 12px 10px;
  }
  .cardTitle{
    font-size: 15px;
    font-weight: 700;
    margin: 0 0 4px 0;
    line-height: 1.25;
    word-break: break-word;
  }
  .cardHint{
    font-size: 12.5px;
    color: var(--muted);
    margin: 0;
  }

  .photos{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    padding: 0 12px 12px;
  }
  .photoBtn{
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow:hidden;
    background:#f7f7f7;
    cursor:pointer;
    position:relative;
    min-height: 190px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .photoBtn img{
    width:100%;
    height:100%;
    object-fit: cover;
    display:block;
  }

  /* Selected state after vote */
  .photoBtn.selected{
    outline: 3px solid rgba(0,0,0,.26);
    outline-offset: -3px;
  }
  .photoBtn.disabled{
    cursor: default;
  }

  .cardFooter{
    display:none;
    border-top: 1px solid var(--border);
    padding: 10px 12px;
    font-size: 12.5px;
    color: rgba(0,0,0,.72);
  }
  .cardFooter.visible{
    display:block;
  }

  .mutedBox{
    border: 1px dashed rgba(0,0,0,.18);
    border-radius: 14px;
    padding: 12px;
    color: rgba(0,0,0,.65);
    background: rgba(15,23,42,.03);
    font-size: 13px;
  }

  /* Profile header */
  .profileTop{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom: 10px;
  }
  .profileTitle{
    font-size: 16px;
    font-weight: 750;
    margin:0;
  }
  .btn{
    border: 1px solid rgba(0,0,0,.14);
    background:#fff;
    border-radius: 14px;
    padding: 10px 12px;
    font-size: 13px;
    font-weight: 650;
    cursor:pointer;
    box-shadow: 0 10px 26px rgba(0,0,0,.06);
  }
  .btn:active{ transform: translateY(1px); }

  /* ===== Upload modal (ETALON ‚Äî –ù–ï –ú–ï–ù–Ø–¢–¨ –°–¢–ò–õ–¨) ===== */
  .sheetBack{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.35);
    display:none;
    align-items:flex-end;
    justify-content:center;
    padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
    z-index: 999;
  }
  .sheetBack.open{ display:flex; }

  .sheet{
    width: min(760px, 100%);
    background:#fff;
    border-radius: 18px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .sheetHead{
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .sheetTitle{
    font-size: 15px;
    font-weight: 750;
    margin:0;
  }
  .sheetClose{
    border: 1px solid rgba(0,0,0,.14);
    background:#fff;
    border-radius: 12px;
    padding: 8px 10px;
    font-size: 13px;
    font-weight: 650;
    cursor:pointer;
  }
  .sheetBody{
    padding: 12px 14px 14px;
  }

  /* ETALON: 2 –±–ª–æ–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ */
  .pickGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px; /* —Ñ–∏–∫—Å */
    margin-bottom: 10px;
  }
  .pickBox{
    border-radius: 14px; /* —Ñ–∏–∫—Å */
    border: 1px dashed rgba(0,0,0,.22); /* —Ñ–∏–∫—Å */
    padding: 12px; /* —Ñ–∏–∫—Å */
    min-height: 110px; /* —Ñ–∏–∫—Å */
    background: rgba(15,23,42,.03); /* —Ñ–∏–∫—Å */
    display:flex;
    flex-direction:column;
    gap: 8px;
    cursor:pointer;
    user-select:none;
  }
  .pickLabel{
    font-size: 12.5px;
    font-weight: 700;
    margin:0;
  }
  .pickHint{
    font-size: 12px;
    color: rgba(0,0,0,.58);
    margin:0;
  }
  .pickPreview{
    width:100%;
    height: 120px;
    border-radius: 12px;
    overflow:hidden;
    background:#fff;
    border: 1px solid rgba(0,0,0,.10);
    display:none;
  }
  .pickPreview img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .pickBox.hasImg .pickPreview{ display:block; }

  /* ETALON: caption */
  .caption{
    width:100%;
    border: 1px solid rgba(0,0,0,.14);
    border-radius: 14px; /* —Ñ–∏–∫—Å */
    padding: 12px;
    font-size: 14px; /* —Ñ–∏–∫—Å */
    outline:none;
  }

  /* ETALON: –∫–Ω–æ–ø–∫–∞ shareBtn —Å—Ç–∏–ª—å (–∫–∞–∫ primary) */
  .shareBtn{
    margin-top: 10px;
    width:100%;
    border: 0;
    border-radius: 14px;
    padding: 12px 14px;
    font-size: 14px;
    font-weight: 750;
    cursor:pointer;
    background: #111;
    color: #fff;
  }
  .shareBtn:disabled{
    opacity: .55;
    cursor: not-allowed;
  }

  /* Small helpers */
  .rowBetween{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .tiny{ font-size:12px; color: rgba(0,0,0,.58); }

</style>
</head>

<body>
<div class="app">

  <div class="topbar">
    <div class="topbarRow">
      <div class="brand">
        <p class="title">LookingGreat</p>
        <p class="sub" id="subLine">v2.6.0 ‚Ä¢ API: api.lookingreat.ru</p>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabFeed">–õ–µ–Ω—Ç–∞</button>
      <button class="tab" id="tabProfile">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</button>
    </div>
  </div>

  <div class="main">

    <!-- FEED -->
    <div class="view active" id="viewFeed">
      <div class="scroll" id="feedList">
        <div class="mutedBox">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–µ–Ω—Ç—ã‚Ä¶</div>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="view" id="viewProfile">
      <div class="profileTop">
        <p class="profileTitle">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</p>
        <button class="btn" id="btnUploadOpen">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
      </div>

      <div class="scroll" id="profileList">
        <div class="mutedBox">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </div>

  </div>

</div>

<!-- Upload sheet (modal bottom) -->
<div class="sheetBack" id="sheetBack">
  <div class="sheet">
    <div class="sheetHead">
      <p class="sheetTitle">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä—ã</p>
      <button class="sheetClose" id="sheetClose">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="sheetBody">
      <div class="pickGrid">
        <div class="pickBox" id="pickLeft">
          <p class="pickLabel">–§–æ—Ç–æ 1</p>
          <p class="pickHint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</p>
          <div class="pickPreview" id="prevLeft"><img alt="left preview"></div>
        </div>
        <div class="pickBox" id="pickRight">
          <p class="pickLabel">–§–æ—Ç–æ 2</p>
          <p class="pickHint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</p>
          <div class="pickPreview" id="prevRight"><img alt="right preview"></div>
        </div>
      </div>

      <input class="caption" id="captionInput" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />

      <button class="shareBtn" id="shareBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

      <input type="file" accept="image/*" id="fileLeft" style="display:none" />
      <input type="file" accept="image/*" id="fileRight" style="display:none" />
      <div class="tiny" id="uploadMsg" style="margin-top:10px;"></div>
    </div>
  </div>
</div>

<script>
/* ======================
   LookingGreat ‚Äî Index v2.6.0
   Changes:
   - –£–±—Ä–∞–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–ø—Ä–∞–≤–∞ –≤ –ª–µ–Ω—Ç–µ
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫ = caption, –∏–Ω–∞—á–µ "–ü–∞—Ä–∞ #N"
   - –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è, –ø–æ—Å–ª–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —É–±–∏—Ä–∞–µ—Ç—Å—è
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–ª–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ —Ñ—É—Ç–µ—Ä–µ: "üëç X –≥–æ–ª–æ—Å–æ–≤ ¬∑ A% / B%" (–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ —Ü–µ–ª–æ–≥–æ)
   - –í –ø—Ä–æ—Ñ–∏–ª–µ: "–ü–∞—Ä–∞ #N" + —Ç–∞ –∂–µ –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞; –ø—Ä–∏ 0 –≥–æ–ª–æ—Å–æ–≤: "–ü–æ–∫–∞ –Ω–µ—Ç –≥–æ–ª–æ—Å–æ–≤"
   ====================== */

const APP_VERSION = "2.6.0";

// –í–∞–∂–Ω–æ: —Ñ—Ä–æ–Ω—Ç –∏ backend –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –¥–æ–º–µ–Ω–∞—Ö ‚Äî –≤—Å–µ–≥–¥–∞ —è–≤–Ω—ã–π API_BASE
const API_BASE = "https://api.lookingreat.ru";

const $ = (id) => document.getElementById(id);

const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

// ---- Telegram init
function initTelegram() {
  try {
    if (tg) {
      tg.expand();
      if (typeof tg.disableVerticalSwipes === "function") tg.disableVerticalSwipes();
      tg.ready();
    }
  } catch (e) {}
}
initTelegram();

// ---- tg_id resolve
function getTgId() {
  // Prefer real Telegram initDataUnsafe
  try {
    const id = tg?.initDataUnsafe?.user?.id;
    if (id) return String(id);
  } catch(e) {}
  // Fallback: query param ?tg_id=...
  const u = new URL(location.href);
  const p = (u.searchParams.get("tg_id") || "").trim();
  if (p) return p;
  // Last fallback: stable test id for debugging
  return "531932411";
}

const TG_ID = getTgId();

$("subLine").textContent = `v${APP_VERSION} ‚Ä¢ TG_ID: ${TG_ID} ‚Ä¢ API: api.lookingreat.ru`;

// ---- Tabs
const tabFeed = $("tabFeed");
const tabProfile = $("tabProfile");
const viewFeed = $("viewFeed");
const viewProfile = $("viewProfile");

tabFeed.onclick = () => setView("feed");
tabProfile.onclick = () => setView("profile");

function setView(name){
  const isFeed = name === "feed";
  tabFeed.classList.toggle("active", isFeed);
  tabProfile.classList.toggle("active", !isFeed);
  viewFeed.classList.toggle("active", isFeed);
  viewProfile.classList.toggle("active", !isFeed);

  if (!isFeed) loadProfile();
}

// ---- Helpers
function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

function pctRound(n){
  return Math.round(Number(n || 0));
}

function statsText(item){
  // item is expected to contain vote stats in some shape.
  // We try multiple field names to stay compatible with existing Worker.
  const total =
    Number(item.total_votes ?? item.total ?? item.votes_total ?? item.votes ?? 0);

  if (!total) return "–ü–æ–∫–∞ –Ω–µ—Ç –≥–æ–ª–æ—Å–æ–≤";

  // percentages may be provided or we compute from counts
  let leftPct = item.left_percent ?? item.leftPct ?? item.percent_left ?? null;
  let rightPct = item.right_percent ?? item.rightPct ?? item.percent_right ?? null;

  const leftCount = Number(item.left_votes ?? item.left ?? item.votes_left ?? 0);
  const rightCount = Number(item.right_votes ?? item.right ?? item.votes_right ?? 0);

  if (leftPct == null || rightPct == null) {
    if (total > 0 && (leftCount + rightCount) > 0) {
      leftPct = (leftCount / total) * 100;
      rightPct = (rightCount / total) * 100;
    } else {
      leftPct = 0; rightPct = 0;
    }
  }

  return `üëç ${total} ${pluralVotes(total)} ¬∑ ${pctRound(leftPct)}% / ${pctRound(rightPct)}%`;
}

function pluralVotes(n){
  // —Ä—É—Å—Å–∫–æ–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è "–≥–æ–ª–æ—Å"
  n = Math.abs(Number(n)) || 0;
  const mod10 = n % 10;
  const mod100 = n % 100;
  if (mod10 === 1 && mod100 !== 11) return "–≥–æ–ª–æ—Å";
  if (mod10 >= 2 && mod10 <= 4 && !(mod100 >= 12 && mod100 <= 14)) return "–≥–æ–ª–æ—Å–∞";
  return "–≥–æ–ª–æ—Å–æ–≤";
}

function titleText(item, idx){
  const cap = (item.caption ?? item.text ?? item.title ?? "").trim();
  if (cap) return cap;
  const id = item.id ?? item.pair_id ?? item.photo_pair_id ?? (idx+1);
  return `–ü–∞—Ä–∞ #${id}`;
}

function getPhotoUrls(item){
  // feed may return keys or direct urls
  const leftUrl =
    item.photo_left_url ?? item.left_url ?? item.leftUrl ??
    (item.photo_left_key ? `${API_BASE}/r2/${encodeURIComponent(item.photo_left_key)}` : null);

  const rightUrl =
    item.photo_right_url ?? item.right_url ?? item.rightUrl ??
    (item.photo_right_key ? `${API_BASE}/r2/${encodeURIComponent(item.photo_right_key)}` : null);

  return { leftUrl, rightUrl };
}

// ---- API
async function apiGet(path){
  const r = await fetch(`${API_BASE}${path}`, { method:"GET" });
  const j = await r.json().catch(() => ({}));
  if (!r.ok || j.ok === false) throw j;
  return j;
}

async function apiPost(path, body){
  const r = await fetch(`${API_BASE}${path}`, {
    method:"POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  const j = await r.json().catch(() => ({}));
  if (!r.ok || j.ok === false) throw j;
  return j;
}

// ---- FEED rendering
let FEED_CACHE = [];

async function loadFeed(){
  const host = $("feedList");
  host.innerHTML = `<div class="mutedBox">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–µ–Ω—Ç—ã‚Ä¶</div>`;
  try {
    const j = await apiGet(`/feed?tg_id=${encodeURIComponent(TG_ID)}`);
    const items = j.items ?? j.feed ?? j.data ?? [];
    FEED_CACHE = Array.isArray(items) ? items : [];
    if (!FEED_CACHE.length){
      host.innerHTML = `<div class="mutedBox">–ü–æ–∫–∞ –Ω–µ—Ç –ø–∞—Ä. –ó–∞–π–¥–∏ –≤ ‚Äú–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å‚Äù –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ.</div>`;
      return;
    }
    host.innerHTML = FEED_CACHE.map((item, idx) => renderFeedCard(item, idx)).join("");
    wireFeedCards();
  } catch (e){
    host.innerHTML = `<div class="mutedBox">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–µ–Ω—Ç—É. –ü—Ä–æ–≤–µ—Ä—å Network –∏ Worker Logs.<br><br><span style="opacity:.8">${esc(e?.error || e?.message || JSON.stringify(e))}</span></div>`;
  }
}

function renderFeedCard(item, idx){
  const { leftUrl, rightUrl } = getPhotoUrls(item);
  const title = esc(titleText(item, idx));
  const hasChoice = !!(item.my_choice ?? item.myChoice);
  const hint = hasChoice ? "" : `<p class="cardHint">–ß—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å ‚Äî –Ω–∞–∂–º–∏ –Ω–∞ —Ñ–æ—Ç–æ</p>`;

  const footerVisible = hasChoice ? "visible" : "";
  const footerText = hasChoice ? esc(statsText(item)) : "";

  const id = item.id ?? item.pair_id ?? item.photo_pair_id ?? `idx${idx}`;
  const choice = String(item.my_choice ?? item.myChoice ?? "");

  return `
    <div class="card" data-pair="${esc(id)}" data-idx="${idx}">
      <div class="cardHead">
        <p class="cardTitle">${title}</p>
        ${hint}
      </div>

      <div class="photos">
        <div class="photoBtn ${choice==='left'?'selected':''} ${hasChoice?'disabled':''}" data-choice="left">
          ${leftUrl ? `<img loading="lazy" src="${esc(leftUrl)}" alt="–§–æ—Ç–æ 1">` : `<div class="tiny">–ù–µ—Ç —Ñ–æ—Ç–æ</div>`}
        </div>
        <div class="photoBtn ${choice==='right'?'selected':''} ${hasChoice?'disabled':''}" data-choice="right">
          ${rightUrl ? `<img loading="lazy" src="${esc(rightUrl)}" alt="–§–æ—Ç–æ 2">` : `<div class="tiny">–ù–µ—Ç —Ñ–æ—Ç–æ</div>`}
        </div>
      </div>

      <div class="cardFooter ${footerVisible}">${footerText}</div>
    </div>
  `;
}

function wireFeedCards(){
  const cards = document.querySelectorAll("#feedList .card");
  cards.forEach(card => {
    const idx = Number(card.getAttribute("data-idx"));
    const pairId = card.getAttribute("data-pair");

    const btns = card.querySelectorAll(".photoBtn");
    btns.forEach(btn => {
      btn.onclick = async () => {
        // if already voted - do nothing
        const item = FEED_CACHE[idx];
        if (!item) return;
        const already = !!(item.my_choice ?? item.myChoice);
        if (already) return;

        const choice = btn.getAttribute("data-choice"); // left/right
        await doVote(pairId, idx, choice, card);
      };
    });
  });
}

async function doVote(pairId, idx, choice, cardEl){
  // optimistic UI: disable clicks immediately
  cardEl.querySelectorAll(".photoBtn").forEach(b => b.classList.add("disabled"));

  try {
    const j = await apiPost("/vote", { tg_id: TG_ID, pair_id: Number(pairId) || pairId, choice });

    // Worker may return updated item or stats in different fields
    const updated =
      j.item ?? j.updated_item ?? j.pair ?? j.data ?? null;

    // Merge stats into cache item
    const cur = FEED_CACHE[idx] || {};
    const merged = updated ? { ...cur, ...updated } : { ...cur };

    // Ensure my_choice set
    merged.my_choice = choice;

    // If server returned stats separately:
    if (j.stats && typeof j.stats === "object") {
      Object.assign(merged, j.stats);
    }

    FEED_CACHE[idx] = merged;

    // Update UI: highlight selection, remove hint, show footer
    const leftBtn = cardEl.querySelector('.photoBtn[data-choice="left"]');
    const rightBtn = cardEl.querySelector('.photoBtn[data-choice="right"]');

    leftBtn.classList.toggle("selected", choice === "left");
    rightBtn.classList.toggle("selected", choice === "right");

    // Remove hint line (2nd line)
    const hint = cardEl.querySelector(".cardHint");
    if (hint) hint.remove();

    // Footer
    const footer = cardEl.querySelector(".cardFooter");
    footer.classList.add("visible");
    footer.textContent = statsText(merged);

  } catch (e){
    // Restore clickability on error (only if not voted)
    cardEl.querySelectorAll(".photoBtn").forEach(b => b.classList.remove("disabled"));

    const err = (e && (e.error || e.message)) ? (e.error || e.message) : JSON.stringify(e);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å. –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ç—å –∏ –ª–æ–≥–∏.\n\n" + err);
  }
}

// ---- PROFILE
let PROFILE_CACHE = [];

async function loadProfile(){
  const host = $("profileList");
  host.innerHTML = `<div class="mutedBox">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>`;
  try {
    const j = await apiGet(`/my_pairs?tg_id=${encodeURIComponent(TG_ID)}`);
    const items = j.items ?? j.pairs ?? j.data ?? [];
    PROFILE_CACHE = Array.isArray(items) ? items : [];

    if (!PROFILE_CACHE.length){
      host.innerHTML = `<div class="mutedBox">–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–∞—Ä. –ù–∞–∂–º–∏ ‚Äú–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ‚Äù.</div>`;
      return;
    }

    host.innerHTML = PROFILE_CACHE.map((item, idx) => renderProfileCard(item, idx)).join("");
    wireProfileShare();
  } catch (e){
    host.innerHTML = `<div class="mutedBox">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å. –ü—Ä–æ–≤–µ—Ä—å Network –∏ Worker Logs.<br><br><span style="opacity:.8">${esc(e?.error || e?.message || JSON.stringify(e))}</span></div>`;
  }
}

function renderProfileCard(item, idx){
  const { leftUrl, rightUrl } = getPhotoUrls(item);
  const id = item.id ?? item.pair_id ?? item.photo_pair_id ?? (idx+1);

  const total =
    Number(item.total_votes ?? item.total ?? item.votes_total ?? item.votes ?? 0);

  let statLine = "";
  if (!total) statLine = "–ü–æ–∫–∞ –Ω–µ—Ç –≥–æ–ª–æ—Å–æ–≤";
  else statLine = statsText(item);

  return `
    <div class="card" data-pair="${esc(id)}" data-idx="${idx}">
      <div class="cardHead">
        <p class="cardTitle">–ü–∞—Ä–∞ #${esc(id)}</p>
        <p class="cardHint">${esc(statLine)}</p>
      </div>

      <div class="photos">
        <div class="photoBtn disabled">
          ${leftUrl ? `<img loading="lazy" src="${esc(leftUrl)}" alt="–§–æ—Ç–æ 1">` : `<div class="tiny">–ù–µ—Ç —Ñ–æ—Ç–æ</div>`}
        </div>
        <div class="photoBtn disabled">
          ${rightUrl ? `<img loading="lazy" src="${esc(rightUrl)}" alt="–§–æ—Ç–æ 2">` : `<div class="tiny">–ù–µ—Ç —Ñ–æ—Ç–æ</div>`}
        </div>
      </div>

      <div class="cardFooter visible">
        <button class="btn" data-share="1" style="width:100%;">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
      </div>
    </div>
  `;
}

function wireProfileShare(){
  document.querySelectorAll('#profileList [data-share="1"]').forEach(btn => {
    btn.onclick = () => {
      try{
        const card = btn.closest(".card");
        const pairId = card?.getAttribute("data-pair") || "";
        const shareUrl = `https://lookingreat.ru/?pair=${encodeURIComponent(pairId)}`;
        if (tg && typeof tg.openTelegramLink === "function") {
          // open share dialog (simple link copy behavior is okay too)
          tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(shareUrl)}`);
        } else {
          navigator.clipboard?.writeText(shareUrl);
          alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞:\n" + shareUrl);
        }
      } catch(e){
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è.");
      }
    };
  });
}

// ---- Upload modal (ETALON)
const sheetBack = $("sheetBack");
const sheetClose = $("sheetClose");
const btnUploadOpen = $("btnUploadOpen");
const pickLeft = $("pickLeft");
const pickRight = $("pickRight");
const fileLeft = $("fileLeft");
const fileRight = $("fileRight");
const prevLeft = $("prevLeft").querySelector("img");
const prevRight = $("prevRight").querySelector("img");
const captionInput = $("captionInput");
const shareBtn = $("shareBtn");
const uploadMsg = $("uploadMsg");

let uploadLeftFile = null;
let uploadRightFile = null;

function openSheet(){
  uploadMsg.textContent = "";
  sheetBack.classList.add("open");
}
function closeSheet(){
  sheetBack.classList.remove("open");
}
btnUploadOpen.onclick = openSheet;
sheetClose.onclick = closeSheet;
sheetBack.onclick = (e) => { if (e.target === sheetBack) closeSheet(); };

pickLeft.onclick = () => fileLeft.click();
pickRight.onclick = () => fileRight.click();

fileLeft.onchange = () => {
  const f = fileLeft.files && fileLeft.files[0];
  if (!f) return;
  uploadLeftFile = f;
  const url = URL.createObjectURL(f);
  prevLeft.src = url;
  pickLeft.classList.add("hasImg");
  updateShareEnabled();
};

fileRight.onchange = () => {
  const f = fileRight.files && fileRight.files[0];
  if (!f) return;
  uploadRightFile = f;
  const url = URL.createObjectURL(f);
  prevRight.src = url;
  pickRight.classList.add("hasImg");
  updateShareEnabled();
};

function updateShareEnabled(){
  shareBtn.disabled = !(uploadLeftFile && uploadRightFile);
}

shareBtn.onclick = async () => {
  if (!(uploadLeftFile && uploadRightFile)) return;

  shareBtn.disabled = true;
  uploadMsg.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

  try {
    const fd = new FormData();
    fd.append("tg_id", TG_ID);
    fd.append("left", uploadLeftFile);
    fd.append("right", uploadRightFile);
    fd.append("caption", captionInput.value || "");

    const r = await fetch(`${API_BASE}/upload_pair`, { method:"POST", body: fd });
    const j = await r.json().catch(() => ({}));
    if (!r.ok || j.ok === false) throw j;

    uploadMsg.textContent = "–ì–æ—Ç–æ–≤–æ ‚úÖ";
    // ETALON: –∑–∞–¥–µ—Ä–∂–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è 900ms
    setTimeout(() => {
      closeSheet();
      // reset
      uploadLeftFile = null; uploadRightFile = null;
      fileLeft.value = ""; fileRight.value = "";
      captionInput.value = "";
      pickLeft.classList.remove("hasImg");
      pickRight.classList.remove("hasImg");
      updateShareEnabled();
      // reload profile and feed
      loadProfile();
      loadFeed();
    }, 900);

  } catch(e){
    uploadMsg.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å Worker Logs / Network.";
    const err = (e && (e.error || e.message)) ? (e.error || e.message) : JSON.stringify(e);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å.\n\n" + err);
    shareBtn.disabled = false;
  }
};

// ---- start
loadFeed();
</script>

</body>
</html>
