<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LookingGreat</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* { box-sizing: border-box; }

html, body {
  margin: 0;
  padding: 0;
  height: 100dvh;
  overflow: hidden;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: #ffffff;
  color: #111;
}

.app { height: 100%; display: flex; flex-direction: column; }

.tabs { display:flex; gap:8px; padding:12px; }
.tab {
  flex:1;
  padding:10px;
  border-radius:12px;
  border:1px solid #eee;
  background:#f5f5f5;
  text-align:center;
  font-weight:800;
  cursor:pointer;
  user-select:none;
}
.tab.active { background:#111; color:#fff; border-color:#111; }

.content { flex:1; display:flex; flex-direction:column; padding:12px; min-height:0; }
.hidden { display:none !important; }

.controls { padding-top:12px; }
button {
  width:100%;
  padding:14px;
  border-radius:14px;
  border:none;
  font-size:16px;
  font-weight:900;
  cursor:pointer;
}
.primary { background:#111; color:#fff; }
.primary:disabled { background:#d9d9d9; color:#666; cursor:default; }
.secondary { background:#eee; margin-top:8px; font-weight:900; }

.status { text-align:center; font-size:14px; padding-top:6px; color:#333; min-height:18px; }

/* Vote */
.vote-wrap { flex:1; min-height:0; position:relative; }
.vote-grid {
  flex:1;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  min-height:0;
}
.vote-img {
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:16px;
  cursor:pointer;

  opacity:1;
  transition: opacity 180ms ease, filter 180ms ease, transform 180ms ease;
  will-change: opacity, filter, transform;
}
.vote-img.fading { opacity:0; }
.vote-grid.loading .vote-img { filter: blur(2px); opacity:0.6; }

.overlay {
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  padding:18px;
  pointer-events:none;
}
.overlay-card {
  background: rgba(17,17,17,0.88);
  color:#fff;
  padding:14px 16px;
  border-radius:14px;
  font-weight:900;
  text-align:center;
  max-width:340px;
  width:100%;
}
.overlay-sub { margin-top:6px; font-size:13px; font-weight:700; opacity:0.85; }

/* Heart */
.heart {
  position:absolute;
  left:50%; top:50%;
  transform: translate(-50%, -50%) scale(0.8);
  font-size:58px;
  opacity:0;
  pointer-events:none;
  transition: opacity 220ms ease, transform 220ms ease;
  filter: drop-shadow(0 10px 24px rgba(0,0,0,0.25));
}
.heart.show {
  opacity:1;
  transform: translate(-50%, -50%) scale(1);
}
.heart.hide {
  opacity:0;
  transform: translate(-50%, -50%) scale(0.9);
}

/* Upload */
.upload-grid {
  flex:1;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  min-height:0;
}
.upload-card {
  border:2px dashed #ccc;
  border-radius:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  text-align:center;
  cursor:pointer;
  overflow:hidden;
  padding:12px;
  line-height:1.15;
  background:#fafafa;
}
.upload-card img { width:100%; height:100%; object-fit:cover; }

/* My pairs */
.my-wrap { flex:1; min-height:0; display:flex; flex-direction:column; gap:10px; }
.my-summary {
  border:1px solid #eee;
  border-radius:14px;
  padding:12px;
  background:#fafafa;
}
.my-summary .title { font-weight:900; margin-bottom:6px; }
.my-summary .row { display:flex; justify-content:space-between; font-weight:800; font-size:14px; padding:4px 0; }

.my-list { flex:1; min-height:0; overflow:auto; padding-bottom:6px; }
.pair-card {
  border:1px solid #eee;
  border-radius:16px;
  padding:10px;
  margin-bottom:10px;
  background:#fff;
}
.pair-top { display:flex; justify-content:space-between; align-items:center; gap:10px; }
.pair-top .meta { font-size:13px; font-weight:900; color:#111; }
.pair-top .sub { font-size:12px; color:#666; font-weight:800; margin-top:2px; }

.del-btn {
  border:none;
  background:#eee;
  border-radius:12px;
  padding:10px 12px;
  font-weight:900;
  cursor:pointer;
}

.pair-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
.pair-imgwrap { position:relative; border-radius:14px; overflow:hidden; }
.pair-imgwrap img { width:100%; height:160px; object-fit:cover; display:block; }
.badge {
  position:absolute;
  left:10px; top:10px;
  background: rgba(17,17,17,0.86);
  color:#fff;
  border-radius:999px;
  padding:6px 10px;
  font-weight:900;
  font-size:12px;
}
.badge.win { background: rgba(0,0,0,0.88); }
.badge.draw { background: rgba(17,17,17,0.72); }
.bar {
  margin-top:10px;
  height:10px;
  border-radius:999px;
  background:#eee;
  overflow:hidden;
  display:flex;
}
.bar .left { height:100%; background:#111; width:50%; }
.bar .right { height:100%; background:#bbb; width:50%; }
.pair-stats {
  display:flex;
  justify-content:space-between;
  font-weight:900;
  font-size:13px;
  margin-top:8px;
}

/* Admin */
.admin-wrap { flex:1; min-height:0; display:flex; flex-direction:column; gap:10px; }
.admin-box {
  border:1px solid #eee;
  border-radius:14px;
  padding:12px;
  background:#fafafa;
}
.admin-box .title { font-weight:900; margin-bottom:6px; }
.admin-box .row { display:flex; justify-content:space-between; font-weight:800; font-size:14px; padding:4px 0; }
.admin-list { flex:1; min-height:0; overflow:auto; padding-bottom:6px; }
.admin-pair { border:1px solid #eee; border-radius:16px; padding:10px; margin-bottom:10px; background:#fff; }
.admin-actions { display:flex; gap:8px; margin-top:10px; }
.admin-actions button { width:auto; flex:1; padding:12px; border-radius:12px; font-size:14px; }

</style>
</head>

<body>
<div class="app">

  <div class="tabs" id="tabs">
    <div class="tab active" id="tabVote">–õ–µ–Ω—Ç–∞</div>
    <div class="tab" id="tabUpload">–ó–∞–≥—Ä—É–∑–∫–∞</div>
    <div class="tab" id="tabMy">–ú–æ–∏ –ø–∞—Ä—ã</div>
    <div class="tab hidden" id="tabAdmin">–ê–¥–º–∏–Ω</div>
  </div>

  <div class="content">

    <!-- VOTE -->
    <div class="vote-wrap" id="voteWrap">
      <div id="voteScreen" class="vote-grid">
        <div style="position:relative;">
          <img id="leftImg" class="vote-img" />
          <div id="heartLeft" class="heart">‚ù§Ô∏è</div>
        </div>
        <div style="position:relative;">
          <img id="rightImg" class="vote-img" />
          <div id="heartRight" class="heart">‚ù§Ô∏è</div>
        </div>
      </div>

      <div id="emptyOverlay" class="overlay hidden">
        <div class="overlay-card">
          –ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤—ã—Ö –ø–∞—Ä
          <div class="overlay-sub">–ó–∞–≥—Ä—É–∑–∏ —Å–≤–æ—é ‚Äî –∏ –µ—ë —É–≤–∏–¥—è—Ç –¥—Ä—É–≥–∏–µ</div>
        </div>
      </div>
    </div>

    <!-- UPLOAD -->
    <div id="uploadScreen" class="upload-grid hidden">
      <div class="upload-card" id="cardLeft">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 1</div>
      <div class="upload-card" id="cardRight">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 2</div>
    </div>

    <!-- MY -->
    <div id="myScreen" class="my-wrap hidden">
      <div class="my-summary" id="mySummary">
        <div class="title">–í–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
        <div class="row"><span>–ü–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–æ</span><span id="sumPairs">‚Äî</span></div>
        <div class="row"><span>–í—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤</span><span id="sumVotes">‚Äî</span></div>
        <div class="row"><span>–°—Ä–µ–¥–Ω–∏–π –ª—É—á—à–∏–π %</span><span id="sumAvg">‚Äî</span></div>
        <div class="row"><span>–õ—É—á—à–∞—è –ø–∞—Ä–∞</span><span id="sumBest">‚Äî</span></div>
      </div>
      <div class="my-list" id="myList"></div>
    </div>

    <!-- ADMIN -->
    <div id="adminScreen" class="admin-wrap hidden">
      <div class="admin-box">
        <div class="title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        <div class="row"><span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤—Å–µ–≥–æ</span><span id="aUsersTotal">‚Äî</span></div>
        <div class="row"><span>–ù–æ–≤—ã–µ —Å–µ–≥–æ–¥–Ω—è</span><span id="aUsersToday">‚Äî</span></div>
        <div class="row"><span>–ù–æ–≤—ã–µ –∑–∞ –º–µ—Å—è—Ü</span><span id="aUsersMonth">‚Äî</span></div>
        <div class="row"><span>–ü–∞—Ä –≤—Å–µ–≥–æ</span><span id="aPairsTotal">‚Äî</span></div>
        <div class="row"><span>–ì–æ–ª–æ—Å–æ–≤ –≤—Å–µ–≥–æ</span><span id="aVotesTotal">‚Äî</span></div>
        <div class="row"><span>–ó–∞–±–∞–Ω–µ–Ω–æ</span><span id="aBannedTotal">‚Äî</span></div>
      </div>

      <div class="admin-list" id="adminList"></div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
      <button id="skipBtn" class="primary">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
      <button id="sendBtn" class="primary hidden">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ä—É</button>
      <button id="clearBtn" class="secondary hidden">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <div class="status" id="status"></div>
    </div>

  </div>
</div>

<input type="file" id="fileLeft" accept="image/*" class="hidden">
<input type="file" id="fileRight" accept="image/*" class="hidden">

<script>
const tg = window.Telegram.WebApp;
try { tg.ready(); } catch(e) {}
try { tg.expand(); } catch(e) {}
try { tg.disableVerticalSwipes?.(); } catch(e) {}

const API_BASE = "https://api.lookingreat.ru";

// ‚úÖ –í–ü–ò–®–ò –¢–ï –ñ–ï tg_id, —á—Ç–æ –∏ –≤ Worker
const ADMIN_IDS = ["123", "456"];

let tg_id = tg.initDataUnsafe?.user?.id || "0";
const isAdmin = ADMIN_IDS.includes(String(tg_id));

let currentPair = null;
let loadingFeed = false;
let votingLock = false;
let emptyPollTimer = null;
let myPollTimer = null;
let adminPollTimer = null;

let leftFile = null;
let rightFile = null;

let noPairsMode = false;

const tabVote = document.getElementById("tabVote");
const tabUpload = document.getElementById("tabUpload");
const tabMy = document.getElementById("tabMy");
const tabAdmin = document.getElementById("tabAdmin");

const voteWrap = document.getElementById("voteWrap");
const voteScreen = document.getElementById("voteScreen");
const uploadScreen = document.getElementById("uploadScreen");
const myScreen = document.getElementById("myScreen");
const adminScreen = document.getElementById("adminScreen");

const emptyOverlay = document.getElementById("emptyOverlay");

const leftImg = document.getElementById("leftImg");
const rightImg = document.getElementById("rightImg");
const heartLeft = document.getElementById("heartLeft");
const heartRight = document.getElementById("heartRight");

const skipBtn = document.getElementById("skipBtn");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");

const fileLeft = document.getElementById("fileLeft");
const fileRight = document.getElementById("fileRight");
const cardLeft = document.getElementById("cardLeft");
const cardRight = document.getElementById("cardRight");

const statusEl = document.getElementById("status");
function setStatus(t){ statusEl.textContent = t || ""; }

function stopAllTimers() {
  if (emptyPollTimer) { clearInterval(emptyPollTimer); emptyPollTimer = null; }
  if (myPollTimer) { clearInterval(myPollTimer); myPollTimer = null; }
  if (adminPollTimer) { clearInterval(adminPollTimer); adminPollTimer = null; }
}

function setNoPairsUI(on) {
  noPairsMode = !!on;
  if (on) {
    skipBtn.disabled = true;
    skipBtn.textContent = "–ñ–¥—ë–º –Ω–æ–≤—ã–µ –ø–∞—Ä—ã‚Ä¶";
  } else {
    skipBtn.disabled = false;
    skipBtn.textContent = "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å";
  }
}

function switchTab(mode) {
  stopAllTimers();
  setStatus("");

  tabVote.classList.remove("active");
  tabUpload.classList.remove("active");
  tabMy.classList.remove("active");
  tabAdmin.classList.remove("active");

  voteWrap.classList.add("hidden");
  uploadScreen.classList.add("hidden");
  myScreen.classList.add("hidden");
  adminScreen.classList.add("hidden");

  skipBtn.classList.add("hidden");
  sendBtn.classList.add("hidden");
  clearBtn.classList.add("hidden");

  emptyOverlay.classList.add("hidden");

  if (mode === "vote") {
    tabVote.classList.add("active");
    voteWrap.classList.remove("hidden");
    skipBtn.classList.remove("hidden");
    setNoPairsUI(false);
    loadNext(false);
  } else if (mode === "upload") {
    tabUpload.classList.add("active");
    uploadScreen.classList.remove("hidden");
    sendBtn.classList.remove("hidden");
    clearBtn.classList.remove("hidden");
  } else if (mode === "my") {
    tabMy.classList.add("active");
    myScreen.classList.remove("hidden");
    loadMyPairs(true);
    myPollTimer = setInterval(() => loadMyPairs(false), 5000);
  } else if (mode === "admin") {
    tabAdmin.classList.add("active");
    adminScreen.classList.remove("hidden");
    loadAdmin(true);
    adminPollTimer = setInterval(() => loadAdmin(false), 7000);
  }
}

tabVote.onclick = () => switchTab("vote");
tabUpload.onclick = () => switchTab("upload");
tabMy.onclick = () => switchTab("my");

if (isAdmin) {
  tabAdmin.classList.remove("hidden");
  tabAdmin.onclick = () => switchTab("admin");
}

/* ===== Vote flow ===== */

function preloadImage(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(true);
    img.onerror = reject;
    img.src = url;
  });
}

async function fadeSwapPair(item) {
  if (!item?.left_url || !item?.right_url) return false;

  function cleanup() {
    leftImg.classList.remove("fading");
    rightImg.classList.remove("fading");
    voteScreen.classList.remove("loading");
  }

  voteScreen.classList.add("loading");
  try {
    await Promise.all([ preloadImage(item.left_url), preloadImage(item.right_url) ]);
  } catch (e) {
    cleanup();
    // –µ—Å–ª–∏ –ø—É—Å—Ç–∞—è –ª–µ–Ω—Ç–∞ ‚Äî –Ω–µ –¥—ë—Ä–≥–∞–µ–º —Å—Ç–∞—Ç—É—Å
    if (!noPairsMode) setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—é‚Ä¶");
    setTimeout(() => loadNext(true), 200);
    return false;
  }

  leftImg.classList.add("fading");
  rightImg.classList.add("fading");
  await new Promise(r => setTimeout(r, 180));

  leftImg.src = item.left_url;
  rightImg.src = item.right_url;

  try {
    if (leftImg.decode) await leftImg.decode();
    if (rightImg.decode) await rightImg.decode();
  } catch(e) {}

  if (leftImg.naturalWidth === 0 || rightImg.naturalWidth === 0) {
    cleanup();
    if (!noPairsMode) setStatus("–§–æ—Ç–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–æ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—é‚Ä¶");
    setTimeout(() => loadNext(true), 200);
    return false;
  }

  leftImg.classList.remove("fading");
  rightImg.classList.remove("fading");
  voteScreen.classList.remove("loading");
  return true;
}

// silent=true => –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ó–∞–≥—Ä—É–∑–∫–∞..." (–Ω—É–∂–Ω–æ –¥–ª—è –∞–≤—Ç–æ-–ø—É–ª–∞, —á—Ç–æ–±—ã –Ω–µ –ø—Ä—ã–≥–∞–ª UI)
async function loadNext(silent) {
  if (loadingFeed) return;
  loadingFeed = true;

  try {
    if (!silent && !noPairsMode) setStatus("–ó–∞–≥—Ä—É–∑–∫–∞...");

    const res = await fetch(`${API_BASE}/feed?tg_id=${encodeURIComponent(tg_id)}`);
    const data = await res.json().catch(() => null);

    // banned
    if (!res.ok && data?.error === "banned") {
      setStatus("–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω");
      setNoPairsUI(true);
      emptyOverlay.classList.remove("hidden");
      return;
    }

    if (!data?.item) {
      setStatus("");
      emptyOverlay.classList.remove("hidden");
      setNoPairsUI(true);

      if (!emptyPollTimer) {
        emptyPollTimer = setInterval(() => {
          if (!voteWrap.classList.contains("hidden")) loadNext(true);
        }, 3500);
      }
      return;
    }

    // –ø–æ—è–≤–∏–ª–∞—Å—å –ø–∞—Ä–∞ ‚Äî –≤—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º "–Ω–µ—Ç –ø–∞—Ä"
    if (emptyPollTimer) { clearInterval(emptyPollTimer); emptyPollTimer = null; }
    emptyOverlay.classList.add("hidden");
    setNoPairsUI(false);

    currentPair = data.item;
    const ok = await fadeSwapPair(currentPair);
    if (ok === false) return;

    setStatus("");

  } catch(e) {
    if (!silent) setStatus("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
  } finally {
    loadingFeed = false;
  }
}

function popHeart(side) {
  const el = (side === "left") ? heartLeft : heartRight;
  el.classList.remove("hide");
  el.classList.add("show");
  setTimeout(() => {
    el.classList.remove("show");
    el.classList.add("hide");
  }, 420);
}

async function vote(choice) {
  if (!currentPair) return;
  if (votingLock) return;
  votingLock = true;

  // —ç—Ñ—Ñ–µ–∫—Ç –∫–∞–∫ –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö
  popHeart(choice);

  // —Å–ª–µ–≥–∫–∞ "–ø—Ä–∏–≥–ª—É—à–∞–µ–º" –≤—Ç–æ—Ä–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –Ω–∞ –º–æ–º–µ–Ω—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞
  if (choice === "left") rightImg.style.filter = "brightness(0.8)";
  if (choice === "right") leftImg.style.filter = "brightness(0.8)";

  try {
    const res = await fetch(`${API_BASE}/vote`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ tg_id, pair_id: currentPair.id, choice })
    });

    const data = await res.json().catch(() => null);

    if (!res.ok) {
      const err = data?.error || "vote_failed";
      if (err === "cannot_vote_own_pair") setStatus("–ù–µ–ª—å–∑—è –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –∑–∞ —Å–≤–æ—é –ø–∞—Ä—É");
      else if (err === "already_voted") setStatus("–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ —ç—Ç—É –ø–∞—Ä—É");
      else if (err === "banned") setStatus("–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω");
      else setStatus("–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è");
      return;
    }

    // –±—ã—Å—Ç—Ä–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –ø–∞—Ä—É
    setTimeout(() => loadNext(true), 260);

  } finally {
    setTimeout(() => {
      votingLock = false;
      leftImg.style.filter = "";
      rightImg.style.filter = "";
    }, 520);
  }
}

leftImg.onclick = () => vote("left");
rightImg.onclick = () => vote("right");
skipBtn.onclick = () => loadNext(false);

/* ===== Upload flow ===== */

cardLeft.onclick = () => fileLeft.click();
cardRight.onclick = () => fileRight.click();

fileLeft.onchange = () => {
  leftFile = fileLeft.files[0] || null;
  if (leftFile) previewImage(leftFile, cardLeft);
};
fileRight.onchange = () => {
  rightFile = fileRight.files[0] || null;
  if (rightFile) previewImage(rightFile, cardRight);
};

function previewImage(file, card) {
  const reader = new FileReader();
  reader.onload = e => { card.innerHTML = `<img src="${e.target.result}">`; };
  reader.readAsDataURL(file);
}

function clearUpload() {
  leftFile = null;
  rightFile = null;
  fileLeft.value = "";
  fileRight.value = "";
  cardLeft.innerHTML = "–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 1";
  cardRight.innerHTML = "–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 2";
  setStatus("");
}
clearBtn.onclick = clearUpload;

sendBtn.onclick = async () => {
  if (!leftFile || !rightFile) { setStatus("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ —Ñ–æ—Ç–æ"); return; }

  setStatus("–û—Ç–ø—Ä–∞–≤–∫–∞...");
  const form = new FormData();
  form.append("tg_id", tg_id);
  form.append("left", leftFile);
  form.append("right", rightFile);

  const res = await fetch(`${API_BASE}/upload_pair`, { method:"POST", body: form });
  const data = await res.json().catch(()=>null);

  if (!res.ok || !data?.ok) {
    if (data?.error === "banned") setStatus("–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω");
    else setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
    return;
  }

  setStatus("–ü–∞—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ ‚úÖ");
  clearUpload();
  setTimeout(() => switchTab("my"), 450);
};

/* ===== My pairs ===== */

const myList = document.getElementById("myList");
const sumPairs = document.getElementById("sumPairs");
const sumVotes = document.getElementById("sumVotes");
const sumAvg = document.getElementById("sumAvg");
const sumBest = document.getElementById("sumBest");

function fmtTs(ts) {
  const d = new Date(Number(ts) * 1000);
  return d.toLocaleString("ru-RU", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
}

function renderSummary(profile) {
  sumPairs.textContent = profile?.pairs_total ?? "‚Äî";
  sumVotes.textContent = profile?.votes_total ?? "‚Äî";
  sumAvg.textContent = (profile?.avg_best_pct == null) ? "‚Äî" : (profile.avg_best_pct + "%");
  sumBest.textContent = (profile?.best_pair_id == null) ? "‚Äî" : (`#${profile.best_pair_id} ¬∑ ${profile.best_pair_pct}%`);
}

function badgeText(stats) {
  if (!stats.total) return { cls:"draw" };
  if (stats.winner === "draw") return { cls:"draw" };
  return { cls:"win" };
}

function renderPairs(pairs) {
  if (!pairs?.length) {
    myList.innerHTML = `<div class="pair-card"><div class="pair-top"><div class="meta">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–∞—Ä</div></div></div>`;
    return;
  }

  myList.innerHTML = pairs.map(p => {
    const s = p.stats || {left:0,right:0,total:0,left_pct:0,right_pct:0,winner:null};
    const b = badgeText(s);

    const leftWinner = (s.winner === "left");
    const rightWinner = (s.winner === "right");

    const leftLabel = s.total ? `${s.left_pct}%` : "‚Äî";
    const rightLabel = s.total ? `${s.right_pct}%` : "‚Äî";

    const leftW = Math.max(0, Math.min(100, s.left_pct || 0));
    const rightW = 100 - leftW;

    return `
      <div class="pair-card" data-pair-id="${p.id}">
        <div class="pair-top">
          <div>
            <div class="meta">–ü–∞—Ä–∞ #${p.id}</div>
            <div class="sub">${fmtTs(p.created_at)}</div>
          </div>
          <button class="del-btn" data-del="${p.id}">–£–¥–∞–ª–∏—Ç—å</button>
        </div>

        <div class="pair-grid">
          <div class="pair-imgwrap">
            <img src="${p.left_url}" alt="">
            <div class="badge ${leftWinner ? 'win' : b.cls}">
              ${leftWinner ? 'üëë ' : ''}${leftLabel} ¬∑ ${s.left}
            </div>
          </div>
          <div class="pair-imgwrap">
            <img src="${p.right_url}" alt="">
            <div class="badge ${rightWinner ? 'win' : b.cls}">
              ${rightWinner ? 'üëë ' : ''}${rightLabel} ¬∑ ${s.right}
            </div>
          </div>
        </div>

        <div class="bar">
          <div class="left" style="width:${leftW}%;"></div>
          <div class="right" style="width:${rightW}%;"></div>
        </div>

        <div class="pair-stats">
          <span>–õ–µ–≤–æ–µ ${s.left}</span>
          <span>–í—Å–µ–≥–æ ${s.total}</span>
          <span>–ü—Ä–∞–≤–æ–µ ${s.right}</span>
        </div>
      </div>
    `;
  }).join("");

  myList.querySelectorAll("[data-del]").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute("data-del");
      if (!id) return;
      const ok = confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–∞—Ä—É? –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –ø–æ –Ω–µ–π –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è.");
      if (!ok) return;

      try {
        setStatus("–£–¥–∞–ª—è—é...");
        const res = await fetch(`${API_BASE}/pair?id=${encodeURIComponent(id)}&tg_id=${encodeURIComponent(tg_id)}`, { method:"DELETE" });
        const data = await res.json().catch(()=>null);
        if (!res.ok || !data?.ok) { setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å"); return; }
        setStatus("");
        loadMyPairs(true);
      } catch(e) {
        setStatus("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
      }
    };
  });
}

async function loadMyPairs(showLoading) {
  try {
    if (showLoading) setStatus("–ó–∞–≥—Ä—É–∑–∫–∞...");
    const res = await fetch(`${API_BASE}/my_pairs?tg_id=${encodeURIComponent(tg_id)}`);
    const data = await res.json().catch(()=>null);

    if (!res.ok && data?.error === "banned") {
      setStatus("–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω");
      return;
    }
    if (!res.ok || !data?.ok) { setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å"); return; }

    renderSummary(data.profile);
    renderPairs(data.pairs);
    if (showLoading) setStatus("");

  } catch(e) {
    setStatus("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
  }
}

/* ===== Admin ===== */

const aUsersTotal = document.getElementById("aUsersTotal");
const aUsersToday = document.getElementById("aUsersToday");
const aUsersMonth = document.getElementById("aUsersMonth");
const aPairsTotal = document.getElementById("aPairsTotal");
const aVotesTotal = document.getElementById("aVotesTotal");
const aBannedTotal = document.getElementById("aBannedTotal");
const adminList = document.getElementById("adminList");

function renderAdminStats(s) {
  aUsersTotal.textContent = s?.users?.total ?? "‚Äî";
  aUsersToday.textContent = s?.users?.new_today ?? "‚Äî";
  aUsersMonth.textContent = s?.users?.new_this_month ?? "‚Äî";
  aPairsTotal.textContent = s?.content?.pairs_total ?? "‚Äî";
  aVotesTotal.textContent = s?.content?.votes_total ?? "‚Äî";
  aBannedTotal.textContent = s?.content?.banned_total ?? "‚Äî";
}

function renderAdminPairs(pairs) {
  if (!pairs?.length) {
    adminList.innerHTML = `<div class="admin-pair"><div style="font-weight:900;">–ù–µ—Ç –ø–∞—Ä</div></div>`;
    return;
  }

  adminList.innerHTML = pairs.map(p => {
    const owner = p.owner_telegram_id;
    return `
      <div class="admin-pair">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
          <div>
            <div style="font-weight:900;">–ü–∞—Ä–∞ #${p.id}</div>
            <div style="font-size:12px; font-weight:800; color:#666;">–í–ª–∞–¥–µ–ª–µ—Ü: ${owner} ¬∑ –ì–æ–ª–æ—Å–∞: ${p.stats.total}</div>
          </div>
        </div>
        <div class="pair-grid" style="margin-top:10px;">
          <div class="pair-imgwrap"><img src="${p.left_url}" alt=""></div>
          <div class="pair-imgwrap"><img src="${p.right_url}" alt=""></div>
        </div>
        <div class="admin-actions">
          <button class="secondary" data-delpair="${p.id}">–£–¥–∞–ª–∏—Ç—å</button>
          <button class="secondary" data-ban="${owner}">–ë–∞–Ω</button>
          <button class="secondary" data-unban="${owner}">–†–∞–∑–±–∞–Ω</button>
        </div>
      </div>
    `;
  }).join("");

  adminList.querySelectorAll("[data-delpair]").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute("data-delpair");
      if (!id) return;
      const ok = confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–∞—Ä—É?");
      if (!ok) return;
      setStatus("–£–¥–∞–ª—è—é...");
      const res = await fetch(`${API_BASE}/admin/pair?id=${encodeURIComponent(id)}&tg_id=${encodeURIComponent(tg_id)}`, { method:"DELETE" });
      const data = await res.json().catch(()=>null);
      if (!res.ok || !data?.ok) { setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å"); return; }
      setStatus("");
      loadAdmin(true);
    };
  });

  adminList.querySelectorAll("[data-ban]").forEach(btn => {
    btn.onclick = async () => {
      const user = btn.getAttribute("data-ban");
      if (!user) return;
      const ok = confirm(`–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user}?`);
      if (!ok) return;
      setStatus("–ë–∞–Ω...");
      const res = await fetch(`${API_BASE}/admin/ban`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ tg_id, user_tg_id: user })
      });
      const data = await res.json().catch(()=>null);
      if (!res.ok || !data?.ok) { setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å"); return; }
      setStatus("");
      loadAdmin(true);
    };
  });

  adminList.querySelectorAll("[data-unban]").forEach(btn => {
    btn.onclick = async () => {
      const user = btn.getAttribute("data-unban");
      if (!user) return;
      setStatus("–†–∞–∑–±–∞–Ω...");
      const res = await fetch(`${API_BASE}/admin/unban`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ tg_id, user_tg_id: user })
      });
      const data = await res.json().catch(()=>null);
      if (!res.ok || !data?.ok) { setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å"); return; }
      setStatus("");
      loadAdmin(true);
    };
  });
}

async function loadAdmin(showLoading) {
  if (!isAdmin) return;
  try {
    if (showLoading) setStatus("–ó–∞–≥—Ä—É–∑–∫–∞...");

    const sRes = await fetch(`${API_BASE}/admin/stats?tg_id=${encodeURIComponent(tg_id)}`);
    const sData = await sRes.json().catch(()=>null);
    if (!sRes.ok || !sData?.ok) { setStatus("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞"); return; }
    renderAdminStats(sData);

    const pRes = await fetch(`${API_BASE}/admin/recent_pairs?tg_id=${encodeURIComponent(tg_id)}&limit=30`);
    const pData = await pRes.json().catch(()=>null);
    if (!pRes.ok || !pData?.ok) { setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä"); return; }
    renderAdminPairs(pData.pairs);

    if (showLoading) setStatus("");
  } catch(e) {
    setStatus("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
  }
}

switchTab("vote");
</script>
</body>
</html>
