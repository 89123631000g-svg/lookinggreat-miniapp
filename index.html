<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LookingGreat — Mini App</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#666; --border:#e6e8ef; }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial; background:var(--bg); color:var(--text); }
    .wrap { max-width: 860px; margin: 0 auto; padding: 18px; }
    .h1 { font-size: 22px; font-weight: 800; margin: 6px 0 14px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; margin:12px 0; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .tabs { display:flex; gap:8px; }
    .tab { border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .tab.active { border-color:#111; }
    .muted { color:var(--muted); font-size: 13px; }
    label { display:block; font-size: 13px; color:var(--muted); margin:10px 0 6px; }
    input { width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid var(--border); border-radius:10px; }
    button { border:0; background:#111; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; }
    button.secondary { background:#e9ebf3; color:#111; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .img { width:100%; border-radius:12px; border:1px solid var(--border); background:#fafbff; aspect-ratio: 3/4; object-fit: cover; }
    .ok { color:#0a7a2f; font-weight:700; }
    .bad { color:#b10000; font-weight:700; }
    .code { font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; background:#f1f3fa; border:1px solid var(--border); padding:10px; border-radius:10px; overflow:auto; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="h1">LookingGreat — Mini App</div>

    <div class="card">
      <div id="tgStatus" class="muted">Проверяем Telegram…</div>
      <div class="muted" id="tgUser"></div>
      <div class="muted" style="margin-top:6px;">
        Worker API: <span class="code" id="apiBase"></span>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <div class="tab active" data-tab="feed">Лента</div>
        <div class="tab" data-tab="create">Создать</div>
        <div class="tab" data-tab="me">Мои результаты</div>
      </div>
    </div>

    <!-- ЛЕНТА -->
    <div class="card" id="tab-feed">
      <div style="font-weight:800; margin-bottom:8px;">Лента</div>
      <div class="muted">Следующим шагом сделаем выдачу пар для голосования из базы.</div>
      <div class="muted" style="margin-top:8px;">Сейчас тут просто демо-карточка:</div>

      <div style="margin-top:10px;" class="grid2">
        <img class="img" id="demoLeft" src="https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=900&q=70" alt="left">
        <img class="img" id="demoRight" src="https://images.unsplash.com/photo-1490474418585-ba9bad8fd0ea?auto=format&fit=crop&w=900&q=70" alt="right">
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="secondary" disabled>Левое</button>
        <button class="secondary" disabled>Правое</button>
      </div>
      <div class="muted" style="margin-top:8px;">(Голосование подключим после шага “Создать”.)</div>
    </div>

    <!-- СОЗДАТЬ -->
    <div class="card" id="tab-create" style="display:none;">
      <div style="font-weight:800; margin-bottom:6px;">Создать голосование</div>
      <div class="muted">Пока принимаем <b>ссылки</b> на 2 фото. Загрузку файлов сделаем следующим шагом.</div>

      <label>Ссылка на левое фото</label>
      <input id="leftUrl" placeholder="https://...jpg / png / webp" />

      <label>Ссылка на правое фото</label>
      <input id="rightUrl" placeholder="https://...jpg / png / webp" />

      <div class="row" style="margin-top:12px;">
        <button id="btnCreate" disabled>Создать голосование</button>
        <button id="btnPreview" class="secondary">Предпросмотр</button>
      </div>

      <div style="margin-top:12px;" class="grid2">
        <img class="img" id="prevLeft" alt="левое превью" />
        <img class="img" id="prevRight" alt="правое превью" />
      </div>

      <div id="createResult" style="margin-top:12px;"></div>
    </div>

    <!-- МОИ РЕЗУЛЬТАТЫ -->
    <div class="card" id="tab-me" style="display:none;">
      <div style="font-weight:800; margin-bottom:8px;">Мои результаты</div>
      <div class="muted">Следующим шагом подключим список созданных пар и их статистику (сколько голосов за левое/правое).</div>
    </div>

  </div>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    // === НАСТРОЙКА: сюда подставь ссылку на твой Worker ===
    const API_BASE = "https://orange-math-fa5e.89123631000g.workers.dev";

    const elApiBase = document.getElementById("apiBase");
    elApiBase.textContent = API_BASE;

    const tgStatus = document.getElementById("tgStatus");
    const tgUser = document.getElementById("tgUser");
    const btnCreate = document.getElementById("btnCreate");
    const btnPreview = document.getElementById("btnPreview");
    const leftUrl = document.getElementById("leftUrl");
    const rightUrl = document.getElementById("rightUrl");
    const prevLeft = document.getElementById("prevLeft");
    const prevRight = document.getElementById("prevRight");
    const createResult = document.getElementById("createResult");

    // Tabs
    const tabs = document.querySelectorAll(".tab");
    function showTab(name) {
      tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
      document.getElementById("tab-feed").style.display = (name === "feed") ? "" : "none";
      document.getElementById("tab-create").style.display = (name === "create") ? "" : "none";
      document.getElementById("tab-me").style.display = (name === "me") ? "" : "none";
    }
    tabs.forEach(t => t.addEventListener("click", () => showTab(t.dataset.tab)));

    // Telegram init
    const tg = window.Telegram?.WebApp;
    const initData = tg?.initData || "";

    if (tg && initData) {
      tg.ready();
      tgStatus.innerHTML = '✅ <span class="ok">Открыто в Telegram</span>';
      const u = tg.initDataUnsafe?.user;
      tgUser.textContent = u ? `User ID: ${u.id} | Username: ${u.username || "—"} | Имя: ${u.first_name || "—"}` : "User: —";
      btnCreate.disabled = false;
    } else {
      tgStatus.innerHTML = '⚠️ <span class="bad">Открой Mini App внутри Telegram</span> (иначе сервер не примет запрос)';
      tgUser.textContent = "User: —";
      btnCreate.disabled = true;
    }

    function setPreview() {
      const l = leftUrl.value.trim();
      const r = rightUrl.value.trim();
      prevLeft.src = l || "";
      prevRight.src = r || "";
    }

    btnPreview.addEventListener("click", () => {
      setPreview();
      createResult.innerHTML = '<div class="muted">Предпросмотр обновлён.</div>';
    });

    async function apiPost(path, payload) {
      const res = await fetch(API_BASE + path, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-telegram-initdata": initData
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.ok === false) {
        const msg = data.error || ("HTTP " + res.status);
        throw new Error(msg);
      }
      return data;
    }

    btnCreate.addEventListener("click", async () => {
      try {
        createResult.innerHTML = '<div class="muted">Создаём…</div>';
        setPreview();

        const l = leftUrl.value.trim();
        const r = rightUrl.value.trim();
        if (!l || !r) {
          createResult.innerHTML = '<div class="bad">Нужно заполнить обе ссылки.</div>';
          return;
        }

        const data = await apiPost("/api/create-pair", {
          photo_left_url: l,
          photo_right_url: r
        });

        createResult.innerHTML = `
          <div class="ok">Готово! Создано голосование.</div>
          <div class="muted">photo_pair_id:</div>
          <div class="code">${data.photo_pair_id}</div>
          <div class="muted" style="margin-top:8px;">
            Следующий шаг: сделаем ленту и голосование за пары из базы.
          </div>
        `;
      } catch (e) {
        createResult.innerHTML = `<div class="bad">Ошибка: ${e.message}</div>`;
      }
    });
  </script>
</body>
</html>
