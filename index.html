<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>LookingGreat</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
*{ box-sizing:border-box; }
html,body{ margin:0; padding:0; background:#f6f6f7; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

:root{
  --nav-h: 80px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --radius: 18px;
  --shadow: 0 10px 26px rgba(0,0,0,0.10);
  --line: rgba(0,0,0,0.08);
  --textDim: rgba(0,0,0,0.55);
  --bgA: #121318;
  --bgB: #1a1b22;
}

.app{
  padding: 14px 12px calc(var(--nav-h) + var(--safe-bottom) + 14px);
}

.post{
  background:#fff;
  border:1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
  margin:0 0 14px 0;
}

.postHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 12px;
}

.postTitle{ font-size:16px; font-weight:650; color:#111; }
.postSub{ font-size:12px; color:var(--textDim); margin-top:2px; }

.menuBtn{
  width:36px; height:36px;
  border-radius:10px;
  border:1px solid var(--line);
  background:#fff;
  display:flex; align-items:center; justify-content:center;
}
.menuBtn svg{ width:18px; height:18px; stroke: rgba(0,0,0,0.55); fill:none; stroke-width:2; }

/* пара: слева/справа, почти на экран */
.pair{
  width:100%;
  height: 72vh;      /* ключевое: почти один экран */
  max-height: 620px;
  min-height: 430px;
  display:flex;
  background: linear-gradient(180deg, var(--bgA), var(--bgB)); /* без мыла */
}

/* половинка */
.half{
  position:relative;
  width:50%;
  height:100%;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* изображение: без обрезки */
.half img{
  width:100%;
  height:100%;
  object-fit: contain;        /* НЕ режет */
  object-position: center;
  display:block;
}

/* тонкий вертикальный разделитель */
.dividerV{
  width:1px;
  background: rgba(255,255,255,0.12);
}

/* лайк-кнопка (filled thumbs up) */
.likeBtn{
  position:absolute;
  bottom:14px;
  right:14px;
  width:56px;
  height:56px;
  border-radius:999px;
  background: rgba(255,255,255,0.92);
  border: 1px solid rgba(0,0,0,0.06);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: 0 10px 24px rgba(0,0,0,0.20);
  display:flex;
  align-items:center;
  justify-content:center;
  user-select:none;
  transition: transform .15s ease, opacity .15s ease;
}
.likeBtn:active{ transform: scale(0.92); }
.likeBtn svg{ width:26px; height:26px; fill: rgba(0,0,0,0.85); }

/* после голосования */
.voted .likeBtn{ opacity:0.35; pointer-events:none; }

/* подсветка выбранного */
.chosen::after{
  content:"";
  position:absolute;
  inset:0;
  border: 3px solid rgba(255,255,255,0.65);
  box-shadow: inset 0 0 0 999px rgba(255,255,255,0.06);
  pointer-events:none;
}

/* footer как у соцсетей */
.postFooter{
  padding: 10px 12px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.stat{
  display:flex;
  align-items:center;
  gap:8px;
  color: rgba(0,0,0,0.78);
  font-size:14px;
}
.stat svg{ width:18px; height:18px; fill: rgba(0,0,0,0.55); }

.actions{
  display:flex;
  align-items:center;
  gap:10px;
}

.shareBtn{
  height:34px;
  padding: 0 12px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background:#fff;
  color:#111;
  font-size:13px;
  font-weight:600;
}

.hint{ font-size:12px; color: rgba(0,0,0,0.50); }

/* нижняя навигация */
.bottomNav{
  position:fixed; left:0; right:0; bottom:0;
  height: calc(var(--nav-h) + var(--safe-bottom));
  padding-bottom: var(--safe-bottom);
  background: rgba(255,255,255,0.96);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-top:1px solid rgba(0,0,0,0.08);
  display:flex;
  justify-content:space-around;
  align-items:center;
}

.navItem{
  width:60px; height:60px;
  border:0; background:transparent;
  display:flex; align-items:center; justify-content:center;
}
.navItem svg{
  width:26px; height:26px;
  stroke: rgba(0,0,0,0.72);
  fill:none;
  stroke-width:2;
  stroke-linecap:round;
  stroke-linejoin:round;
}
.navItem.active svg{ stroke: rgba(0,0,0,1); }
</style>
</head>

<body>
  <div class="app" id="feed"></div>

  <div class="bottomNav">
    <button class="navItem active" id="tabHome" onclick="goHome()">
      <svg viewBox="0 0 24 24">
        <path d="M3 10.5 12 3l9 7.5"></path>
        <path d="M5 10v10a1 1 0 0 0 1 1h4v-6h4v6h4a1 1 0 0 0 1-1V10"></path>
      </svg>
    </button>

    <button class="navItem" id="tabUpload" onclick="goUpload()">
      <svg viewBox="0 0 24 24">
        <path d="M12 5v14"></path>
        <path d="M5 12h14"></path>
      </svg>
    </button>

    <button class="navItem" id="tabProfile" onclick="goProfile()">
      <svg viewBox="0 0 24 24">
        <path d="M20 21a8 8 0 0 0-16 0"></path>
        <circle cx="12" cy="8" r="4"></circle>
      </svg>
    </button>
  </div>

<script>
const API_BASE = "https://api.lookingreat.ru";

const tg = window.Telegram?.WebApp;
try { tg?.expand(); tg?.disableVerticalSwipes?.(); } catch(e) {}

const tg_id = (tg?.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : "999");

let loading = false;
let lastId = 999999999;
let ended = false;

function setActive(tabId){
  document.getElementById("tabHome").classList.toggle("active", tabId === "home");
  document.getElementById("tabUpload").classList.toggle("active", tabId === "upload");
  document.getElementById("tabProfile").classList.toggle("active", tabId === "profile");
}

function dotsSvg(){
  return `
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M6 12h.01"></path>
      <path d="M12 12h.01"></path>
      <path d="M18 12h.01"></path>
    </svg>
  `;
}

function thumbFilledSvg(){
  return `
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M2 11.5C2 10.67 2.67 10 3.5 10H7v12H3.5C2.67 22 2 21.33 2 20.5v-9z"></path>
      <path d="M9 10h4.02l2.03-4.72c.43-1.01 1.42-1.66 2.52-1.66h.18c1.29 0 2.23 1.2 1.95 2.45L19.7 10H21c1.27 0 2.2 1.2 1.87 2.43l-1.74 6.5A3 3 0 0 1 18.25 21H9V10z"></path>
    </svg>
  `;
}

async function loadFeed(){
  if (loading || ended) return;
  loading = true;

  const res = await fetch(`${API_BASE}/feed?tg_id=${encodeURIComponent(tg_id)}&before_id=${encodeURIComponent(lastId)}`);
  const data = await res.json().catch(()=>({ok:false}));
  if (!data.ok) { loading = false; return; }

  const items = data.items || [];
  if (items.length === 0) ended = true;

  for (const item of items){
    lastId = item.id;

    const post = document.createElement("div");
    post.className = "post";
    post.dataset.pairId = item.id;
    post.dataset.votes = "0";

    const leftUrl  = `${API_BASE}/r2/${encodeURIComponent(item.photo_left_key)}`;
    const rightUrl = `${API_BASE}/r2/${encodeURIComponent(item.photo_right_key)}`;

    post.innerHTML = `
      <div class="postHeader">
        <div>
          <div class="postTitle">Пара #${item.id}</div>
          <div class="postSub">Сравни и выбери лучшее фото</div>
        </div>
        <div class="menuBtn" title="Меню">${dotsSvg()}</div>
      </div>

      <div class="pair">
        <div class="half" data-choice="left">
          <img loading="lazy" src="${leftUrl}" alt="">
          <div class="likeBtn" title="Лайк">${thumbFilledSvg()}</div>
        </div>
        <div class="dividerV"></div>
        <div class="half" data-choice="right">
          <img loading="lazy" src="${rightUrl}" alt="">
          <div class="likeBtn" title="Лайк">${thumbFilledSvg()}</div>
        </div>
      </div>

      <div class="postFooter">
        <div class="stat">
          ${thumbFilledSvg()}
          <span class="votesText">0 голосов</span>
        </div>
        <div class="actions">
          <button class="shareBtn" type="button">Поделиться</button>
        </div>
      </div>
    `;

    post.querySelectorAll(".half").forEach(half => {
      half.addEventListener("click", () => vote(post, half.dataset.choice));
    });

    post.querySelector(".shareBtn").addEventListener("click", async (e) => {
      e.stopPropagation();
      const pairId = post.dataset.pairId;
      const link = `https://t.me/Lookinggreat_bot?startapp=pair_${pairId}`;
      try{
        if (tg?.openTelegramLink) tg.openTelegramLink(link);
        else window.open(link, "_blank");
      }catch(_){
        window.open(link, "_blank");
      }
    });

    document.getElementById("feed").appendChild(post);
  }

  loading = false;
}

async function vote(post, choice){
  if (post.classList.contains("voted")) return;
  post.classList.add("voted");

  const chosenHalf = post.querySelector(`.half[data-choice="${choice}"]`);
  if (chosenHalf) chosenHalf.classList.add("chosen");

  const pair_id = Number(post.dataset.pairId);

  const nextVotes = Number(post.dataset.votes || "0") + 1;
  post.dataset.votes = String(nextVotes);
  post.querySelector(".votesText").textContent = `${nextVotes} голосов`;

  await fetch(`${API_BASE}/vote`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ tg_id, pair_id, choice })
  }).catch(()=>{});

  setTimeout(() => {
    window.scrollBy({ top: post.getBoundingClientRect().height + 14, behavior: "smooth" });
  }, 320);
}

window.addEventListener("scroll", () => {
  const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 900);
  if (nearBottom) loadFeed();
});

function goHome(){ setActive("home"); window.scrollTo({ top: 0, behavior: "smooth" }); }
function goUpload(){ setActive("upload"); alert("Загрузка: добавим экран следующим шагом"); }
function goProfile(){ setActive("profile"); alert("Профиль/статистика: добавим экран следующим шагом"); }

loadFeed();
</script>
</body>
</html>
