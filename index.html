<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>LookingGreat</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0c10;
      --card:#11131a;
      --text:#f2f3f5;
      --muted:#a8adbd;
      --stroke:rgba(255,255,255,.12);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --cta:#ffffff;
      --ctaText:#0b0c10;
      --tap: rgba(255,255,255,.08);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --card:#ffffff;
        --text:#141824;
        --muted:#5b6375;
        --stroke:rgba(0,0,0,.10);
        --shadow: 0 12px 40px rgba(10,15,25,.12);
        --cta:#141824;
        --ctaText:#ffffff;
        --tap: rgba(10,15,25,.06);
      }
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    a{ color: inherit; text-decoration: none; }
    button{ font: inherit; }

    .wrap{
      max-width: 560px;
      margin: 0 auto;
      padding: 16px 16px 110px;
    }

    /* Header: ТОЛЬКО бренд. НИКАКИХ кнопок/ссылок "Голосовать" */
    header{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px 0 6px;
      position: sticky;
      top: 0;
      background: linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,0));
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    @media (prefers-color-scheme: light){
      header{
        background: linear-gradient(to bottom, rgba(246,247,251,.85), rgba(246,247,251,0));
      }
    }
    .brand{
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 16px;
      padding: 10px 14px;
      border: 1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(255,255,255,.02);
    }
    @media (prefers-color-scheme: light){
      .brand{ background: rgba(0,0,0,.02); }
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    /* Home */
    .hero{
      margin-top: 16px;
      background: radial-gradient(1200px 420px at 50% -120px, rgba(255,255,255,.08), transparent 60%);
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .h1{
      font-size: 30px;
      line-height: 1.1;
      letter-spacing: -0.6px;
      font-weight: 900;
      margin: 0 0 10px;
    }
    .sub{
      margin: 0 0 14px;
      color: var(--muted);
      font-size: 14px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
    }
    .pill{
      padding: 6px 10px;
      border: 1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(255,255,255,.03);
    }
    @media (prefers-color-scheme: light){
      .pill{ background: rgba(0,0,0,.02); }
    }

    .previewCard{
      margin-top: 12px;
      border-radius: var(--radius2);
      border: 1px solid var(--stroke);
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    @media (prefers-color-scheme: light){
      .previewCard{ background: rgba(0,0,0,.02); }
    }
    .pairGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: var(--stroke);
    }
    .imgBox{
      aspect-ratio: 1 / 1;
      position: relative;
      overflow:hidden;
      background: rgba(255,255,255,.03);
    }
    .imgBox img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }
    /* Home превью — специально “замылено”, чтобы не было “втыкания”, а было желание нажать кнопку */
    .homeBlur img{
      filter: blur(10px) brightness(.9);
      transform: scale(1.08);
    }
    .imgBox::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(to bottom, rgba(0,0,0,.10), rgba(0,0,0,.25));
      pointer-events:none;
    }

    .cta{
      width:100%;
      margin-top: 14px;
      padding: 14px 16px;
      border-radius: 14px;
      border: 0;
      background: var(--cta);
      color: var(--ctaText);
      font-weight: 900;
      font-size: 16px;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
    }
    .cta:active{ transform: translateY(1px); }

    .micro{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
    }

    /* Soft nav (НЕ в шапке) */
    .softNav{
      margin-top: 14px;
      display:flex;
      justify-content:center;
      gap: 12px;
      font-size: 13px;
      color: var(--muted);
    }
    .softNav a{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
    }
    .softNav a:active{ background: var(--tap); }

    /* Vote */
    .blockTitle{
      font-size: 18px;
      font-weight: 900;
      margin: 12px 0 10px;
      letter-spacing: -0.2px;
    }
    .voteCard{
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    @media (prefers-color-scheme: light){
      .voteCard{ background: rgba(0,0,0,.02); }
    }
    .voteGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: var(--stroke);
    }
    .voteBtn{
      padding:0;
      border:0;
      background: transparent;
      cursor:pointer;
      position:relative;
    }
    /* ВАЖНО: никаких “ЛЕВО/ПРАВО” бейджей — тут вообще нет оверлеев */
    .voteBtn:active{
      outline: 3px solid rgba(255,255,255,.22);
      outline-offset: -3px;
    }
    .voteHint{
      padding: 12px 12px 14px;
      color: var(--muted);
      font-size: 13px;
      text-align:center;
    }

    .row{
      display:flex;
      gap: 10px;
      margin-top: 12px;
    }
    .ghost{
      flex: 1;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: transparent;
      color: var(--text);
      cursor:pointer;
      font-weight: 800;
    }
    .ghost:active{ background: var(--tap); }

    .toast{
      margin-top: 10px;
      padding: 10px 12px;
      border: 1px solid var(--stroke);
      border-radius: 14px;
      color: var(--muted);
      font-size: 13px;
      display:none;
      white-space: pre-wrap;
    }
    .toast.show{ display:block; }

    /* Bottom nav (после первого действия; НЕ на Home) */
    .bottomNav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 14px calc(10px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(0,0,0,.60), rgba(0,0,0,0));
      backdrop-filter: blur(12px);
      z-index: 20;
      display:none;
    }
    @media (prefers-color-scheme: light){
      .bottomNav{
        background: linear-gradient(to top, rgba(246,247,251,.92), rgba(246,247,251,0));
      }
    }
    .bottomNavInner{
      max-width: 560px;
      margin: 0 auto;
      display:flex;
      gap: 10px;
    }
    .tab{
      flex:1;
      text-align:center;
      padding: 12px 10px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      color: var(--muted);
      font-weight: 900;
      font-size: 13px;
      background: rgba(255,255,255,.03);
    }
    @media (prefers-color-scheme: light){
      .tab{ background: rgba(0,0,0,.02); }
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(255,255,255,.22);
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">LookingGreat</div>
  </header>

  <div class="wrap">
    <!-- HOME -->
    <section id="screen-home" class="screen active" aria-label="Главная">
      <div class="hero">
        <h1 class="h1">Кто выглядит лучше?</h1>
        <div class="sub">
          <span class="pill">Анонимно</span>
          <span class="pill">1 тап</span>
          <span class="pill">Без регистрации</span>
        </div>

        <div class="previewCard" aria-hidden="true">
          <div class="pairGrid">
            <div class="imgBox homeBlur"><img id="homePrevA" alt="" /></div>
            <div class="imgBox homeBlur"><img id="homePrevB" alt="" /></div>
          </div>
        </div>

        <button id="btnStartVote" class="cta">Начать голосовать</button>
        <div class="micro">Сначала голосуешь — потом можешь загрузить свои фото</div>

        <nav class="softNav" aria-label="Навигация">
          <a href="#create" id="linkCreateSoft">Создать</a>
          <a href="#results" id="linkResultsSoft">Мои результаты</a>
        </nav>
      </div>
    </section>

    <!-- VOTE -->
    <section id="screen-vote" class="screen" aria-label="Голосование">
      <div class="blockTitle">Выбери, что лучше</div>

      <div class="voteCard">
        <div class="voteGrid">
          <button class="voteBtn" id="voteA" aria-label="Выбрать фото A">
            <div class="imgBox"><img id="voteImgA" alt="Фото A" /></div>
          </button>
          <button class="voteBtn" id="voteB" aria-label="Выбрать фото B">
            <div class="imgBox"><img id="voteImgB" alt="Фото B" /></div>
          </button>
        </div>
        <div class="voteHint">Просто тапни по фото. Без комментариев.</div>
      </div>

      <div class="row">
        <button class="ghost" id="btnSkip">Пропустить</button>
        <button class="ghost" id="btnNext">Дальше</button>
      </div>

      <div id="toast" class="toast" role="status" aria-live="polite"></div>
    </section>

    <!-- CREATE (заглушка) -->
    <section id="screen-create" class="screen" aria-label="Создать пару">
      <div class="blockTitle">Создать пару</div>
      <div class="toast show">
        Тут подключим твой текущий экран создания пары (загрузка в R2 + запись в D1).
      </div>
    </section>

    <!-- RESULTS (заглушка) -->
    <section id="screen-results" class="screen" aria-label="Мои результаты">
      <div class="blockTitle">Мои результаты</div>
      <div class="toast show">
        Тут подключим твой текущий экран результатов.
      </div>
    </section>
  </div>

  <!-- Bottom nav (НЕ на Home) -->
  <nav class="bottomNav" id="bottomNav" aria-label="Нижняя навигация">
    <div class="bottomNavInner">
      <a class="tab" href="#vote" id="tabVote">Голосовать</a>
      <a class="tab" href="#create" id="tabCreate">Создать</a>
      <a class="tab" href="#results" id="tabResults">Мои</a>
    </div>
  </nav>

  <script>
    /******************************************************************
     * CONFIG — ВАЖНО
     * GitHub Pages = фронт, Cloudflare Worker = API.
     * Чтобы iOS без VPN НЕ упирался в workers.dev — используем lookingreat.ru
     ******************************************************************/
    const API_BASE = 'https://lookingreat.ru';

    /**
     * Если твои реальные пути отличаются — можно поправить тут.
     * Но чтобы не угадывать, ниже есть AUTO-DETECT (кандидаты).
     */
    const ENDPOINTS = {
      nextPair: '/api/vote/next',   // основной кандидат
      vote:     '/api/vote',        // основной кандидат
      skip:     '/api/vote/skip'    // основной кандидат (может отсутствовать)
    };

    /***********************
     * Telegram init
     ***********************/
    try{
      if (window.Telegram && Telegram.WebApp){
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
      }
    }catch(e){}

    /***********************
     * Router
     ***********************/
    const screens = {
      home: document.getElementById('screen-home'),
      vote: document.getElementById('screen-vote'),
      create: document.getElementById('screen-create'),
      results: document.getElementById('screen-results')
    };
    const bottomNav = document.getElementById('bottomNav');
    const tabs = {
      vote: document.getElementById('tabVote'),
      create: document.getElementById('tabCreate'),
      results: document.getElementById('tabResults')
    };

    function showScreen(name){
      for (const k in screens){
        screens[k].classList.toggle('active', k === name);
      }
      bottomNav.style.display = (name === 'home') ? 'none' : 'block';
      for (const k in tabs){
        tabs[k].classList.toggle('active', k === name);
      }
    }

    function route(){
      const hash = (location.hash || '#home').replace('#','');
      const name = ['home','vote','create','results'].includes(hash) ? hash : 'home';
      showScreen(name);
      if (name === 'vote') ensureVoteLoaded();
    }
    window.addEventListener('hashchange', route);

    /***********************
     * Home preview images
     ***********************/
    const homePrevA = document.getElementById('homePrevA');
    const homePrevB = document.getElementById('homePrevB');

    const FALLBACK_PREVIEW_A = 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=900&q=80';
    const FALLBACK_PREVIEW_B = 'https://images.unsplash.com/photo-1490474418585-ba9bad8fd0ea?auto=format&fit=crop&w=900&q=80';

    homePrevA.src = FALLBACK_PREVIEW_A;
    homePrevB.src = FALLBACK_PREVIEW_B;

    /***********************
     * Vote logic
     ***********************/
    const voteImgA = document.getElementById('voteImgA');
    const voteImgB = document.getElementById('voteImgB');
    const voteA = document.getElementById('voteA');
    const voteB = document.getElementById('voteB');
    const btnStartVote = document.getElementById('btnStartVote');
    const btnNext = document.getElementById('btnNext');
    const btnSkip = document.getElementById('btnSkip');
    const toast = document.getElementById('toast');

    let currentPair = null;
    let voteLoading = false;

    function apiUrl(path){
      const base = (API_BASE || '').replace(/\/+$/,'');
      const p = (path || '').startsWith('/') ? path : '/' + path;
      return base + p;
    }

    function showToast(msg, ms=2600){
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.classList.remove('show'), ms);
    }

    function normalizePairPayload(data){
      // Подстраховка под разные форматы:
      // pair_id/id/pairId, left_url/photo_left_url/left/a, right_url/photo_right_url/right/b
      const pairId = data?.pair_id ?? data?.id ?? data?.pairId ?? null;
      const leftUrl = data?.left_url ?? data?.photo_left_url ?? data?.left ?? data?.a ?? null;
      const rightUrl = data?.right_url ?? data?.photo_right_url ?? data?.right ?? data?.b ?? null;
      return { pairId, leftUrl, rightUrl };
    }

    function setVoteImages(leftUrl, rightUrl){
      voteImgA.src = leftUrl || FALLBACK_PREVIEW_A;
      voteImgB.src = rightUrl || FALLBACK_PREVIEW_B;
    }

    async function tryGetJson(url){
      const res = await fetch(url, { method:'GET', credentials:'include' });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${url}`);
      return await res.json();
    }

    /**
     * AUTO-DETECT для nextPair:
     * Мы НЕ знаем 100% твои реальные пути, поэтому пробуем несколько вариантов.
     * В консоль и в toast покажем, что реально сработало.
     */
    async function fetchNextPairAuto(){
      const candidates = [
        ENDPOINTS.nextPair,

        // Частые варианты:
        '/api/next',
        '/api/pairs/next',
        '/api/feed/next',
        '/api/votes/next',
        '/vote/next',
        '/next'
      ];

      let lastErr = null;
      for (const p of candidates){
        try{
          const data = await tryGetJson(apiUrl(p));
          const norm = normalizePairPayload(data);
          if (norm.leftUrl && norm.rightUrl) {
            return { ...norm, usedPath: p };
          }
          // Если ответ есть, но поля другие — тоже считаем “успехом” и дадим подсказку
          return { ...norm, usedPath: p, raw: data };
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error('No nextPair endpoint matched');
    }

    /**
     * Vote endpoint — тоже делаем авто-подбор.
     */
    async function postJson(url, body){
      const res = await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        credentials:'include',
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${url}`);
      return res.json().catch(()=> ({}));
    }

    async function sendVoteAuto(pairId, choice){
      const candidates = [
        ENDPOINTS.vote,

        // Частые варианты:
        '/api/vote/add',
        '/api/votes',
        '/api/votes/add',
        '/api/pairs/vote',
        '/vote',
      ];

      let lastErr = null;
      for (const p of candidates){
        try{
          return await postJson(apiUrl(p), { pair_id: pairId, choice });
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error('No vote endpoint matched');
    }

    async function sendSkipAuto(pairId){
      const candidates = [
        ENDPOINTS.skip,

        // Частые варианты:
        '/api/skip',
        '/api/vote/skip',
        '/api/pairs/skip',
        '/skip',
      ];

      let lastErr = null;
      for (const p of candidates){
        try{
          return await postJson(apiUrl(p), { pair_id: pairId });
        }catch(e){
          lastErr = e;
        }
      }
      // skip не критичен — просто молча отдаём
      return {};
    }

    async function ensureVoteLoaded(force=false){
      if (voteLoading) return;
      if (currentPair && !force) return;

      voteLoading = true;
      try{
        const data = await fetchNextPairAuto();
        currentPair = { pairId: data.pairId, leftUrl: data.leftUrl, rightUrl: data.rightUrl };

        if (data.leftUrl && data.rightUrl){
          setVoteImages(data.leftUrl, data.rightUrl);

          // приятная “служебка” только для тебя (в консоль)
          console.log('[LookingGreat] nextPair OK via', data.usedPath, currentPair);

          // бонус: обновим превью на Home реальными фотками (но замыленными)
          homePrevA.src = data.leftUrl;
          homePrevB.src = data.rightUrl;
        } else {
          // Ответ пришёл, но поля не те — покажем в тост, что надо поправить маппинг полей
          setVoteImages(FALLBACK_PREVIEW_A, FALLBACK_PREVIEW_B);
          console.warn('[LookingGreat] nextPair payload not recognized', data.raw || data);
          showToast(
            'API отвечает, но формат пары не распознан.\n' +
            'Нужно привести ответ к полям: pair_id, left_url, right_url.',
            4500
          );
        }
      }catch(e){
        currentPair = { pairId: null, leftUrl: FALLBACK_PREVIEW_A, rightUrl: FALLBACK_PREVIEW_B };
        setVoteImages(currentPair.leftUrl, currentPair.rightUrl);

        // ВАЖНО: если тут “TypeError: Failed to fetch” — почти всегда CORS или HTTPS/домен.
        console.warn(e);
        showToast(
          'Не удалось загрузить пару.\n' +
          'Проверь: API_BASE=' + API_BASE + '\n' +
          'И что домен отдаёт CORS для GitHub Pages.',
          5000
        );
      }finally{
        voteLoading = false;
      }
    }

    async function vote(choice){
      if (voteLoading) return;
      if (!currentPair) await ensureVoteLoaded(true);

      if (!currentPair?.pairId){
        showToast('Демо-режим: API не подключён.', 2200);
        await ensureVoteLoaded(true);
        return;
      }

      voteLoading = true;
      try{
        await sendVoteAuto(currentPair.pairId, choice);
        showToast('Засчитано', 900);
        currentPair = null;
        await ensureVoteLoaded(true);
      }catch(e){
        console.warn(e);
        showToast('Не получилось отправить голос.\nПроверь vote endpoint / CORS.', 3500);
      }finally{
        voteLoading = false;
      }
    }

    async function skip(){
      if (voteLoading) return;
      if (!currentPair) await ensureVoteLoaded(true);

      voteLoading = true;
      try{
        if (currentPair?.pairId) await sendSkipAuto(currentPair.pairId);
        currentPair = null;
        await ensureVoteLoaded(true);
      }catch(e){
        console.warn(e);
        currentPair = null;
        await ensureVoteLoaded(true);
      }finally{
        voteLoading = false;
      }
    }

    /***********************
     * Events
     ***********************/
    btnStartVote.addEventListener('click', () => {
      location.hash = '#vote';
    });

    voteA.addEventListener('click', () => vote('A'));
    voteB.addEventListener('click', () => vote('B'));
    btnNext.addEventListener('click', () => ensureVoteLoaded(true));
    btnSkip.addEventListener('click', () => skip());

    /***********************
     * Boot
     ***********************/
    route();
  </script>
</body>
</html>
