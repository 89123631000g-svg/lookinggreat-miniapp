<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LookingGreat</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --appH: 100vh;
      --pad: 16px;
      --safeB: env(safe-area-inset-bottom, 0px);
    }
    html, body { height: 100%; }
    body {
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:0; background:#0b0b14; color:#fff;
      overflow: hidden; /* важно: убираем скролл страницы */
    }

    .wrap {
      max-width: 920px;
      margin: 0 auto;
      padding: var(--pad);
      height: var(--appH);
      box-sizing: border-box;
      display:flex;
      flex-direction:column;
      gap: 12px;
      padding-bottom: calc(var(--pad) + var(--safeB));
    }

    .top { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .h1 { font-size: 22px; font-weight: 800; }
    .sub { opacity:.75; margin-top:4px; font-size:13px; }
    .pill { padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); font-size:12px; opacity:.9; }

    .card {
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,.04);
      flex: 1;                 /* занимает всё оставшееся */
      min-height: 0;           /* критично для flex */
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .grid {
      display:grid;
      grid-template-columns: 1fr 1fr; /* на мобиле тоже 2 колонки */
      gap: 10px;
      flex: 1;
      min-height: 0;
    }

    .imgbox {
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      min-height: 0;
    }
    .imgbox img {
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      background: rgba(255,255,255,.02);
    }

    .muted { opacity:.7; font-size: 13px; }
    .row { display:flex; gap:10px; flex-wrap:nowrap; align-items:center; justify-content:space-between; }
    button {
      background: rgba(255,255,255,.08);
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      white-space: nowrap;
    }
    button:disabled { opacity:.5; cursor:not-allowed; }

    /* bottom sheet */
    .sheetBack {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 10px;
      box-sizing:border-box;
    }
    .sheet {
      width: min(920px, 100%);
      background: #121223;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
      box-sizing:border-box;
      padding-bottom: calc(12px + var(--safeB));
    }
    .sheet .row { gap: 8px; flex-wrap: wrap; justify-content:flex-end; }
    .sheet input[type="file"] { width: 100%; }

    @media (min-width: 980px) {
      .wrap { padding: 18px; }
      .grid { gap: 12px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="h1">LookingGreat</div>
        <div class="sub">Батл: тапни на фото, которое выглядит лучше</div>
      </div>
      <div class="pill" id="statusPill">Готово</div>
    </div>

    <div class="card">
      <div class="grid">
        <div class="imgbox" id="leftBox" title="Выбрать">
          <img id="leftImg" alt="" />
        </div>
        <div class="imgbox" id="rightBox" title="Выбрать">
          <img id="rightImg" alt="" />
        </div>
      </div>

      <div class="row">
        <div class="muted" id="hint">Тапни по фото — голос засчитается.</div>
        <div style="display:flex; gap:8px;">
          <button id="uploadOpenBtn">Загрузить пару</button>
          <button id="skipBtn">Пропустить</button>
        </div>
      </div>
    </div>
  </div>

  <!-- bottom sheet -->
  <div class="sheetBack" id="sheetBack">
    <div class="sheet">
      <div class="muted" style="margin-bottom:10px;">Загрузить свою пару:</div>
      <form id="uploadForm">
        <div style="display:grid; gap:10px;">
          <input type="file" id="fileLeft" accept="image/*" required />
          <input type="file" id="fileRight" accept="image/*" required />
          <div class="row">
            <button type="button" id="sheetCloseBtn">Закрыть</button>
            <button type="submit" id="uploadBtn">Загрузить</button>
          </div>
        </div>
      </form>
    </div>
  </div>

<script>
  const API_BASE = "https://api.lookingreat.ru";

  const tg = window.Telegram?.WebApp;
  try { tg?.ready(); } catch(e) {}
  try { tg?.expand(); } catch(e) {}
  try { tg?.disableVerticalSwipes?.(); } catch(e) {}

  function applyAppHeight(){
    const h = (tg?.viewportStableHeight || tg?.viewportHeight || window.innerHeight);
    document.documentElement.style.setProperty("--appH", h + "px");
  }
  applyAppHeight();
  try { tg?.onEvent?.("viewportChanged", applyAppHeight); } catch(e) {}
  window.addEventListener("resize", applyAppHeight);

  const statusPill = document.getElementById("statusPill");
  const leftBox = document.getElementById("leftBox");
  const rightBox = document.getElementById("rightBox");
  const leftImg = document.getElementById("leftImg");
  const rightImg = document.getElementById("rightImg");
  const skipBtn = document.getElementById("skipBtn");

  const uploadOpenBtn = document.getElementById("uploadOpenBtn");
  const sheetBack = document.getElementById("sheetBack");
  const sheetCloseBtn = document.getElementById("sheetCloseBtn");

  const uploadForm = document.getElementById("uploadForm");
  const uploadBtn = document.getElementById("uploadBtn");
  const fileLeft = document.getElementById("fileLeft");
  const fileRight = document.getElementById("fileRight");

  let tgId = "0";
  let currentPairId = null;
  let busy = false;

  function setStatus(text) { statusPill.textContent = text; }

  function getTelegramId() {
    const id = tg?.initDataUnsafe?.user?.id;
    return String(id || "1"); // тест вне Telegram
  }

  async function apiGet(path) {
    const r = await fetch(API_BASE + path, { method:"GET" });
    return await r.json();
  }

  async function apiPostJson(path, body) {
    const r = await fetch(API_BASE + path, {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    return await r.json();
  }

  function showEmpty() {
    currentPairId = null;
    leftImg.src = "";
    rightImg.src = "";
    setStatus("Пары закончились");
  }

  function renderItem(item) {
    currentPairId = item.id;

    // небольшой cache-bust, чтобы iOS не упрямился после голосования
    const v = "v=" + item.id + "_" + Date.now();
    leftImg.src = item.left_url + (item.left_url.includes("?") ? "&" : "?") + v;
    rightImg.src = item.right_url + (item.right_url.includes("?") ? "&" : "?") + v;

    setStatus("Выбирай");
  }

  async function loadFeed() {
    if (busy) return;
    busy = true;
    setStatus("Загружаем…");
    try {
      const data = await apiGet(`/feed?tg_id=${encodeURIComponent(tgId)}`);
      if (!data.ok) throw new Error(data.error || "api_error");
      if (data.empty) return showEmpty();
      renderItem(data.item);
    } catch (e) {
      setStatus("Ошибка загрузки");
      console.error(e);
    } finally {
      busy = false;
    }
  }

  async function vote(choice) {
    if (busy || !currentPairId) return;
    busy = true;
    setStatus("Сохраняем…");
    try {
      const data = await apiPostJson(`/vote`, { tg_id: tgId, pair_id: currentPairId, choice });
      if (!data.ok) {
        if (data.error === "already_voted") return await loadFeed();
        if (data.error === "cannot_vote_own_pair") {
          setStatus("Нельзя голосовать за свою пару");
          return;
        }
        throw new Error(data.error || "vote_error");
      }
      if (data.empty) return showEmpty();
      renderItem(data.item);
    } catch (e) {
      setStatus("Ошибка голоса");
      console.error(e);
    } finally {
      busy = false;
    }
  }

  leftBox.addEventListener("click", () => vote("left"));
  rightBox.addEventListener("click", () => vote("right"));
  skipBtn.addEventListener("click", () => loadFeed());

  uploadOpenBtn.addEventListener("click", () => { sheetBack.style.display = "flex"; });
  sheetCloseBtn.addEventListener("click", () => { sheetBack.style.display = "none"; });
  sheetBack.addEventListener("click", (e) => { if (e.target === sheetBack) sheetBack.style.display = "none"; });

  uploadForm.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    if (busy) return;
    const l = fileLeft.files?.[0];
    const r = fileRight.files?.[0];
    if (!l || !r) return;

    busy = true;
    uploadBtn.disabled = true;
    setStatus("Загрузка…");

    try {
      const fd = new FormData();
      fd.append("tg_id", tgId);
      fd.append("left", l);
      fd.append("right", r);

      const resp = await fetch(API_BASE + "/upload_pair", { method:"POST", body: fd });
      const data = await resp.json();
      if (!data.ok) throw new Error(data.error || "upload_error");

      setStatus("Загружено");
      sheetBack.style.display = "none";
      await loadFeed();
    } catch (e) {
      console.error(e);
      setStatus("Ошибка загрузки");
    } finally {
      busy = false;
      uploadBtn.disabled = false;
      uploadForm.reset();
    }
  });

  // старт
  tgId = getTelegramId();
  loadFeed();
</script>
</body>
</html>
