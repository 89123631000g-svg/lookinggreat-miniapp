<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>LookingGreat</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* { box-sizing: border-box; }

html, body {
  margin: 0;
  padding: 0;
  background: #f6f6f7;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

:root{
  --nav-h: 80px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --radius: 18px;
  --shadow: 0 10px 26px rgba(0,0,0,0.10);
  --line: rgba(0,0,0,0.08);
}

.app {
  padding: 14px 12px calc(var(--nav-h) + var(--safe-bottom) + 14px);
}

/* карточка-пост */
.post {
  background: #fff;
  border: 1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
  margin: 0 0 14px 0;
}

.postHeader {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 12px;
}

.postTitle {
  font-size: 16px;
  font-weight: 650;
  color: #111;
}

.postSub {
  font-size: 12px;
  color: rgba(0,0,0,0.55);
  margin-top: 2px;
}

.menuBtn {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  border: 1px solid var(--line);
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
}

.menuBtn svg {
  width: 18px;
  height: 18px;
  stroke: rgba(0,0,0,0.55);
  fill: none;
  stroke-width: 2;
}

/* блок пары (вертикально) */
.pair {
  width: 100%;
  height: 68vh;     /* крупно, но видно следующую карточку */
  max-height: 560px;
  min-height: 420px;
  display: flex;
  flex-direction: column;
  background: #000;
}

.half {
  position: relative;
  width: 100%;
  height: 50%;
  overflow: hidden;
  background: #000;
}

.half img {
  width: 100%;
  height: 100%;
  object-fit: cover;            /* не тянет, режет минимально */
  object-position: 50% 25%;     /* чуть выше центра, меньше режет лица */
  display: block;
}

/* разделитель между верх/низ */
.dividerH {
  height: 1px;
  background: rgba(255,255,255,0.25);
}

/* лайк-кнопка */
.likeBtn {
  position: absolute;
  bottom: 14px;
  right: 14px;
  width: 54px;
  height: 54px;
  border-radius: 999px;
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: 0 8px 22px rgba(0,0,0,0.22);
  display: flex;
  align-items: center;
  justify-content: center;
  user-select: none;
  transition: transform 0.15s ease, opacity 0.15s ease;
}

.likeBtn:active { transform: scale(0.92); }

.likeBtn svg{
  width: 24px;
  height: 24px;
  stroke: rgba(0,0,0,0.85);
  fill: none;
  stroke-width: 2.2;
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* после голосования */
.voted .likeBtn {
  opacity: 0.35;
  pointer-events: none;
}

/* лёгкая подсветка выбранного */
.chosen::after{
  content:"";
  position:absolute;
  inset:0;
  border: 3px solid rgba(255,255,255,0.75);
  box-shadow: inset 0 0 0 999px rgba(0,0,0,0.10);
  pointer-events:none;
}

/* подвал */
.postFooter {
  padding: 10px 12px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.stat {
  display: flex;
  align-items: center;
  gap: 8px;
  color: rgba(0,0,0,0.75);
  font-size: 14px;
}

.stat svg{
  width: 18px;
  height: 18px;
  stroke: rgba(0,0,0,0.65);
  fill: none;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.hint {
  font-size: 12px;
  color: rgba(0,0,0,0.50);
}

/* нижняя навигация */
.bottomNav {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  height: calc(var(--nav-h) + var(--safe-bottom));
  padding-bottom: var(--safe-bottom);
  background: rgba(255,255,255,0.96);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-top: 1px solid rgba(0,0,0,0.08);
  display: flex;
  justify-content: space-around;
  align-items: center;
}

.navItem {
  width: 60px;
  height: 60px;
  border: 0;
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
}

.navItem svg {
  width: 26px;
  height: 26px;
  stroke: rgba(0,0,0,0.72);
  fill: none;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.navItem.active svg { stroke: rgba(0,0,0,1); }
</style>
</head>

<body>
  <div class="app" id="feed"></div>

  <div class="bottomNav">
    <button class="navItem active" id="tabHome" onclick="goHome()">
      <svg viewBox="0 0 24 24">
        <path d="M3 10.5 12 3l9 7.5"></path>
        <path d="M5 10v10a1 1 0 0 0 1 1h4v-6h4v6h4a1 1 0 0 0 1-1V10"></path>
      </svg>
    </button>

    <button class="navItem" id="tabUpload" onclick="goUpload()">
      <svg viewBox="0 0 24 24">
        <path d="M12 5v14"></path>
        <path d="M5 12h14"></path>
      </svg>
    </button>

    <button class="navItem" id="tabProfile" onclick="goProfile()">
      <svg viewBox="0 0 24 24">
        <path d="M20 21a8 8 0 0 0-16 0"></path>
        <circle cx="12" cy="8" r="4"></circle>
      </svg>
    </button>
  </div>

<script>
const API_BASE = "https://api.lookingreat.ru";

const tg = window.Telegram?.WebApp;
try { tg?.expand(); tg?.disableVerticalSwipes?.(); } catch(e) {}

const tg_id = (tg?.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : "999");

let loading = false;
let lastId = 999999999;
let ended = false;

function setActive(tabId){
  document.getElementById("tabHome").classList.toggle("active", tabId === "home");
  document.getElementById("tabUpload").classList.toggle("active", tabId === "upload");
  document.getElementById("tabProfile").classList.toggle("active", tabId === "profile");
}

function dotsSvg(){
  return `
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M6 12h.01"></path>
      <path d="M12 12h.01"></path>
      <path d="M18 12h.01"></path>
    </svg>
  `;
}

function thumbSvg(){
  return `
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M7 11v10"></path>
      <path d="M7 11h3l3-7c.4-1 .9-1.5 1.8-1.5H16c.8 0 1.4.6 1.2 1.5l-1.1 4H20c1 0 1.6.9 1.3 1.8l-2.1 7.2c-.2.7-.8 1.2-1.5 1.2H9.5c-.8 0-1.5-.7-1.5-1.5V11z"></path>
      <path d="M3 11h4v10H3z"></path>
    </svg>
  `;
}

function smallThumbSvg(){
  return `
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M7 11v10"></path>
      <path d="M7 11h3l3-7c.4-1 .9-1.5 1.8-1.5H16c.8 0 1.4.6 1.2 1.5l-1.1 4H20c1 0 1.6.9 1.3 1.8l-2.1 7.2c-.2.7-.8 1.2-1.5 1.2H9.5c-.8 0-1.5-.7-1.5-1.5V11z"></path>
      <path d="M3 11h4v10H3z"></path>
    </svg>
  `;
}

async function loadFeed(){
  if (loading || ended) return;
  loading = true;

  const res = await fetch(`${API_BASE}/feed?tg_id=${encodeURIComponent(tg_id)}&before_id=${encodeURIComponent(lastId)}`);
  const data = await res.json().catch(()=>({ok:false}));

  if (!data.ok) { loading = false; return; }

  const items = data.items || [];
  if (items.length === 0) ended = true;

  for (const item of items){
    lastId = item.id;

    const post = document.createElement("div");
    post.className = "post";
    post.dataset.pairId = item.id;
    post.dataset.votes = "0";

    const leftUrl  = `${API_BASE}/r2/${encodeURIComponent(item.photo_left_key)}`;
    const rightUrl = `${API_BASE}/r2/${encodeURIComponent(item.photo_right_key)}`;

    post.innerHTML = `
      <div class="postHeader">
        <div>
          <div class="postTitle">Пара #${item.id}</div>
          <div class="postSub">Сравни и выбери лучшее фото</div>
        </div>
        <div class="menuBtn" title="Меню">
          ${dotsSvg()}
        </div>
      </div>

      <div class="pair">
        <div class="half" data-choice="left">
          <img loading="lazy" src="${leftUrl}" alt="">
          <div class="likeBtn" title="Лайк">${thumbSvg()}</div>
        </div>

        <div class="dividerH"></div>

        <div class="half" data-choice="right">
          <img loading="lazy" src="${rightUrl}" alt="">
          <div class="likeBtn" title="Лайк">${thumbSvg()}</div>
        </div>
      </div>

      <div class="postFooter">
        <div class="stat">
          ${smallThumbSvg()}
          <span class="votesText">0 голосов</span>
        </div>
        <div class="hint">Тапни по фото</div>
      </div>
    `;

    post.querySelectorAll(".half").forEach(half => {
      half.addEventListener("click", () => vote(post, half.dataset.choice));
    });

    document.getElementById("feed").appendChild(post);
  }

  loading = false;
}

async function vote(post, choice){
  if (post.classList.contains("voted")) return;
  post.classList.add("voted");

  // подсветим выбранную половину
  const chosenHalf = post.querySelector(`.half[data-choice="${choice}"]`);
  if (chosenHalf) chosenHalf.classList.add("chosen");

  const pair_id = Number(post.dataset.pairId);

  // локально счетчик (реальный сделаем после /pair_stats)
  const nextVotes = Number(post.dataset.votes || "0") + 1;
  post.dataset.votes = String(nextVotes);
  post.querySelector(".votesText").textContent = `${nextVotes} голосов`;

  await fetch(`${API_BASE}/vote`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ tg_id, pair_id, choice })
  }).catch(()=>{});

  // мягко листаем к следующей карточке
  setTimeout(() => {
    window.scrollBy({ top: post.getBoundingClientRect().height + 14, behavior: "smooth" });
  }, 320);
}

window.addEventListener("scroll", () => {
  const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 900);
  if (nearBottom) loadFeed();
});

function goHome(){ setActive("home"); window.scrollTo({ top: 0, behavior: "smooth" }); }
function goUpload(){ setActive("upload"); alert("Загрузка: добавим экран следующим шагом"); }
function goProfile(){ setActive("profile"); alert("Профиль/статистика: добавим экран следующим шагом"); }

loadFeed();
</script>
</body>
</html>
