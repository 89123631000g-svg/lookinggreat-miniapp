<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LookingGreat</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100dvh;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fff;color:#111}
.app{height:100%;display:flex;flex-direction:column}
.tabs{display:flex;gap:8px;padding:12px}
.tab{flex:1;padding:10px;border-radius:12px;border:1px solid #eee;background:#f5f5f5;text-align:center;font-weight:900;cursor:pointer;user-select:none}
.tab.active{background:#111;color:#fff;border-color:#111}

.content{flex:1;min-height:0;display:flex;flex-direction:column;padding:12px}
.hidden{display:none!important}

.feed{flex:1;min-height:0;overflow:auto;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column;gap:12px;padding-bottom:12px}

.card{border:1px solid #eee;border-radius:18px;background:#fff;overflow:hidden;box-shadow:0 10px 28px rgba(0,0,0,0.05)}
.cardHead{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#fafafa;border-bottom:1px solid #eee}
.cardHead .mini{font-size:12px;font-weight:800;color:#666}
.iconBtn{border:none;background:#f0f0f0;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:900}
.iconBtn:active{transform:scale(0.98)}
.iconBtn:disabled{opacity:0.5;cursor:default}

.pairGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:10px}
.tile{position:relative;border-radius:16px;overflow:hidden;background:#f4f4f4}
.tile img{width:100%;height:230px;object-fit:cover;display:block;transition:filter 180ms ease, transform 180ms ease, outline 180ms ease}
.tile.selected img{outline:4px solid rgba(0,0,0,0.9);outline-offset:-4px;transform:scale(1.01)}
.card.voted .tile:not(.selected) img{filter:brightness(0.82)}

.heart{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(0.85);font-size:54px;opacity:0;pointer-events:none;transition:opacity 220ms ease,transform 220ms ease;filter:drop-shadow(0 10px 24px rgba(0,0,0,0.25))}
.heart.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
.heart.hide{opacity:0;transform:translate(-50%,-50%) scale(0.9)}

.actions{display:flex;gap:10px;padding:10px 12px;border-top:1px solid #eee;background:#fff}
.action{flex:1;border:none;border-radius:14px;padding:12px 0;font-size:20px;font-weight:900;cursor:pointer;background:#111;color:#fff}
.action.secondary{background:#eee;color:#111}
.action:disabled{opacity:0.45;cursor:default}

.footerNote{padding:10px 12px;font-size:12px;font-weight:800;color:#666;background:#fafafa;border-top:1px solid #eee}

.status{min-height:18px;text-align:center;font-size:13px;font-weight:800;color:#666;padding-top:8px}
.loader{padding:10px;text-align:center;font-weight:900;color:#666}
</style>
</head>

<body>
<div class="app">
  <div class="tabs">
    <div class="tab active" id="tabFeed">–õ–µ–Ω—Ç–∞</div>
    <div class="tab" id="tabUpload">–ó–∞–≥—Ä—É–∑–∫–∞</div>
    <div class="tab" id="tabAdmin">–ê–¥–º–∏–Ω</div>
  </div>

  <div class="content">

    <!-- FEED -->
    <div id="feedScreen" class="feed"></div>
    <div id="feedStatus" class="status"></div>

    <!-- UPLOAD -->
    <div id="uploadScreen" class="hidden" style="flex:1;min-height:0;display:flex;flex-direction:column;gap:10px;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;flex:1;min-height:0;">
        <div id="cardLeft" style="border:2px dashed #ccc;border-radius:18px;display:flex;align-items:center;justify-content:center;font-weight:900;background:#fafafa;cursor:pointer;overflow:hidden;text-align:center;padding:12px;">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 1</div>
        <div id="cardRight" style="border:2px dashed #ccc;border-radius:18px;display:flex;align-items:center;justify-content:center;font-weight:900;background:#fafafa;cursor:pointer;overflow:hidden;text-align:center;padding:12px;">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 2</div>
      </div>
      <button id="sendBtn" class="action" style="font-size:16px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ä—É</button>
      <button id="clearBtn" class="action secondary" style="font-size:16px;">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <div id="uploadStatus" class="status"></div>
    </div>

    <!-- ADMIN -->
    <div id="adminScreen" class="hidden" style="flex:1;min-height:0;overflow:auto;border:1px solid #eee;border-radius:18px;padding:12px;background:#fafafa;">
      <div style="font-weight:900;margin-bottom:6px;">–ê–¥–º–∏–Ω–∫–∞</div>
      <div style="font-size:12px;font-weight:800;color:#666;margin-bottom:12px;">–í–∞—à tg_id: <span id="adminTg">‚Äî</span></div>

      <div style="background:#fff;border:1px solid #eee;border-radius:16px;padding:12px;">
        <div style="font-weight:900;margin-bottom:8px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        <div style="display:flex;justify-content:space-between;font-weight:800;padding:4px 0;"><span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤—Å–µ–≥–æ</span><span id="sUsers">‚Äî</span></div>
        <div style="display:flex;justify-content:space-between;font-weight:800;padding:4px 0;"><span>–ù–æ–≤—ã–µ —Å–µ–≥–æ–¥–Ω—è</span><span id="sToday">‚Äî</span></div>
        <div style="display:flex;justify-content:space-between;font-weight:800;padding:4px 0;"><span>–ù–æ–≤—ã–µ –∑–∞ –º–µ—Å—è—Ü</span><span id="sMonth">‚Äî</span></div>
        <div style="display:flex;justify-content:space-between;font-weight:800;padding:4px 0;"><span>–ü–∞—Ä –≤—Å–µ–≥–æ</span><span id="sPairs">‚Äî</span></div>
        <div style="display:flex;justify-content:space-between;font-weight:800;padding:4px 0;"><span>–ì–æ–ª–æ—Å–æ–≤ –≤—Å–µ–≥–æ</span><span id="sVotes">‚Äî</span></div>
      </div>
    </div>

  </div>
</div>

<input type="file" id="fileLeft" accept="image/*" class="hidden">
<input type="file" id="fileRight" accept="image/*" class="hidden">

<script>
const tg = window.Telegram?.WebApp;
try { tg?.ready(); } catch(e) {}
try { tg?.expand(); } catch(e) {}
try { tg?.disableVerticalSwipes?.(); } catch(e) {}

const API_BASE = "https://api.lookingreat.ru";

// ‚úÖ –∞–¥–º–∏–Ω
const ADMIN_IDS = ["531932411"];

// ‚úÖ username –±–æ—Ç–∞ –±–µ–∑ @
const BOT_USERNAME = "Lookinggreat_bot";

// tg_id: –∏–∑ Telegram, –∏–ª–∏ fallback –∏–∑ URL –¥–ª—è —Ç–µ—Å—Ç–æ–≤
const urlParams = new URLSearchParams(location.search);
const debugTgId = urlParams.get("tg_id");
let tg_id = (tg?.initDataUnsafe?.user?.id) || debugTgId || "0";
tg_id = String(tg_id);

const isAdmin = ADMIN_IDS.includes(String(tg_id));

const tabFeed = document.getElementById("tabFeed");
const tabUpload = document.getElementById("tabUpload");
const tabAdmin = document.getElementById("tabAdmin");

const feedScreen = document.getElementById("feedScreen");
const feedStatus = document.getElementById("feedStatus");

const uploadScreen = document.getElementById("uploadScreen");
const adminScreen = document.getElementById("adminScreen");

document.getElementById("adminTg").textContent = tg_id;

function setFeedStatus(t){ feedStatus.textContent = t || ""; }
function setUploadStatus(t){ document.getElementById("uploadStatus").textContent = t || ""; }

function showTab(name){
  tabFeed.classList.remove("active");
  tabUpload.classList.remove("active");
  tabAdmin.classList.remove("active");

  feedScreen.classList.add("hidden");
  uploadScreen.classList.add("hidden");
  adminScreen.classList.add("hidden");
  feedStatus.classList.add("hidden");

  if(name==="feed"){
    tabFeed.classList.add("active");
    feedScreen.classList.remove("hidden");
    feedStatus.classList.remove("hidden");
  }
  if(name==="upload"){
    tabUpload.classList.add("active");
    uploadScreen.classList.remove("hidden");
  }
  if(name==="admin"){
    tabAdmin.classList.add("active");
    adminScreen.classList.remove("hidden");
  }
}

tabFeed.onclick = () => showTab("feed");
tabUpload.onclick = () => showTab("upload");
tabAdmin.onclick = () => showTab("admin");

// ======= FEED logic (infinite scroll) =======

let loading = false;
let done = false;
let nextBeforeId = null;
const renderedIds = new Set();

const initialPairId = urlParams.get("pair_id"); // –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ —à–∞—Ä–∏–Ω–≥—É

function makeShareLink(pairId){
  // deep-link –≤ –º–∏–Ω–∏-–∞–ø–ø: t.me/<bot>?startapp=pair_57
  if (BOT_USERNAME) return `https://t.me/${BOT_USERNAME}?startapp=pair_${pairId}`;
  return `https://lookingreat.ru/?pair_id=${pairId}`;
}

function openShare(pairId){
  const link = makeShareLink(pairId);
  const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}`;
  try {
    if (tg?.openTelegramLink) { tg.openTelegramLink(shareUrl); return; }
  } catch(e){}
  window.open(shareUrl, "_blank");
}

function popEmoji(el, emoji){
  el.textContent = emoji;
  el.classList.remove("hide");
  el.classList.add("show");
  setTimeout(() => {
    el.classList.remove("show");
    el.classList.add("hide");
  }, 420);
}

function renderCard(item, myChoice=null){
  if (!item?.id || !item.left_url || !item.right_url) return;
  if (renderedIds.has(item.id)) return;

  renderedIds.add(item.id);

  const card = document.createElement("div");
  card.className = "card";
  card.dataset.id = String(item.id);

  const head = document.createElement("div");
  head.className = "cardHead";

  const mini = document.createElement("div");
  mini.className = "mini";
  mini.textContent = "";

  const shareBtn = document.createElement("button");
  shareBtn.className = "iconBtn";
  shareBtn.innerHTML = "‚ÜóÔ∏è";
  shareBtn.onclick = () => openShare(item.id);

  head.appendChild(mini);
  head.appendChild(shareBtn);

  const grid = document.createElement("div");
  grid.className = "pairGrid";

  const left = document.createElement("div");
  left.className = "tile";
  const leftImg = document.createElement("img");
  leftImg.src = item.left_url;
  const leftFx = document.createElement("div");
  leftFx.className = "heart";
  leftFx.textContent = "‚ù§Ô∏è";
  left.appendChild(leftImg);
  left.appendChild(leftFx);

  const right = document.createElement("div");
  right.className = "tile";
  const rightImg = document.createElement("img");
  rightImg.src = item.right_url;
  const rightFx = document.createElement("div");
  rightFx.className = "heart";
  rightFx.textContent = "üíî";
  right.appendChild(rightImg);
  right.appendChild(rightFx);

  grid.appendChild(left);
  grid.appendChild(right);

  const actions = document.createElement("div");
  actions.className = "actions";

  const likeBtn = document.createElement("button");
  likeBtn.className = "action";
  likeBtn.title = "–õ–∞–π–∫ (–ª–µ–≤–æ–µ)";
  likeBtn.innerHTML = "‚ù§Ô∏è";

  const dislikeBtn = document.createElement("button");
  dislikeBtn.className = "action secondary";
  dislikeBtn.title = "–î–∏–∑–ª–∞–π–∫ (–ø—Ä–∞–≤–æ–µ)";
  dislikeBtn.innerHTML = "üíî";

  actions.appendChild(likeBtn);
  actions.appendChild(dislikeBtn);

  const foot = document.createElement("div");
  foot.className = "footerNote";
  foot.innerHTML = " ";

  card.appendChild(head);
  card.appendChild(grid);
  card.appendChild(actions);
  card.appendChild(foot);

  function applyVoted(choice){
    card.classList.add("voted");
    likeBtn.disabled = true;
    dislikeBtn.disabled = true;
    if (choice === "left") { left.classList.add("selected"); right.classList.remove("selected"); }
    else if (choice === "right") { right.classList.add("selected"); left.classList.remove("selected"); }
  }

  if (myChoice === "left" || myChoice === "right") applyVoted(myChoice);

  async function vote(choice){
    likeBtn.disabled = true;
    dislikeBtn.disabled = true;

    card.classList.add("voted");
    if (choice === "left") {
      left.classList.add("selected"); right.classList.remove("selected");
      popEmoji(leftFx, "‚ù§Ô∏è");
    } else {
      right.classList.add("selected"); left.classList.remove("selected");
      popEmoji(rightFx, "üíî");
    }

    try {
      const res = await fetch(`${API_BASE}/vote`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ tg_id, pair_id: item.id, choice })
      });
      const data = await res.json().catch(()=>null);

      if (!res.ok) {
        const err = data?.error || "vote_failed";
        likeBtn.disabled = false;
        dislikeBtn.disabled = false;

        if (err === "already_voted") setFeedStatus("–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ —ç—Ç—É –ø–∞—Ä—É");
        else if (err === "cannot_vote_own_pair") setFeedStatus("–ù–µ–ª—å–∑—è –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –∑–∞ —Å–≤–æ—é –ø–∞—Ä—É");
        else setFeedStatus("–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è");
        return;
      }

      setFeedStatus("");
      maybeLoadMore();

    } catch(e){
      likeBtn.disabled = false;
      dislikeBtn.disabled = false;
      setFeedStatus("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
    }
  }

  likeBtn.onclick = () => vote("left");
  dislikeBtn.onclick = () => vote("right");

  feedScreen.appendChild(card);
}

async function loadPairById(pairId){
  try{
    setFeedStatus("–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶");
    const res = await fetch(`${API_BASE}/pair?id=${encodeURIComponent(pairId)}&tg_id=${encodeURIComponent(tg_id)}`);
    const data = await res.json().catch(()=>null);
    if (!res.ok || !data?.ok || !data?.item) { setFeedStatus(""); return; }
    renderCard(data.item, data.my_choice || null);
    setFeedStatus("");
  } catch(e){
    setFeedStatus("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
  }
}

async function loadMore(){
  if (loading || done) return;
  loading = true;

  try{
    setFeedStatus("–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶");
    const limit = 10;
    const url = new URL(`${API_BASE}/feed`);
    url.searchParams.set("tg_id", tg_id);
    url.searchParams.set("limit", String(limit));
    if (nextBeforeId) url.searchParams.set("before_id", String(nextBeforeId));

    const res = await fetch(url.toString());
    const data = await res.json().catch(()=>null);

    if (!res.ok) {
      if (data?.error === "banned") setFeedStatus("–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω");
      else setFeedStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
      return;
    }

    const items = data?.items || [];
    if (!items.length) {
      done = true;
      setFeedStatus("–ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤—ã—Ö –ø–∞—Ä");
      return;
    }

    for (const it of items) renderCard(it, null);
    nextBeforeId = data?.next_before_id || null;

    setFeedStatus("");

  } finally {
    loading = false;
  }
}

function maybeLoadMore(){
  const cards = feedScreen.querySelectorAll(".card").length;
  if (cards < 6) loadMore();
}

feedScreen.addEventListener("scroll", () => {
  const nearBottom = feedScreen.scrollTop + feedScreen.clientHeight >= feedScreen.scrollHeight - 450;
  if (nearBottom) loadMore();
});

// init feed
(async () => {
  showTab("feed");
  if (initialPairId) await loadPairById(initialPairId);
  await loadMore();
})();

// ======= Upload =======
const fileLeft = document.getElementById("fileLeft");
const fileRight = document.getElementById("fileRight");
const cardLeft = document.getElementById("cardLeft");
const cardRight = document.getElementById("cardRight");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");

let leftFile=null, rightFile=null;

cardLeft.onclick = () => fileLeft.click();
cardRight.onclick = () => fileRight.click();

fileLeft.onchange = () => { leftFile = fileLeft.files[0] || null; if (leftFile) preview(leftFile, cardLeft); };
fileRight.onchange = () => { rightFile = fileRight.files[0] || null; if (rightFile) preview(rightFile, cardRight); };

function preview(file, el){
  const r = new FileReader();
  r.onload = e => el.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:18px;">`;
  r.readAsDataURL(file);
}

function clearUpload(){
  leftFile=null; rightFile=null;
  fileLeft.value=""; fileRight.value="";
  cardLeft.innerHTML="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 1";
  cardRight.innerHTML="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 2";
  setUploadStatus("");
}
clearBtn.onclick = clearUpload;

sendBtn.onclick = async () => {
  if (!leftFile || !rightFile) { setUploadStatus("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ —Ñ–æ—Ç–æ"); return; }
  setUploadStatus("–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶");

  const form = new FormData();
  form.append("tg_id", tg_id);
  form.append("left", leftFile);
  form.append("right", rightFile);

  try{
    const res = await fetch(`${API_BASE}/upload_pair`, { method:"POST", body: form });
    const data = await res.json().catch(()=>null);

    if (!res.ok || !data?.ok) { setUploadStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"); return; }

    setUploadStatus("–ü–∞—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ ‚úÖ");
    clearUpload();

    showTab("feed");
    done = false;
    await loadMore();

  } catch(e){
    setUploadStatus("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
  }
};

// ======= Admin stats =======
async function loadAdmin(){
  if (!isAdmin) return;
  try{
    const res = await fetch(`${API_BASE}/admin/stats?tg_id=${encodeURIComponent(tg_id)}`);
    const data = await res.json().catch(()=>null);
    if (!res.ok || !data?.ok) return;

    document.getElementById("sUsers").textContent = data.users?.total ?? "‚Äî";
    document.getElementById("sToday").textContent = data.users?.new_today ?? "‚Äî";
    document.getElementById("sMonth").textContent = data.users?.new_this_month ?? "‚Äî";
    document.getElementById("sPairs").textContent = data.content?.pairs_total ?? "‚Äî";
    document.getElementById("sVotes").textContent = data.content?.votes_total ?? "‚Äî";
  } catch(e){}
}

if (isAdmin) loadAdmin();
</script>
</body>
</html>
