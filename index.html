<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LookingGreat</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#fff; color:#111; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
    .card { border: 1px solid #eee; border-radius: 14px; padding: 12px; margin: 12px 0; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .btn { width: 100%; padding: 12px; border: 0; border-radius: 12px; font-size: 16px; cursor: pointer; }
    .btnPrimary { background: #111; color: #fff; }
    .btnGhost { background: #f3f3f3; color: #111; }
    .muted { color: #666; font-size: 13px; }
    .status { margin-top: 10px; font-size: 14px; }
    .h { font-size: 18px; font-weight: 700; margin: 0 0 8px; }
    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; background:#f3f3f3; font-size: 12px; color:#333; }
    img { width: 100%; border-radius: 12px; display:block; background:#f5f5f5; }
    .pair { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px; }
    .voteBtns { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .smallBtn { padding:10px; border-radius: 12px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .smallBtn:disabled { opacity: .5; cursor: default; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="h">LookingGreat</div>
      <div class="muted">Загрузи 2 фото → люди проголосуют анонимно → увидишь результат.</div>
      <div style="margin-top:10px;">
        <span class="pill" id="tgInfo">Telegram ID: ...</span>
      </div>
    </div>

    <div class="card">
      <div class="h">Создать пару</div>

      <div class="row">
        <div>
          <div class="muted" style="margin-bottom:4px;">Фото слева</div>
          <input id="fileLeft" type="file" accept="image/*" />
        </div>

        <div>
          <div class="muted" style="margin-bottom:4px;">Фото справа</div>
          <input id="fileRight" type="file" accept="image/*" />
        </div>

        <button class="btn btnPrimary" id="btnUploadCreate">Загрузить и создать пару</button>
        <div class="status" id="uploadStatus"></div>
      </div>
    </div>

    <div class="card">
      <div class="h">Лента голосований</div>
      <button class="btn btnGhost" id="btnLoadFeed">Обновить ленту</button>
      <div class="status" id="feedStatus"></div>
      <div id="feed"></div>
    </div>

    <div class="card">
      <div class="h">Мои результаты</div>
      <button class="btn btnGhost" id="btnLoadMy">Обновить мои результаты</button>
      <div class="status" id="myStatus"></div>
      <div id="myResults"></div>
    </div>

    <div class="muted" style="padding: 0 4px;">
      Worker API: <span id="apiBaseText"></span>
    </div>
  </div>

<script>
  const API_BASE = "https://orange-math-fa5e.89123631000g.workers.dev";
  document.getElementById("apiBaseText").textContent = API_BASE;

  function getTelegramId() {
    const tg = window.Telegram?.WebApp;
    const id = tg?.initDataUnsafe?.user?.id;
    return id ? String(id) : null;
  }

  async function fetchJson(url, options) {
    const resp = await fetch(url, options);
    const data = await resp.json().catch(() => null);
    if (!resp.ok) {
      // чтобы видеть реальные ошибки, а не просто "Load failed"
      throw new Error(data?.error || `HTTP ${resp.status}`);
    }
    return data;
  }

  // ✅ нормализуем URL картинок: если вдруг старый /r2/... — превращаем в /r2img?key=...
  function normalizeImageUrl(u) {
    if (!u) return u;
    try {
      const url = new URL(u);
      // уже новый формат /r2img?key=...
      if (url.pathname === "/r2img") return u;

      // старый формат /r2/<key>
      if (url.pathname.startsWith("/r2/")) {
        const key = url.pathname.slice("/r2/".length);
        const fixed = `${url.origin}/r2img?key=${encodeURIComponent(key)}`;
        return fixed;
      }
      return u;
    } catch {
      return u;
    }
  }

  async function uploadTwoPhotosToR2(leftFile, rightFile, telegramId) {
    const fd = new FormData();
    fd.append("left", leftFile);
    fd.append("right", rightFile);
    fd.append("telegram_id", telegramId);

    try {
      const resp = await fetch(`${API_BASE}/api/upload_photos`, { method: "POST", body: fd });
      const data = await resp.json().catch(() => null);
      if (!resp.ok || !data?.ok) throw new Error(data?.error || `HTTP ${resp.status}`);
      return data;
    } catch (e) {
      // iOS часто пишет просто "Load failed" — покажем понятнее
      throw new Error(e?.message || "Load failed");
    }
  }

  async function createPair(leftUrl, rightUrl, telegramId) {
    return await fetchJson(`${API_BASE}/api/create_pair`, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({
        telegram_id: telegramId,
        photo_left_url: normalizeImageUrl(leftUrl),
        photo_right_url: normalizeImageUrl(rightUrl),
      }),
    });
  }

  async function loadFeed(telegramId) {
    return await fetchJson(`${API_BASE}/api/feed?telegram_id=${encodeURIComponent(telegramId)}&limit=30`, {
      method: "GET",
    });
  }

  async function vote(photoPairId, choice, telegramId) {
    return await fetchJson(`${API_BASE}/api/vote`, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({
        telegram_id: telegramId,
        photo_pair_id: photoPairId,
        choice: choice,
      }),
    });
  }

  async function loadMy(telegramId) {
    return await fetchJson(`${API_BASE}/api/my_results?telegram_id=${encodeURIComponent(telegramId)}&limit=30`, {
      method: "GET",
    });
  }

  function el(tag, attrs = {}, children = []) {
    const n = document.createElement(tag);
    Object.entries(attrs).forEach(([k, v]) => {
      if (k === "class") n.className = v;
      else if (k === "html") n.innerHTML = v;
      else n.setAttribute(k, v);
    });
    children.forEach(c => n.appendChild(c));
    return n;
  }

  function makeImg(src, alt) {
    const img = document.createElement("img");
    img.alt = alt || "";
    img.src = normalizeImageUrl(src);

    // подсказка: если снова не грузится — увидим это в UI
    img.onerror = () => {
      img.style.opacity = "0.4";
      img.title = "Не удалось загрузить изображение";
    };

    return img;
  }

  function renderFeed(items, telegramId) {
    const root = document.getElementById("feed");
    root.innerHTML = "";

    if (!items || items.length === 0) {
      root.appendChild(el("div", { class: "muted", html: "Пока нет пар в ленте." }));
      return;
    }

    items.forEach(item => {
      const card = el("div", { class: "card" });
      card.appendChild(el("div", { class: "muted", html: `pair_id: ${item.id}` }));

      const pair = el("div", { class: "pair" }, [
        el("div", {}, [ makeImg(item.photo_left_url, "left") ]),
        el("div", {}, [ makeImg(item.photo_right_url, "right") ])
      ]);

      const btns = el("div", { class: "voteBtns" });
      const bL = el("button", { class: "smallBtn" });
      bL.textContent = "Выбрать левое";

      const bR = el("button", { class: "smallBtn" });
      bR.textContent = "Выбрать правое";

      bL.onclick = async () => {
        try {
          await vote(item.id, "left", telegramId);
          bL.textContent = "Готово ✓";
          bL.disabled = true;
          bR.disabled = true;
        } catch (e) {
          alert("Ошибка: " + (e.message || e));
        }
      };

      bR.onclick = async () => {
        try {
          await vote(item.id, "right", telegramId);
          bR.textContent = "Готово ✓";
          bL.disabled = true;
          bR.disabled = true;
        } catch (e) {
          alert("Ошибка: " + (e.message || e));
        }
      };

      btns.appendChild(bL);
      btns.appendChild(bR);

      card.appendChild(pair);
      card.appendChild(btns);

      if (item.my_choice) {
        bL.disabled = true;
        bR.disabled = true;
        const note = document.createElement("div");
        note.className = "muted";
        note.style.marginTop = "8px";
        note.textContent = `Ты уже голосовал: ${item.my_choice === "left" ? "левое" : "правое"}`;
        card.appendChild(note);
      }

      root.appendChild(card);
    });
  }

  function renderMy(items) {
    const root = document.getElementById("myResults");
    root.innerHTML = "";

    if (!items || items.length === 0) {
      root.appendChild(el("div", { class: "muted", html: "У тебя пока нет созданных пар." }));
      return;
    }

    items.forEach(item => {
      const card = el("div", { class: "card" });

      const total = item.total_votes || 0;
      const l = item.left_votes || 0;
      const r = item.right_votes || 0;

      card.appendChild(el("div", { class: "muted", html: `pair_id: ${item.id} · голосов: ${total} (лево: ${l}, право: ${r})` }));

      const pair = el("div", { class: "pair" }, [
        el("div", {}, [ makeImg(item.photo_left_url, "left") ]),
        el("div", {}, [ makeImg(item.photo_right_url, "right") ])
      ]);

      card.appendChild(pair);
      root.appendChild(card);
    });
  }

  (function init() {
    try {
      const tg = window.Telegram?.WebApp;
      tg?.ready?.();
      tg?.expand?.();
    } catch {}

    const telegramId = getTelegramId();
    document.getElementById("tgInfo").textContent =
      telegramId ? `Telegram ID: ${telegramId}` : "Telegram ID: не найден (открой из Telegram)";

    document.getElementById("btnUploadCreate").addEventListener("click", async () => {
      const statusEl = document.getElementById("uploadStatus");
      const left = document.getElementById("fileLeft")?.files?.[0];
      const right = document.getElementById("fileRight")?.files?.[0];

      try {
        statusEl.textContent = "Проверяю Telegram ID...";
        const id = getTelegramId();
        if (!id) throw new Error("Не вижу Telegram User ID. Открой мини-приложение из Telegram.");
        if (!left || !right) throw new Error("Выбери два файла (слева и справа).");

        statusEl.textContent = "Загружаю фото в R2...";
        const up = await uploadTwoPhotosToR2(left, right, id);

        statusEl.textContent = "Создаю пару...";
        const created = await createPair(up.left_url, up.right_url, id);

        statusEl.textContent = `Готово! Пара создана (id: ${created.id}).`;
        document.getElementById("fileLeft").value = "";
        document.getElementById("fileRight").value = "";
      } catch (e) {
        statusEl.textContent = "Ошибка: " + (e.message || e);
      }
    });

    document.getElementById("btnLoadFeed").addEventListener("click", async () => {
      const statusEl = document.getElementById("feedStatus");
      try {
        const id = getTelegramId();
        if (!id) throw new Error("Открой мини-приложение из Telegram.");
        statusEl.textContent = "Загружаю ленту...";
        const data = await loadFeed(id);
        renderFeed(data.items, id);
        statusEl.textContent = "";
      } catch (e) {
        statusEl.textContent = "Ошибка: " + (e.message || e);
      }
    });

    document.getElementById("btnLoadMy").addEventListener("click", async () => {
      const statusEl = document.getElementById("myStatus");
      try {
        const id = getTelegramId();
        if (!id) throw new Error("Открой мини-приложение из Telegram.");
        statusEl.textContent = "Загружаю результаты...";
        const data = await loadMy(id);
        renderMy(data.items);
        statusEl.textContent = "";
      } catch (e) {
        statusEl.textContent = "Ошибка: " + (e.message || e);
      }
    });
  })();
</script>
</body>
</html>
