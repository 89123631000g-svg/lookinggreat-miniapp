<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LookingGreat</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* { box-sizing: border-box; }

html, body {
  margin: 0;
  padding: 0;
  height: 100dvh;
  overflow: hidden;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: #ffffff;
  color: #111;
}

.app {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.tabs {
  display: flex;
  gap: 8px;
  padding: 12px;
}

.tab {
  flex: 1;
  padding: 10px;
  border-radius: 12px;
  border: 1px solid #eee;
  background: #f5f5f5;
  text-align: center;
  font-weight: 600;
  cursor: pointer;
}

.tab.active {
  background: #111;
  color: #fff;
}

.content {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 12px;
  min-height: 0;
}

.vote-grid {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  min-height: 0;
}

.vote-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 16px;
  cursor: pointer;
}

.controls {
  padding-top: 12px;
}

button {
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  border: none;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
}

.primary {
  background: #111;
  color: #fff;
}

.secondary {
  background: #eee;
  margin-top: 8px;
}

.upload-grid {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  min-height: 0;
}

.upload-card {
  border: 2px dashed #ccc;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  text-align: center;
  cursor: pointer;
  overflow: hidden;
}

.upload-card img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.hidden { display: none !important; }

.status {
  text-align: center;
  font-size: 14px;
  padding-top: 6px;
}
  .vote-wrap {
  flex: 1;
  min-height: 0;
  position: relative;
}

.overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 18px;
  background: transparent;            /* –±–µ–∑ —Ä–∞–∑–º—ã—Ç–∏—è */
  border-radius: 16px;
  pointer-events: none;               /* –Ω–µ –º–µ—à–∞–µ—Ç –∫–ª–∏–∫–∞–º */
}

.overlay-card {
  background: rgba(17,17,17,0.88);
  color: #fff;
  padding: 14px 16px;
  border-radius: 14px;
  font-weight: 700;
  text-align: center;
  max-width: 320px;
  width: 100%;
}

.overlay-sub {
  margin-top: 6px;
  font-size: 13px;
  font-weight: 600;
  opacity: 0.85;
}
.toast {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  z-index: 50;
  padding: 14px 16px;
  border-radius: 14px;
  background: linear-gradient(135deg, #111, #2a2a2a);
  color: #fff;
  font-weight: 800;
  font-size: 20px;
  letter-spacing: 0.3px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  pointer-events: none;
  max-width: 320px;
  width: calc(100% - 36px);
  animation: pop 0.25s ease;
  opacity: 1;
}

.toast {
  transition: opacity 0.2s ease;
}

.toast.fadeout {
  opacity: 0;
}
@keyframes pop {
  from {
    transform: translate(-50%, -50%) scale(0.9);
    opacity: 0;
  }
  to {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
}
/* Fade-–∞–Ω–∏–º–∞—Ü–∏—è —Å–º–µ–Ω—ã –ø–∞—Ä—ã */
.vote-img {
  opacity: 1;
  transition: opacity 180ms ease;
  will-change: opacity;
}
.vote-img.fading {
  opacity: 0;
}

/* –õ—ë–≥–∫–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ, –ø–æ–∫–∞ –∏–¥—ë—Ç –∑–∞–≥—Ä—É–∑–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –ø—Ä–∏—è—Ç–Ω–æ) */
.vote-grid.loading .vote-img {
  filter: blur(2px);
  opacity: 0.6;
  transition: opacity 120ms ease, filter 120ms ease;
}

</style>
</head>

<body>
<div class="app">

  <div class="tabs">
    <div class="tab active" id="tabVote">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</div>
    <div class="tab" id="tabUpload">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä—ã</div>
  </div>

  <div class="content">

    <!-- VOTE -->
<div class="vote-wrap" id="voteWrap">
  <div id="voteScreen" class="vote-grid">
    <img id="leftImg" class="vote-img" />
    <img id="rightImg" class="vote-img" />
  </div>

  <div id="emptyOverlay" class="overlay hidden">
  <div class="overlay-card">
    –ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤—ã—Ö –ø–∞—Ä
    <div class="overlay-sub">–ï—Å–ª–∏ –≤—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏ –ø–∞—Ä—É ‚Äî –µ—ë —É–≤–∏–¥—è—Ç –¥—Ä—É–≥–∏–µ</div>
  </div>
</div>

<div id="toast" class="toast hidden">–ì–æ–ª–æ—Å —É—á—Ç—ë–Ω</div>
</div>
    
    <!-- UPLOAD -->
    <div id="uploadScreen" class="upload-grid hidden">
      <div class="upload-card" id="cardLeft">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 1</div>
      <div class="upload-card" id="cardRight">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 2</div>
    </div>

    <div class="controls">
      <button id="nextBtn" class="primary">–°–ª–µ–¥—É—é—â–∞—è</button>
      <button id="sendBtn" class="primary hidden">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ä—É</button>
      <button id="clearBtn" class="secondary hidden">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <div class="status" id="status"></div>
      <div class="status hidden" id="myStats"></div>
    </div>

  </div>
</div>

<input type="file" id="fileLeft" accept="image/*" class="hidden">
<input type="file" id="fileRight" accept="image/*" class="hidden">

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const API_BASE = "https://api.lookingreat.ru";

let tg_id = tg.initDataUnsafe?.user?.id || "0";
let currentPair = null;
let leftFile = null;
let rightFile = null;
let emptyPollTimer = null;
let loadingFeed = false;
let votingLock = false;
let toastTimer = null;
const skippedPairIds = new Set();
let brokenStreak = 0;

const voteScreen = document.getElementById("voteScreen");
const uploadScreen = document.getElementById("uploadScreen");
const emptyOverlay = document.getElementById("emptyOverlay");
const toast = document.getElementById("toast");  


const tabVote = document.getElementById("tabVote");
const tabUpload = document.getElementById("tabUpload");

const leftImg = document.getElementById("leftImg");
const rightImg = document.getElementById("rightImg");

const nextBtn = document.getElementById("nextBtn");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");

const cardLeft = document.getElementById("cardLeft");
const cardRight = document.getElementById("cardRight");

const fileLeft = document.getElementById("fileLeft");
const fileRight = document.getElementById("fileRight");

const statusEl = document.getElementById("status");
const myStatsEl = document.getElementById("myStats");
function setMyStats(text) {
  if (!text) { myStatsEl.classList.add("hidden"); myStatsEl.textContent = ""; return; }
  myStatsEl.textContent = text;
  myStatsEl.classList.remove("hidden");
}
function setStatus(text) {
  statusEl.textContent = text || "";
}
function showToast(text, ms = 1500) {
  if (toastTimer) clearTimeout(toastTimer);

  toast.innerHTML = "‚úÖ " + text;

  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
  toast.classList.remove("hidden");
  toast.classList.remove("fadeout");

  // –ø—Ä—è—á–µ–º —á–µ—Ä–µ–∑ ms: —Å–Ω–∞—á–∞–ª–∞ fadeout, –ø–æ—Ç–æ–º display:none
  toastTimer = setTimeout(() => {
    toast.classList.add("fadeout");
    setTimeout(() => {
      toast.classList.add("hidden");
      toastTimer = null;
    }, 200); // –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å transition 0.2s
  }, ms);
}
function preloadImage(url) {
  return new Promise((resolve, reject) => {
    if (!url) return reject(new Error("no_url"));
    const img = new Image();
    img.onload = () => resolve(true);
    img.onerror = reject;
    img.src = url;
  });
}

async function fadeSwapPair(item) {
  // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞—â–∏—Ç–∞
  if (!item?.left_url || !item?.right_url) return;

  // 1) –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ê (–æ–±–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
    voteScreen.classList.add("loading");
  try {
    await Promise.all([
      preloadImage(item.left_url),
      preloadImage(item.right_url),
    ]);
  } catch (e) {
    voteScreen.classList.remove("loading");
    setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—é‚Ä¶");
    setTimeout(loadNext, 150);
    return false;
  }

  // 2) FADE OUT
  leftImg.classList.add("fading");
  rightImg.classList.add("fading");

  // –¥–∞—ë–º CSS —É—Å–ø–µ—Ç—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å—Å—è
  await new Promise(r => setTimeout(r, 180));

  // 3) –°–ú–ï–ù–ê SRC
  leftImg.src = item.left_url;
  rightImg.src = item.right_url;

  // 4) FADE IN
  // –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç decode ‚Äî –Ω–µ–º–Ω–æ–≥–æ —Ä–æ–≤–Ω–µ–µ
    try {
    if (leftImg.decode) await leftImg.decode();
    if (rightImg.decode) await rightImg.decode();
  } catch (e) {}

  // üî• –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ –±–∏—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  if (leftImg.naturalWidth === 0 || rightImg.naturalWidth === 0) {
    voteScreen.classList.remove("loading");
    setStatus("–§–æ—Ç–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–æ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—é‚Ä¶");
    setTimeout(loadNext, 150);
    return false;
  }

  leftImg.classList.remove("fading");
  rightImg.classList.remove("fading");
  voteScreen.classList.remove("loading");
}
  function switchTab(mode) {
  if (emptyPollTimer) { clearInterval(emptyPollTimer); emptyPollTimer = null; }
emptyOverlay.classList.add("hidden");
  if (mode === "vote") {
    tabVote.classList.add("active");
    tabUpload.classList.remove("active");
    voteScreen.classList.remove("hidden");
    uploadScreen.classList.add("hidden");
    nextBtn.classList.remove("hidden");
    sendBtn.classList.add("hidden");
    clearBtn.classList.add("hidden");
    loadNext();
  } else {
    tabUpload.classList.add("active");
    tabVote.classList.remove("active");
    voteScreen.classList.add("hidden");
    uploadScreen.classList.remove("hidden");
    nextBtn.classList.add("hidden");
    sendBtn.classList.remove("hidden");
    clearBtn.classList.remove("hidden");
  }
}

tabVote.onclick = () => switchTab("vote");
tabUpload.onclick = () => switchTab("upload");

async function loadNext() {
  if (loadingFeed) return;
  loadingFeed = true;

  try {
    setStatus("–ó–∞–≥—Ä—É–∑–∫–∞...");
    const res = await fetch(`${API_BASE}/feed?tg_id=${tg_id}`);
    const data = await res.json();

    console.log("FEED DATA:", data);

    // –ï–°–õ–ò –ù–ï–¢ –ü–ê–†
    if (!data.item) {
      setStatus("");
      emptyOverlay.classList.remove("hidden");

      if (!emptyPollTimer) {
        emptyPollTimer = setInterval(() => {
          if (!voteScreen.classList.contains("hidden")) loadNext();
        }, 3000);
      }

      return;
    }

    // –ï–°–õ–ò –ü–ê–†–ê –ï–°–¢–¨

    if (emptyPollTimer) {
      clearInterval(emptyPollTimer);
      emptyPollTimer = null;
    }

    emptyOverlay.classList.add("hidden");
    currentPair = data.item;
    if (skippedPairIds.has(currentPair.id)) {
    loadingFeed = false;
    setTimeout(loadNext, 50);
    return;
    }

    // –ü–ª–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—É—é –ø–∞—Ä—É —Å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–æ–π
    const okSwap = await fadeSwapPair(currentPair);
    if (okSwap === false) return;

    setStatus("");

  } catch (e) {
    setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
  } finally {
    loadingFeed = false;
  }
}

  async function vote(choice) {
  if (!currentPair) return;
  if (votingLock) return;
  votingLock = true;

  showToast("–ì–æ–ª–æ—Å —É—á—Ç—ë–Ω", 1500);
  setStatus("");

  const res = await fetch(`${API_BASE}/vote`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      tg_id,
      pair_id: currentPair.id,
      choice
    })
  });

  // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –æ—à–∏–±–∫–∞ ‚Äî –ø–æ–∫–∞–∂–µ–º –µ—ë, –Ω–æ –Ω–µ –ª–æ–º–∞–µ–º —ç–∫—Ä–∞–Ω
  if (!res.ok) {
    setStatus("–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è");
    return;
  }

  // —á–µ—Ä–µ–∑ 0.5 —Å–µ–∫ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –ø–∞—Ä—É
  setTimeout(() => {
    setStatus("–ó–∞–≥—Ä—É–∑–∫–∞...");
    loadNext();
  }, 500);
      // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã –ø–∞—Ä—ã
  setTimeout(() => { votingLock = false; }, 650);
}

leftImg.onclick = () => vote("left");
rightImg.onclick = () => vote("right");
nextBtn.onclick = loadNext;

cardLeft.onclick = () => fileLeft.click();
cardRight.onclick = () => fileRight.click();

fileLeft.onchange = () => {
  leftFile = fileLeft.files[0];
  previewImage(leftFile, cardLeft);
};

fileRight.onchange = () => {
  rightFile = fileRight.files[0];
  previewImage(rightFile, cardRight);
};

function previewImage(file, card) {
  const reader = new FileReader();
  reader.onload = e => {
    card.innerHTML = `<img src="${e.target.result}">`;
  };
  reader.readAsDataURL(file);
}

sendBtn.onclick = async () => {
  if (!leftFile || !rightFile) {
    setStatus("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ —Ñ–æ—Ç–æ");
    return;
  }

  setStatus("–û—Ç–ø—Ä–∞–≤–∫–∞...");

  const form = new FormData();
  form.append("tg_id", tg_id);
  form.append("left", leftFile);
  form.append("right", rightFile);

  const res = await fetch(`${API_BASE}/upload_pair`, {
    method: "POST",
    body: form
  });

  if (!res.ok) {
    setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
    return;
  }

    const data = await res.json();
  if (!data.ok) { setStatus("–û—à–∏–±–∫–∞: " + (data.error || "upload_failed")); return; }

  setStatus("–ü–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–ª–∞–¥–µ–ª—å—Ü—É –ø–æ —ç—Ç–æ–π –ø–∞—Ä–µ
  try {
    const pairId = data.pair?.id;
    if (pairId) {
      const sRes = await fetch(`${API_BASE}/pair_stats?id=${pairId}&tg_id=${tg_id}`);
      const sData = await sRes.json();
      if (sRes.ok && sData.ok && sData.stats) {
        setMyStats(`–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –õ–µ–≤–æ–µ ${sData.stats.left} ¬∑ –ü—Ä–∞–≤–æ–µ ${sData.stats.right}`);
      } else {
        setMyStats("");
      }
    } else {
      setMyStats("");
    }
  } catch (e) {
    setMyStats("");
  }

  clearUpload();

clearBtn.onclick = clearUpload;

function clearUpload() {
  leftFile = null;
  rightFile = null;
  fileLeft.value = "";
  fileRight.value = "";
  cardLeft.innerHTML = "–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 1";
  cardRight.innerHTML = "–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å<br>–§–æ—Ç–æ 2";
  setStatus("");
  setMyStats("");
}

loadNext();
</script>
</body>
</html>
