<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LookingGreat</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0e16;
      --text:#fff;
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.55);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);

      --pad:14px;
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% 0%, #111a33 0%, var(--bg) 60%);
      color:var(--text);
      min-height:100dvh;
    }

    .wrap{
      max-width:720px;
      margin:0 auto;
      padding: calc(var(--pad) + var(--safeTop)) var(--pad) calc(var(--pad) + var(--safeBottom));
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: 22px;
      padding: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }

    .topline{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }

    .title{
      margin:0;
      font-size:14px;
      font-weight:600;
      line-height:1.25;
    }
    .subtitle{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .chip{
      background: rgba(255,255,255,.08);
      border: 1px solid var(--stroke);
      padding: 6px 10px;
      border-radius: 999px;
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      user-select:none;
    }

    .photos{
      display:grid;
      gap:10px;
      margin-top:12px;
    }

    /* Голосование: по умолчанию 2 колонки */
    .photos.vote{
      grid-template-columns: 1fr 1fr;
      height: min(62dvh, 520px);
    }

    /* Загрузка: всегда 1 колонка */
    .photos.upload{
      grid-template-columns: 1fr;
      height:auto;
    }

    .photo{
      position:relative;
      border-radius: 20px;
      overflow:hidden;
      background: #0a0f1c;
      border:1px solid var(--stroke2);
      cursor:pointer;
      min-height: 240px;
    }

    .photo img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      user-select:none;
      -webkit-user-drag:none;
    }

    .empty{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:8px;
      padding:18px;
      color: var(--muted);
      text-align:center;
    }
    .empty b{
      color:#fff;
      font-weight:600;
    }

    .actions{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }

    .btn{
      border:1px solid var(--stroke2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      color:#fff;
      border-radius: 14px;
      padding: 12px 14px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      user-select:none;
      flex: 1 1 auto;
      min-width: 180px;
    }
    .btn.secondary{
      background: rgba(255,255,255,.05);
      font-weight:600;
      color: rgba(255,255,255,.88);
    }

    .linkbtn{
      background: transparent;
      border: 0;
      color: rgba(255,255,255,.70);
      font-size:14px;
      padding: 10px 6px;
      cursor:pointer;
      text-decoration: underline;
      text-underline-offset: 3px;
      user-select:none;
      flex: 0 0 auto;
    }

    .status{
      margin-top:10px;
      color: var(--muted2);
      font-size:12px;
      min-height: 16px;
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 12px 0;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .file{
      width:100%;
      background: rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius: 14px;
      padding: 12px;
    }

    .file label{
      display:block;
      color: var(--muted);
      font-size:12px;
      margin-bottom:8px;
    }

    input[type="file"]{
      width:100%;
      color: rgba(255,255,255,.82);
    }

    /* Низкий экран (частый кейс Android + панели Telegram): голосование в 1 колонку */
    @media (max-height: 720px){
      .photos.vote{
        grid-template-columns: 1fr;
        height:auto;
      }
      .photo img{ max-height: 44dvh; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">
      <div class="topline">
        <div>
          <p class="title">Тапни по фото — голос засчитается.</p>
          <p class="subtitle">Если не хочется выбирать — можно пропустить пару.</p>
        </div>
        <div class="chip" id="chip">Загрузка…</div>
      </div>

      <!-- VOTE VIEW -->
      <div id="voteView">
        <div class="photos vote">
          <div class="photo" id="leftCard" title="Голосовать за фото 1">
            <img id="leftImg" alt="Фото 1" />
          </div>

          <div class="photo" id="rightCard" title="Голосовать за фото 2">
            <img id="rightImg" alt="Фото 2" />
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="openUpload">Загрузить пару</button>
          <button class="linkbtn" id="skipBtn">Пропустить</button>
        </div>

        <div class="status" id="status"></div>
      </div>

      <div class="divider"></div>

      <!-- UPLOAD VIEW -->
      <div id="uploadView" style="display:none;">
        <p class="subtitle" style="margin:0 0 10px;">Загрузка пары: выбери два фото.</p>

        <div class="photos upload">
          <div class="photo" id="u1Preview">
            <div class="empty">
              <b>Фото 1</b>
              <div>Выбери изображение ниже</div>
            </div>
          </div>

          <div class="photo" id="u2Preview">
            <div class="empty">
              <b>Фото 2</b>
              <div>Выбери изображение ниже</div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div class="file">
            <label>Фото 1</label>
            <input type="file" id="file1" accept="image/*" />
          </div>
          <div class="file">
            <label>Фото 2</label>
            <input type="file" id="file2" accept="image/*" />
          </div>
        </div>

        <div class="actions" style="margin-top:12px;">
          <button class="btn" id="sendUpload">Отправить пару</button>
          <button class="btn secondary" id="cancelUpload">Отмена</button>
        </div>

        <div class="status" id="uploadStatus"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://api.lookingreat.ru";

    // Telegram init
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      try { tg.expand(); } catch(e){}
      try { tg.disableVerticalSwipes(); } catch(e){}
      try { tg.ready(); } catch(e){}
    }

    function getTgId() {
      try {
        const u = tg?.initDataUnsafe?.user;
        return u?.id ? String(u.id) : "1"; // вне Telegram для теста
      } catch (e) {
        return "1";
      }
    }

    const tg_id = getTgId();

    // UI refs
    const chip = document.getElementById("chip");
    const statusEl = document.getElementById("status");
    const leftCard = document.getElementById("leftCard");
    const rightCard = document.getElementById("rightCard");
    const leftImg = document.getElementById("leftImg");
    const rightImg = document.getElementById("rightImg");

    const voteView = document.getElementById("voteView");
    const uploadView = document.getElementById("uploadView");

    const openUpload = document.getElementById("openUpload");
    const cancelUpload = document.getElementById("cancelUpload");
    const skipBtn = document.getElementById("skipBtn");

    const file1 = document.getElementById("file1");
    const file2 = document.getElementById("file2");
    const sendUpload = document.getElementById("sendUpload");
    const uploadStatus = document.getElementById("uploadStatus");

    const u1Preview = document.getElementById("u1Preview");
    const u2Preview = document.getElementById("u2Preview");

    let currentPairId = null;
    let busy = false;

    function setStatus(msg) { statusEl.textContent = msg || ""; }
    function setUploadStatus(msg) { uploadStatus.textContent = msg || ""; }

    function showVote() {
      uploadView.style.display = "none";
      voteView.style.display = "block";
      setUploadStatus("");
    }

    function showUpload() {
      voteView.style.display = "none";
      uploadView.style.display = "block";
      setStatus("");
    }

    async function apiGet(path) {
      const r = await fetch(API_BASE + path, { method:"GET" });
      return await r.json();
    }

    async function apiPostJson(path, body) {
      const r = await fetch(API_BASE + path, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      return await r.json();
    }

    function showEmpty() {
      currentPairId = null;
      leftImg.removeAttribute("src");
      rightImg.removeAttribute("src");
      setStatus("Пары закончились");
    }

    function renderItem(item) {
      currentPairId = item.id;
      leftImg.src = item.left_url;
      rightImg.src = item.right_url;
      setStatus("");
    }

    async function loadFeed() {
      if (busy) return;
      busy = true;
      chip.textContent = "Загрузка…";
      setStatus("Загружаю пару…");

      try {
        const data = await apiGet(`/feed?tg_id=${encodeURIComponent(tg_id)}`);
        if (!data.ok) throw new Error(data.error || "api_error");
        chip.textContent = `tg_id: ${tg_id}`;

        if (data.empty) return showEmpty();
        renderItem(data.item);
      } catch (e) {
        console.error(e);
        chip.textContent = "Ошибка";
        setStatus("Ошибка загрузки пары");
      } finally {
        busy = false;
      }
    }

    async function vote(choice) {
      if (busy || !currentPairId) return;
      busy = true;
      setStatus("Сохраняю голос…");

      try {
        const data = await apiPostJson(`/vote`, { tg_id, pair_id: currentPairId, choice });

        if (!data.ok) {
          if (data.error === "cannot_vote_own_pair") {
            setStatus("Нельзя голосовать за свою пару.");
            return;
          }
          if (data.error === "already_voted") {
            await loadFeed();
            return;
          }
          throw new Error(data.error || "vote_error");
        }

        if (data.empty) return showEmpty();
        renderItem(data.item);
      } catch (e) {
        console.error(e);
        setStatus("Ошибка голоса");
      } finally {
        busy = false;
      }
    }

    async function skip() {
      await loadFeed();
    }

    function previewFile(file, el, title) {
      if (!file) {
        el.innerHTML = `<div class="empty"><b>${title}</b><div>Выбери изображение ниже</div></div>`;
        return;
      }
      const url = URL.createObjectURL(file);
      el.innerHTML = `<img alt="preview" src="${url}">`;
    }

    file1.addEventListener("change", () => previewFile(file1.files[0], u1Preview, "Фото 1"));
    file2.addEventListener("change", () => previewFile(file2.files[0], u2Preview, "Фото 2"));

    async function uploadPair() {
      if (busy) return;

      const f1 = file1.files?.[0];
      const f2 = file2.files?.[0];
      if (!f1 || !f2) { setUploadStatus("Нужно выбрать два фото."); return; }

      busy = true;
      sendUpload.disabled = true;
      setUploadStatus("Загрузка…");

      try {
        const fd = new FormData();
        fd.append("tg_id", tg_id);
        fd.append("left", f1);
        fd.append("right", f2);

        // ВАЖНО: твой Worker ожидает /upload_pair
        const resp = await fetch(API_BASE + "/upload_pair", { method:"POST", body: fd });
        const data = await resp.json();

        if (!data.ok) throw new Error(data.error || "upload_error");

        setUploadStatus("Готово! Пара загружена.");
        file1.value = "";
        file2.value = "";
        u1Preview.innerHTML = `<div class="empty"><b>Фото 1</b><div>Выбери изображение ниже</div></div>`;
        u2Preview.innerHTML = `<div class="empty"><b>Фото 2</b><div>Выбери изображение ниже</div></div>`;

        showVote();
        await loadFeed();
      } catch (e) {
        console.error(e);
        setUploadStatus("Ошибка загрузки");
      } finally {
        busy = false;
        sendUpload.disabled = false;
      }
    }

    // Events
    leftCard.addEventListener("click", () => vote("left"));
    rightCard.addEventListener("click", () => vote("right"));
    skipBtn.addEventListener("click", skip);

    openUpload.addEventListener("click", showUpload);
    cancelUpload.addEventListener("click", showVote);
    sendUpload.addEventListener("click", uploadPair);

    // Start
    chip.textContent = `tg_id: ${tg_id}`;
    loadFeed();
  </script>
</body>
</html>
