<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LookingGreat</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0c10;
      --text:#ffffff;
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.52);
      --stroke:rgba(255,255,255,.10);
      --card: rgba(255,255,255,.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 50% 0%, rgba(120,86,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, rgba(0,220,255,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    .wrap{
      max-width: 720px;
      margin: 0 auto;
      padding: 14px;
      padding-top: calc(14px + env(safe-area-inset-top));
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
    }

    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .brand{display:flex; flex-direction:column; gap:4px;}
    .brand .t1{
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 18px;
      line-height: 1.1;
    }
    .brand .t2{
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.25;
    }

    /* –∫–Ω–æ–ø–∫–∞ —Å–≤–µ—Ä—Ö—É: –ù–ï–¢ "–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å" */
    .chip{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      display:flex;
      gap:8px;
      align-items:center;
      user-select:none;
      -webkit-user-select:none;
      cursor:pointer;
      white-space:nowrap;
    }
    .chip:active{transform:scale(.98)}
    .dot{width:8px;height:8px;border-radius:99px;background: rgba(255,255,255,.35);}

    .battle{
      border:1px solid var(--stroke);
      background: var(--card);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .hero{
      padding: 12px 12px 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .hero .h1{font-weight:800;font-size:16px;line-height:1.2;letter-spacing:.15px;}
    .hero .h2{margin-top:4px;font-size:12.5px;color: var(--muted);line-height:1.25;}
    .count{
      font-size:12px;
      color: var(--muted2);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:6px 10px;
      border-radius:999px;
      user-select:none;
      -webkit-user-select:none;
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      padding: 10px;
    }
    .tile{
      position:relative;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      height: min(56vh, 520px);
      min-height: 270px;
      cursor: pointer;
      user-select:none;
      -webkit-user-select:none;
      touch-action: manipulation;
    }
    .tile:active{transform:scale(.995)}
    .tile img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      -webkit-user-drag:none;
    }

    .skeleton{
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06));
      background-size: 200% 100%;
      animation: shimmer 1.1s infinite linear;
    }
    @keyframes shimmer{
      0%{background-position: 200% 0}
      100%{background-position: -200% 0}
    }

    /* –æ–≤–µ—Ä–ª–µ–π –µ—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å */
    .fail{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      text-align:center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      color: rgba(255,255,255,.92);
    }
    .fail.show{display:flex}
    .failbox{
      max-width: 260px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      border-radius: 16px;
      padding: 12px;
    }
    .failbox .t{font-weight:800;font-size:14px;line-height:1.2;}
    .failbox .s{margin-top:6px;font-size:12.5px;color: rgba(255,255,255,.75);line-height:1.25;}
    .btn{
      margin-top:10px;
      width:100%;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
    }
    .btn:active{transform:scale(.99)}

    .help{
      padding: 10px 12px 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-top: 1px solid rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.3;
    }
    .mini{
      display:flex; gap:8px; align-items:center;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      white-space:nowrap;
    }
    .mini:active{transform:scale(.98)}

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(14px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      max-width: min(640px, calc(100vw - 28px));
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}

    @media (max-width: 420px){
      .tile{min-height: 250px; height: min(58vh, 520px);}
      .brand .t1{font-size:17px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="t1">LookingGreat</div>
        <div class="t2">–ë–∞—Ç–ª: –≤—ã–±–µ—Ä–∏ —Ñ–æ—Ç–æ, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã–≥–ª—è–¥–∏—Ç –ª—É—á—à–µ</div>
      </div>

      <!-- –ú–µ–Ω—é –≤–º–µ—Å—Ç–æ "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã" -->
      <div class="chip" id="btnMenu" title="–ú–µ–Ω—é">
        <span class="dot"></span>
        <span>–ú–µ–Ω—é</span>
      </div>
    </div>

    <div class="battle">
      <div class="hero">
        <div>
          <div class="h1">–¢–∞–ø–Ω–∏ –ø–æ —Ñ–æ—Ç–æ ‚Äî –∏ —Ä–µ—à–∏ —Å–ø–æ—Ä</div>
          <div class="h2">–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –¢–æ–ª—å–∫–æ —á–µ—Å—Ç–Ω—ã–π –≤—ã–±–æ—Ä.</div>
        </div>
        <div class="count" id="pairCounter">–ù–æ–≤—ã–π –±–∞—Ç–ª</div>
      </div>

      <div class="grid">
        <div class="tile" id="leftTile">
          <div class="skeleton" id="leftSkel"></div>
          <img id="leftImg" alt="" loading="eager" decoding="async" referrerpolicy="no-referrer" />
          <div class="fail" id="leftFail">
            <div class="failbox">
              <div class="t">–§–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å</div>
              <div class="s">–ò—Å—Ç–æ—á–Ω–∏–∫ –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è. –õ—É—á—à–µ –≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ R2.</div>
              <button class="btn" id="leftSkipBtn" type="button">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
            </div>
          </div>
        </div>

        <div class="tile" id="rightTile">
          <div class="skeleton" id="rightSkel"></div>
          <img id="rightImg" alt="" loading="eager" decoding="async" referrerpolicy="no-referrer" />
          <div class="fail" id="rightFail">
            <div class="failbox">
              <div class="t">–§–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å</div>
              <div class="s">–ò—Å—Ç–æ—á–Ω–∏–∫ –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è. –õ—É—á—à–µ –≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ R2.</div>
              <button class="btn" id="rightSkipBtn" type="button">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
            </div>
          </div>
        </div>
      </div>

      <div class="help">
        <div>–ë—ã—Å—Ç—Ä—ã–π –±–∞—Ç–ª. –ß–µ–º –±–æ–ª—å—à–µ –≥–æ–ª–æ—Å–æ–≤ ‚Äî —Ç–µ–º —Ç–æ—á–Ω–µ–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</div>
        <div class="mini" id="btnSkip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // –í–ê–ñ–ù–û: —Ñ—Ä–æ–Ω—Ç –Ω–∞ GitHub Pages, API –Ω–∞ lookingreat.ru
    const API_BASE = "https://lookingreat.ru";

    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      tg.expand();
      tg.setHeaderColor && tg.setHeaderColor('#0b0c10');
      tg.setBackgroundColor && tg.setBackgroundColor('#0b0c10');
    }

    const $ = (id) => document.getElementById(id);

    const leftTile = $('leftTile');
    const rightTile = $('rightTile');
    const leftImg = $('leftImg');
    const rightImg = $('rightImg');
    const leftSkel = $('leftSkel');
    const rightSkel = $('rightSkel');
    const leftFail = $('leftFail');
    const rightFail = $('rightFail');
    const leftSkipBtn = $('leftSkipBtn');
    const rightSkipBtn = $('rightSkipBtn');

    const toast = $('toast');
    const pairCounter = $('pairCounter');

    const btnMenu = $('btnMenu');
    const btnSkip = $('btnSkip');

    let telegramId = null;
    let currentItem = null;
    let busy = false;

    function showToast(text) {
      toast.textContent = text;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.remove('show'), 1500);
    }

    function getTelegramId() {
      try {
        const id = tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id;
        if (id) return String(id);
      } catch(e) {}

      const u = new URL(location.href);
      const q = u.searchParams.get('telegram_id') || u.searchParams.get('tg_id');
      if (q) return String(q);

      return "111";
    }

    async function apiGetWithTimeout(url, ms) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), ms);
      try {
        const r = await fetch(url, { method:'GET', credentials:'omit', cache:'no-store', signal: ctrl.signal });
        return await r.json();
      } finally {
        clearTimeout(t);
      }
    }

    async function apiPost(url, body) {
      const r = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
        credentials: 'omit',
        cache: 'no-store'
      });
      return r.json();
    }

    function resetTiles() {
      leftFail.classList.remove('show');
      rightFail.classList.remove('show');
      leftSkel.style.display = 'block';
      rightSkel.style.display = 'block';
      leftImg.removeAttribute('src');
      rightImg.removeAttribute('src');
    }

    function cacheBust(url) {
      try {
        const u = new URL(url);
        u.searchParams.set('_t', String(Date.now()));
        return u.toString();
      } catch(e) {
        // –µ—Å–ª–∏ url –Ω–µ –ø–∞—Ä—Å–∏—Ç—Å—è –∫–∞–∫ URL (—Ä–µ–¥–∫–æ) ‚Äî –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏–º —Ö–≤–æ—Å—Ç
        const sep = url.includes('?') ? '&' : '?';
        return url + sep + '_t=' + Date.now();
      }
    }

    async function loadNextPair(retry = 0) {
      if (busy) return;
      busy = true;

      resetTiles();
      pairCounter.textContent = "–ó–∞–≥—Ä—É–∂–∞–µ–º‚Ä¶";

      try {
        const data = await apiGetWithTimeout(
          `${API_BASE}/api/vote/next?telegram_id=${encodeURIComponent(telegramId)}`,
          9000
        );

        if (!data || !data.ok || !data.item) {
          busy = false;
          leftSkel.style.display = 'none';
          rightSkel.style.display = 'none';
          pairCounter.textContent = "–ü–∞—Ä—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å";
          showToast("–ü–∞—Ä—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å üòÖ");
          return;
        }

        currentItem = data.item;
        pairCounter.textContent = `–ë–∞—Ç–ª #${currentItem.id}`;

        let loaded = 0;
        const doneOne = () => {
          loaded++;
          if (loaded >= 2) busy = false;
        };

        // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –î–û src
        leftImg.onload = () => { leftSkel.style.display = 'none'; doneOne(); };
        rightImg.onload = () => { rightSkel.style.display = 'none'; doneOne(); };

        leftImg.onerror = () => {
          leftSkel.style.display = 'none';
          leftFail.classList.add('show');
          doneOne();
        };
        rightImg.onerror = () => {
          rightSkel.style.display = 'none';
          rightFail.classList.add('show');
          doneOne();
        };

        // —Å—Ç–∞–≤–∏–º src
        leftImg.src = cacheBust(currentItem.photo_left_url);
        rightImg.src = cacheBust(currentItem.photo_right_url);

      } catch (e) {
        busy = false;
        if (retry < 2) {
          pairCounter.textContent = "–ó–∞–≥—Ä—É–∂–∞–µ–º‚Ä¶";
          setTimeout(() => loadNextPair(retry + 1), 700);
        } else {
          pairCounter.textContent = "–ó–∞–≥—Ä—É–∂–∞–µ–º‚Ä¶";
          showToast("–ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ç—å –∏ –æ—Ç–∫—Ä–æ–π –µ—â—ë —Ä–∞–∑");
        }
      }
    }

    async function vote(choice) {
      if (busy) return;
      if (!currentItem) return;

      if (choice === 'left' && leftFail.classList.contains('show')) { showToast("–§–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å"); return; }
      if (choice === 'right' && rightFail.classList.contains('show')) { showToast("–§–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å"); return; }

      busy = true;

      try {
        const res = await apiPost(`${API_BASE}/api/vote`, {
          telegram_id: telegramId,
          pair_id: currentItem.id,
          choice: choice
        });

        if (!res || !res.ok) {
          busy = false;
          showToast("–ì–æ–ª–æ—Å –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª—Å—è");
          return;
        }

        setTimeout(() => { busy = false; loadNextPair(); }, 150);

      } catch(e) {
        busy = false;
        showToast("–°–µ—Ç—å –ø–æ–¥–≤–µ–ª–∞, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë");
      }
    }

    async function openResults() {
      try {
        const data = await apiGetWithTimeout(
          `${API_BASE}/api/my_results?telegram_id=${encodeURIComponent(telegramId)}`,
          9000
        );
        if (!data || !data.ok) { showToast("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"); return; }

        const voted = data.total_votes ?? data.voted ?? 0;
        const winrate = data.winrate ?? data.my_winrate ?? null;

        let text = `–¢–≤–æ–∏ –≥–æ–ª–æ—Å–∞: ${voted}`;
        if (winrate !== null && winrate !== undefined) {
          text += ` ‚Ä¢ –ü–æ–±–µ–¥—ã: ${Math.round(Number(winrate) * 100)}%`;
        }

        if (tg && tg.showAlert) tg.showAlert(text);
        else alert(text);

      } catch(e) {
        showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã");
      }
    }

    function goUpload() {
      // –ó–∞–≥–ª—É—à–∫–∞: –ø–æ—Ç–æ–º —Å–¥–µ–ª–∞–µ–º upload.html
      const base = location.href.split('?')[0].replace(/index\.html$/,'');
      const url = base.endsWith('/') ? (base + 'upload.html') : (base + '/upload.html');
      location.href = url;
    }

    function openMenu() {
      const useTg = tg && tg.showPopup;

      if (useTg) {
        tg.showPopup({
          title: "LookingGreat",
          message: "–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å?",
          buttons: [
            { id: "results", type: "default", text: "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã" },
            { id: "upload", type: "default", text: "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ" },
            { id: "cancel", type: "cancel", text: "–ó–∞–∫—Ä—ã—Ç—å" }
          ]
        }, (id) => {
          if (id === "results") openResults();
          if (id === "upload") goUpload();
        });
      } else {
        const ans = prompt("1 ‚Äî –†–µ–∑—É–ª—å—Ç–∞—Ç—ã\n2 ‚Äî –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ");
        if (ans === "1") openResults();
        if (ans === "2") goUpload();
      }
    }

    // events
    leftTile.addEventListener('click', () => vote('left'));
    rightTile.addEventListener('click', () => vote('right'));
    btnSkip.addEventListener('click', () => loadNextPair());
    btnMenu.addEventListener('click', () => openMenu());

    leftSkipBtn.addEventListener('click', (e) => { e.stopPropagation(); loadNextPair(); });
    rightSkipBtn.addEventListener('click', (e) => { e.stopPropagation(); loadNextPair(); });

    // start
    telegramId = getTelegramId();
    loadNextPair();
  </script>
</body>
</html>
