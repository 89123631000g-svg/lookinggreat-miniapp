<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LookingGreat</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; background:#0b0b14; color:#fff; }
    .wrap { max-width: 920px; margin: 0 auto; padding: 16px; }
    .top { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .h1 { font-size: 22px; font-weight: 800; }
    .sub { opacity:.75; margin-top:4px; font-size:13px; }
    .card { margin-top: 14px; border: 1px solid rgba(255,255,255,.08); border-radius: 16px; padding: 12px; background: rgba(255,255,255,.04); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .imgbox { border:1px solid rgba(255,255,255,.10); border-radius: 14px; overflow:hidden; background: rgba(255,255,255,.03); height: 520px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .imgbox img { width:100%; height:100%; object-fit: cover; display:block; }
    .muted { opacity:.7; font-size: 13px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-top: 10px; }
    button { background: rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.12); border-radius: 12px; padding: 10px 12px; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .pill { padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); font-size:12px; opacity:.9; }
    .hidden { display:none; }
    @media (max-width: 860px) { .grid { grid-template-columns: 1fr; } .imgbox { height: 420px; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="h1">LookingGreat</div>
        <div class="sub">Батл: тапни на фото, которое выглядит лучше</div>
      </div>
      <div class="pill" id="statusPill">Готово</div>
    </div>

    <div class="card">
      <div class="grid">
        <div class="imgbox" id="leftBox" title="Выбрать левое">
          <img id="leftImg" alt="left" />
        </div>
        <div class="imgbox" id="rightBox" title="Выбрать правое">
          <img id="rightImg" alt="right" />
        </div>
      </div>

      <div class="row">
        <div class="muted" id="hint">Тапни по фото — голос засчитается.</div>
        <button id="skipBtn">Пропустить</button>
      </div>

      <div class="row">
        <div class="muted">Загрузить свою пару:</div>
        <form id="uploadForm">
          <input type="file" id="fileLeft" accept="image/*" required />
          <input type="file" id="fileRight" accept="image/*" required />
          <button type="submit" id="uploadBtn">Загрузить</button>
        </form>
      </div>
    </div>
  </div>

<script>
  const API_BASE = "https://api.lookingreat.ru";

  const tg = window.Telegram?.WebApp;
  try { tg?.ready(); } catch(e) {}

  const statusPill = document.getElementById("statusPill");
  const leftBox = document.getElementById("leftBox");
  const rightBox = document.getElementById("rightBox");
  const leftImg = document.getElementById("leftImg");
  const rightImg = document.getElementById("rightImg");
  const skipBtn = document.getElementById("skipBtn");

  const uploadForm = document.getElementById("uploadForm");
  const uploadBtn = document.getElementById("uploadBtn");
  const fileLeft = document.getElementById("fileLeft");
  const fileRight = document.getElementById("fileRight");

  let tgId = "0";
  let currentPairId = null;
  let busy = false;

  function setStatus(text) { statusPill.textContent = text; }

  function getTelegramId() {
    const id = tg?.initDataUnsafe?.user?.id;
    return String(id || "1"); // "1" для теста вне Telegram
  }

  async function apiGet(path) {
    const r = await fetch(API_BASE + path, { method:"GET" });
    return await r.json();
  }

  async function apiPostJson(path, body) {
    const r = await fetch(API_BASE + path, {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    return await r.json();
  }

  function showEmpty() {
    currentPairId = null;
    leftImg.removeAttribute("src");
    rightImg.removeAttribute("src");
    setStatus("Пары закончились");
  }

  function renderItem(item) {
    currentPairId = item.id;
    leftImg.src = item.left_url;
    rightImg.src = item.right_url;
    setStatus("Выбирай");
  }

  async function loadFeed() {
    if (busy) return;
    busy = true;
    setStatus("Загружаем…");
    try {
      const data = await apiGet(`/feed?tg_id=${encodeURIComponent(tgId)}`);
      if (!data.ok) throw new Error(data.error || "api_error");
      if (data.empty) return showEmpty();
      renderItem(data.item);
    } catch (e) {
      setStatus("Ошибка загрузки");
      console.error(e);
    } finally {
      busy = false;
    }
  }

  async function vote(choice) {
    if (busy || !currentPairId) return;
    busy = true;
    setStatus("Сохраняем…");
    try {
      const data = await apiPostJson(`/vote`, { tg_id: tgId, pair_id: currentPairId, choice });
      if (!data.ok) {
        if (data.error === "already_voted") {
          return await loadFeed();
        }
        throw new Error(data.error || "vote_error");
      }
      if (data.empty) return showEmpty();
      renderItem(data.item);
    } catch (e) {
      setStatus("Ошибка голоса");
      console.error(e);
    } finally {
      busy = false;
    }
  }

  leftBox.addEventListener("click", () => vote("left"));
  rightBox.addEventListener("click", () => vote("right"));
  skipBtn.addEventListener("click", () => loadFeed());

  uploadForm.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    if (busy) return;
    const l = fileLeft.files?.[0];
    const r = fileRight.files?.[0];
    if (!l || !r) return;

    busy = true;
    uploadBtn.disabled = true;
    setStatus("Загрузка…");

    try {
      const fd = new FormData();
      fd.append("tg_id", tgId);
      fd.append("left", l);
      fd.append("right", r);

      const resp = await fetch(API_BASE + "/upload_pair", { method:"POST", body: fd });
      const data = await resp.json();
      if (!data.ok) throw new Error(data.error || "upload_error");

      setStatus("Загружено");
      // после загрузки сразу обновим фид
      await loadFeed();
    } catch (e) {
      console.error(e);
      setStatus("Ошибка загрузки");
    } finally {
      busy = false;
      uploadBtn.disabled = false;
      uploadForm.reset();
    }
  });

  // старт
  tgId = getTelegramId();
  loadFeed();
</script>
</body>
</html>
