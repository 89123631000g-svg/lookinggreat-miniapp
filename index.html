<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LookingGreat</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
*{box-sizing:border-box;}
html,body{
  margin:0; padding:0;
  height:100dvh;
  overflow:hidden;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:#fff; color:#0f172a;
}

:root{
  --bg:#ffffff;
  --text:#0f172a;
  --muted: rgba(15,23,42,.65);
  --card:#ffffff;
  --line: rgba(0,0,0,.08);
  --shadow: 0 10px 26px rgba(0,0,0,.06);
  --radius: 18px;
  --safe-b: env(safe-area-inset-bottom);
  --safe-t: env(safe-area-inset-top);
}

.app{
  height:100%;
  display:flex;
  flex-direction:column;
  background:var(--bg);
}

.header{
  padding: calc(12px + var(--safe-t)) 12px 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  border-bottom: 1px solid var(--line);
  background: var(--bg);
}
.headerTitle{ font-weight: 700; font-size: 16px; line-height: 20px; margin:0; }
.headerSub{ font-size: 12px; color: var(--muted); line-height: 16px; }

.main{
  flex:1;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-height:0;
}

.feedWrap{
  flex:1;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  padding: 0 0 calc(78px + var(--safe-b));
  min-height:0;
}

.sectionPad{ padding: 10px 12px 0; }

.voterStats{
  margin: 0 12px 10px;
  padding: 10px 12px;
  border-radius: 14px;
  background: rgba(15,23,42,.04);
  color: #0f172a;
  font-size: 14px;
  line-height: 18px;
}
.voterStats__row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.voterStats__row--sub{ margin-top:6px; color: rgba(15,23,42,.75); }
.voterStats__sep{ margin: 0 6px; color: rgba(15,23,42,.45); }
.voterStats__main{ white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }

.card{
  margin: 10px 12px;
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
}

.cardHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 10px 12px;
  border-bottom: 1px solid var(--line);
}
.cardTitle{ font-weight: 650; font-size: 14px; line-height: 18px; color: var(--text); }
.cardMeta{ font-size: 12px; line-height: 16px; color: var(--muted); }

.photos{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
  padding: 10px 10px 6px;
  background: rgba(15,23,42,.02);
}
.photo{
  position:relative;
  width:100%;
  border-radius: 14px;
  overflow:hidden;
  background:#f2f4f7;
}
.photo::before{ content:""; display:block; padding-top: 125%; }
.photo img{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit: cover;
}

.cardBody{ padding: 10px 12px 12px; }

.actions{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.voteGroup{ display:flex; gap:10px; align-items:center; }

.iconBtn{
  appearance:none;
  border: 1px solid var(--line);
  background: #fff;
  border-radius: 14px;
  padding: 10px 12px;
  display:flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
  user-select:none;
}
.iconBtn:active{ transform: translateY(1px); }
.icon{ width: 18px; height: 18px; display:inline-block; }
.iconHeart{ fill:none; stroke:#0f172a; stroke-width:2.2; }
.iconHeartFilled{ fill:#0f172a; stroke:#0f172a; stroke-width:2.2; }
.iconShare{ fill:none; stroke:#0f172a; stroke-width:2.0; }
.iconMuted{ opacity: .55; }

.voteChosen{
  background: rgba(15,23,42,.06);
  border-color: rgba(15,23,42,.16);
}

.statsRow{
  margin-top: 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  font-size: 12px;
  line-height: 16px;
  color: var(--muted);
}
.bar{
  margin-top: 8px;
  height: 8px;
  border-radius: 999px;
  background: rgba(15,23,42,.08);
  overflow:hidden;
}
.bar > div{ height:100%; width:50%; background: rgba(15,23,42,.55); }

/* footer (ICON BUTTONS ‚Äî restore) */
.footer{
  position: fixed;
  left:0; right:0; bottom:0;
  padding: 10px 12px calc(10px + var(--safe-b));
  background: rgba(255,255,255,.92);
  backdrop-filter: blur(10px);
  border-top: 1px solid var(--line);
}
.tabs{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.tabIcon{
  width: 44px;
  height: 44px;
  border-radius: 14px;
  border: 1px solid var(--line);
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  user-select:none;
}
.tabIcon:active{ transform: translateY(1px); }
.tabIconActive{
  background: rgba(15,23,42,.06);
  border-color: rgba(15,23,42,.16);
}
.tabIcon svg{ width:20px; height:20px; }
.tabIcon path{ stroke:#0f172a; fill:none; stroke-width:2.2; }

/* modal upload (ETHALON DESIGN ‚Äî do not change) */
.modalOverlay{
  position: fixed;
  inset:0;
  background: rgba(0,0,0,.35);
  display:none;
  align-items:flex-end;
  justify-content:center;
  padding: 0 12px calc(10px + var(--safe-b));
  z-index: 10000;
}
.modalOverlay.show{ display:flex; }

.modal{
  width: min(720px, 100%);
  background:#fff;
  border-radius: 22px;
  box-shadow: 0 18px 50px rgba(0,0,0,.22);
  overflow:hidden;
}
.modalHead{
  padding: 14px 16px 12px;
  border-bottom: 1px solid var(--line);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.modalTitle{ font-weight:700; font-size: 16px; line-height: 20px; }
.closeBtn{
  border: 1px solid var(--line);
  background:#fff;
  border-radius: 12px;
  padding: 8px 10px;
  cursor:pointer;
}

.modalBody{ padding: 14px 16px 16px; }
.pickGrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.pickBox{
  border-radius: 14px;
  border: 2px dashed rgba(0,0,0,.22);
  padding: 12px;
  min-height: 110px;
  background: rgba(15,23,42,.03);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:8px;
  text-align:center;
  cursor:pointer;
  user-select:none;
}
.pickBox strong{ font-size: 14px; }
.pickBox span{ font-size: 12px; color: var(--muted); }
.pickThumb{
  width: 52px; height: 52px;
  border-radius: 12px;
  background: rgba(15,23,42,.08);
  overflow:hidden;
}
.pickThumb img{ width:100%; height:100%; object-fit:cover; display:block; }

.caption{
  margin-top: 12px;
  width:100%;
  border: 1px solid var(--line);
  border-radius: 14px;
  padding: 12px 12px;
  font-size: 14px;
  outline:none;
}

.modalActions{ margin-top: 12px; display:flex; gap:10px; }
.shareBtn{
  flex:1;
  border: none;
  background: #0f172a;
  color:#fff;
  border-radius: 16px;
  padding: 12px 14px;
  font-size: 14px;
  cursor:pointer;
}
.shareBtn:disabled{ opacity:.6; cursor:not-allowed; }

.note{ margin-top: 10px; font-size: 12px; line-height: 16px; color: var(--muted); }

/* toast + pulse */
.lgToast{
  position: fixed;
  left: 12px;
  right: 12px;
  bottom: calc(16px + env(safe-area-inset-bottom));
  padding: 12px 14px;
  border-radius: 14px;
  background: rgba(15,23,42,.92);
  color: #fff;
  font-size: 14px;
  line-height: 18px;
  box-shadow: 0 10px 24px rgba(0,0,0,.18);
  opacity: 0;
  transform: translateY(12px);
  transition: opacity .18s ease, transform .18s ease;
  z-index: 9999;
  pointer-events: none;
}
.lgToast--show{ opacity: 1; transform: translateY(0); }

.lgPulse{
  position: fixed;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(15,23,42,.92);
  color: #fff;
  font-size: 13px;
  line-height: 16px;
  opacity: 0;
  transform: translateY(6px);
  transition: opacity .18s ease, transform .18s ease;
  z-index: 9999;
  pointer-events: none;
}
.lgPulse--show{ opacity: 1; transform: translateY(0); }

.hidden{ display:none !important; }
</style>
</head>

<body>
<div class="app">
  <div class="header">
    <div>
      <div class="headerTitle">LookingGreat</div>
      <div class="headerSub" id="headerSub">–õ–µ–Ω—Ç–∞</div>
    </div>
    <div class="headerSub" id="verLabel"></div>
  </div>

  <!-- voter progress (local MVP) -->
  <div class="voterStats" id="voterStats" aria-live="polite">
    <div class="voterStats__row">
      <div class="voterStats__main">
        –¢—ã –æ—Ü–µ–Ω–∏–ª: <span id="myVotesCount">0</span> –ø–∞—Ä
        <span class="voterStats__sep">¬∑</span>
        –£—Ä–æ–≤–µ–Ω—å: <span id="myVoterLevel">–ù–æ–≤–∏—á–æ–∫</span>
      </div>
    </div>

    <div class="voterStats__row voterStats__row--sub" id="nextLevelWrap">
      –î–æ —É—Ä–æ–≤–Ω—è ‚Äú<span id="myNextLevelName">–°—É–¥—å—è</span>‚Äù –æ—Å—Ç–∞–ª–æ—Å—å <span id="myNextLevelLeft">10</span>
    </div>

    <div class="voterStats__row voterStats__row--sub" id="matchWrap" style="display:none;">
      –¢–≤–æ–π –≤–∫—É—Å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ–º –Ω–∞ <span id="myMatchPct">0</span>%
    </div>
  </div>

  <div class="main">
    <div class="feedWrap" id="feedWrap">
      <div id="feedList"></div>

      <div class="sectionPad" id="feedLoading" style="padding-bottom:10px; color:rgba(15,23,42,.65); font-size:13px;">
        –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶
      </div>
      <div class="sectionPad hidden" id="feedEmpty" style="padding-bottom:10px; color:rgba(15,23,42,.65); font-size:13px;">
        –ü–æ–∫–∞ –Ω–µ—Ç –ø–∞—Ä –¥–ª—è –æ—Ü–µ–Ω–∫–∏.
      </div>
      <div class="sectionPad hidden" id="needTelegram" style="padding-bottom:10px; color:rgba(15,23,42,.65); font-size:13px;">
        –û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Telegram.
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="tabs">
      <button class="tabIcon tabIconActive" id="tabFeed" aria-label="–õ–µ–Ω—Ç–∞">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 11l8-7 8 7v9a1 1 0 0 1-1 1h-5v-7H10v7H5a1 1 0 0 1-1-1z"/></svg>
      </button>
      <button class="tabIcon" id="tabUpload" aria-label="–ó–∞–≥—Ä—É–∑–∏—Ç—å">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5v14M5 12h14"/></svg>
      </button>
      <button class="tabIcon" id="tabProfile" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 21a8 8 0 0 0-16 0"/><path d="M12 13a4 4 0 1 0-4-4 4 4 0 0 0 4 4z"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- upload modal -->
<div class="modalOverlay" id="uploadOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="uploadTitle">
    <div class="modalHead">
      <div class="modalTitle" id="uploadTitle">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä—ã</div>
      <button class="closeBtn" id="uploadClose">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="modalBody">
      <div class="pickGrid">
        <div class="pickBox" id="pickLeft">
          <div class="pickThumb" id="thumbLeft"></div>
          <strong>–§–æ—Ç–æ 1</strong>
          <span id="leftHint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å</span>
          <input class="hidden" id="fileLeft" type="file" accept="image/*" />
        </div>

        <div class="pickBox" id="pickRight">
          <div class="pickThumb" id="thumbRight"></div>
          <strong>–§–æ—Ç–æ 2</strong>
          <span id="rightHint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å</span>
          <input class="hidden" id="fileRight" type="file" accept="image/*" />
        </div>
      </div>

      <input class="caption" id="captionInput" placeholder="–ß—Ç–æ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º? (–Ω–∞–ø—Ä–∏–º–µ—Ä: –¥–æ/–ø–æ—Å–ª–µ, –≤–∞—Ä–∏–∞–Ω—Ç 1/2)" maxlength="80" />

      <div class="modalActions">
        <button class="shareBtn" id="uploadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>

      <!-- NOTE: do not show limits here; only show when limit/error is reached -->
      <div class="note hidden" id="uploadNote"></div>
    </div>
  </div>
</div>

<div id="lgToast" class="lgToast"></div>

<script>
/* =========================================================
   LookingGreat ‚Äî Index v2.11.3
   Fixes vs v2.11.2:
   - Restore icon-only bottom menu (no text)
   - Do not display limits in upload modal by default
   - Caption placeholder universal
   - Guard: do not call API when Telegram initData missing (prevents no_hash/401 spam)
   - Keep voter mechanics (progress/levels/taste/milestones)
========================================================= */

const APP_VERSION = "2.11.3";
const API_BASE = "https://api.lookingreat.ru";

const el = (id) => document.getElementById(id);

let tg = null;
let tgUserId = null;
let initData = "";
let currentTab = "feed";

let feedItems = [];
let isLoading = false;
let feedOffset = 0;
const FEED_LIMIT = 10;

// ---------- toast ----------
let toastTimer = null;
function toast(msg, ms=900){
  const t = el("lgToast");
  if (!t) return;
  t.textContent = msg;
  t.classList.add("lgToast--show");
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove("lgToast--show"), ms);
}

function pulseNear(domEl, text="+1"){
  try{
    if(!domEl) return;
    const r = domEl.getBoundingClientRect();
    const p = document.createElement("div");
    p.className = "lgPulse";
    p.textContent = text;
    p.style.left = `${Math.round(r.left + r.width/2 - 12)}px`;
    p.style.top = `${Math.round(r.top - 10)}px`;
    document.body.appendChild(p);
    requestAnimationFrame(()=>p.classList.add("lgPulse--show"));
    setTimeout(()=>{
      p.classList.remove("lgPulse--show");
      setTimeout(()=>p.remove(), 240);
    }, 420);
  }catch(e){}
}

// ---------- voter mechanics (local) ----------
const LG_LS = {
  votesDone: "lg_votes_done_v1",
  tasteMatches: "lg_taste_matches_v1",
  tasteConsidered: "lg_taste_considered_v1",
  shownMilestones: "lg_shown_milestones_v1"
};

function lsGetInt(key){
  const v = Number(localStorage.getItem(key));
  return Number.isFinite(v) && v >= 0 ? Math.floor(v) : 0;
}
function lsSetInt(key, n){
  const val = Math.max(0, Math.floor(Number(n) || 0));
  localStorage.setItem(key, String(val));
  return val;
}
function getShownMilestones(){
  try{
    const raw = localStorage.getItem(LG_LS.shownMilestones);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr.map(Number).filter(x=>Number.isFinite(x)) : [];
  }catch(e){ return []; }
}
function markMilestoneShown(m){
  const mm = Number(m);
  const arr = getShownMilestones();
  if(!arr.includes(mm)) arr.push(mm);
  localStorage.setItem(LG_LS.shownMilestones, JSON.stringify(arr));
}
function calcLevel(votes){
  if (votes >= 200) return { name:"–ì—É—Ä—É –≤–∫—É—Å–∞", nextName:null, nextAt:null };
  if (votes >= 50)  return { name:"–≠–∫—Å–ø–µ—Ä—Ç", nextName:"–ì—É—Ä—É –≤–∫—É—Å–∞", nextAt:200 };
  if (votes >= 10)  return { name:"–°—É–¥—å—è", nextName:"–≠–∫—Å–ø–µ—Ä—Ç", nextAt:50 };
  return { name:"–ù–æ–≤–∏—á–æ–∫", nextName:"–°—É–¥—å—è", nextAt:10 };
}
function renderProgress(){
  const votes = lsGetInt(LG_LS.votesDone);
  const matches = lsGetInt(LG_LS.tasteMatches);
  const considered = lsGetInt(LG_LS.tasteConsidered);

  const votesEl = el("myVotesCount");
  const lvlEl = el("myVoterLevel");
  const nextWrap = el("nextLevelWrap");
  const nextNameEl = el("myNextLevelName");
  const nextLeftEl = el("myNextLevelLeft");
  const matchWrap = el("matchWrap");
  const matchPctEl = el("myMatchPct");

  if(votesEl) votesEl.textContent = String(votes);

  const lvl = calcLevel(votes);
  if(lvlEl) lvlEl.textContent = lvl.name;

  if(nextWrap && nextNameEl && nextLeftEl){
    if(lvl.nextAt == null){
      nextWrap.style.display = "none";
    }else{
      nextWrap.style.display = "";
      nextNameEl.textContent = lvl.nextName;
      nextLeftEl.textContent = String(Math.max(0, lvl.nextAt - votes));
    }
  }

  if(matchWrap && matchPctEl){
    if(votes >= 10){
      const pct = considered > 0 ? Math.round((matches / considered) * 100) : 0;
      matchPctEl.textContent = String(pct);
      matchWrap.style.display = "";
    }else{
      matchWrap.style.display = "none";
    }
  }
}
const MILESTONES = [
  { at: 10, text: "üî• –¢—ã —É–∂–µ –æ—Ü–µ–Ω–∏–ª 10 –ø–∞—Ä" },
  { at: 25, text: "üî• 25 –æ—Ü–µ–Ω–æ–∫ ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π —Ç–µ–º–ø" },
  { at: 50, text: "üèÜ 50 –æ—Ü–µ–Ω–æ–∫ ‚Äî —É—Ä–æ–≤–µ–Ω—å ‚Äú–≠–∫—Å–ø–µ—Ä—Ç‚Äù –±–ª–∏–∑–∫–æ" }
];
function maybeShowMilestone(votes){
  const shown = getShownMilestones();
  for(const m of MILESTONES){
    if(votes === m.at && !shown.includes(m.at)){
      toast(m.text, 1100);
      markMilestoneShown(m.at);
      break;
    }
  }
}
function majoritySide(stats){
  if(!stats) return null;
  const left = Number(stats.votes_left ?? 0);
  const right = Number(stats.votes_right ?? 0);
  if(!Number.isFinite(left) || !Number.isFinite(right)) return null;
  if(left === right) return null;
  return left > right ? "left" : "right";
}
function onVoteSuccessEnhancements({choice, stats, sourceEl}){
  const votes = lsSetInt(LG_LS.votesDone, lsGetInt(LG_LS.votesDone) + 1);

  const maj = majoritySide(stats);
  if(maj){
    lsSetInt(LG_LS.tasteConsidered, lsGetInt(LG_LS.tasteConsidered) + 1);
    if(choice === maj){
      lsSetInt(LG_LS.tasteMatches, lsGetInt(LG_LS.tasteMatches) + 1);
    }
  }
  renderProgress();
  pulseNear(sourceEl, "+1");
  maybeShowMilestone(votes);
}

// ---------- telegram ----------
function initTelegram(){
  tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

  if (tg) {
    try { tg.expand(); } catch(e){}
    try { tg.disableVerticalSwipes && tg.disableVerticalSwipes(); } catch(e){}
    try { tg.ready && tg.ready(); } catch(e){}
    initData = tg.initData || "";
    tgUserId = tg.initDataUnsafe?.user?.id || null;
  }

  el("verLabel").textContent = "v" + APP_VERSION;

  // If initData missing ‚Äî Worker will return no_hash. Do not call API in this mode.
  if (!tgUserId || !initData) {
    el("headerSub").textContent = "–û—Ç–∫—Ä–æ–π –≤ Telegram";
  }
}

function hasTelegramAuth(){
  return !!(tgUserId && initData);
}

// ---------- api ----------
async function apiFetch(path, opts={}){
  if (!hasTelegramAuth()) {
    const err = new Error("no_hash");
    err.status = 401;
    err.data = { ok:false, error:"no_hash", detail:"–û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Telegram" };
    throw err;
  }

  const url = API_BASE + path;
  const headers = Object.assign({ "Accept": "application/json" }, opts.headers || {});
  headers["x-telegram-init-data"] = initData;

  const res = await fetch(url, { ...opts, headers });
  const text = await res.text();
  let data = null;
  try { data = text ? JSON.parse(text) : null; }
  catch(e) { data = { ok:false, error:"bad_json", raw:text }; }

  if (!res.ok) {
    const err = new Error(data?.detail || data?.error || ("HTTP " + res.status));
    err.status = res.status;
    err.data = data;
    throw err;
  }
  return data;
}

// ---------- feed rendering ----------
function svgHeart(filled=false){
  return filled
    ? `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path class="iconHeartFilled" d="M12 21s-7.2-4.8-9.6-8.9C.7 8.7 2.4 5.4 6 5.1c1.8-.1 3.2.8 4 2 0 0 1.8-2.2 4-2 3.6.3 5.3 3.6 3.6 7C19.2 16.2 12 21 12 21z"/></svg>`
    : `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path class="iconHeart" d="M12 21s-7.2-4.8-9.6-8.9C.7 8.7 2.4 5.4 6 5.1c1.8-.1 3.2.8 4 2 0 0 1.8-2.2 4-2 3.6.3 5.3 3.6 3.6 7C19.2 16.2 12 21 12 21z"/></svg>`;
}
function svgShare(){
  return `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
    <path class="iconShare" d="M14 9l-4 2m4 4l-4-2"/>
    <path class="iconShare" d="M18 8a2.5 2.5 0 1 0-2.5 2.5A2.5 2.5 0 0 0 18 8z"/>
    <path class="iconShare" d="M8.5 12.5A2.5 2.5 0 1 0 6 15a2.5 2.5 0 0 0 2.5-2.5z"/>
    <path class="iconShare" d="M18 16a2.5 2.5 0 1 0-2.5 2.5A2.5 2.5 0 0 0 18 16z"/>
  </svg>`;
}
function pct(a,b){
  const t = a+b;
  if(!t) return 0;
  return Math.round((a/t)*100);
}
function cardHtml(item){
  const leftUrl = API_BASE + "/r2/" + item.photo_left_key;
  const rightUrl = API_BASE + "/r2/" + item.photo_right_key;

  const my = item.my_choice;
  const leftChosen = my === "left";
  const rightChosen = my === "right";

  const vl = Number(item.votes_left||0);
  const vr = Number(item.votes_right||0);
  const pt = pct(vl, vr);
  const pr = 100 - pt;

  const created = item.created_at ? new Date(Number(item.created_at)*1000).toLocaleDateString("ru-RU") : "";

  return `
  <div class="card" data-pair-id="${item.id}">
    <div class="cardHead">
      <div class="cardTitle">–ü–∞—Ä–∞ #${item.id}</div>
      <div class="cardMeta">${created}</div>
    </div>

    <div class="photos">
      <div class="photo"><img loading="lazy" src="${leftUrl}" alt="–§–æ—Ç–æ 1"></div>
      <div class="photo"><img loading="lazy" src="${rightUrl}" alt="–§–æ—Ç–æ 2"></div>
    </div>

    <div class="cardBody">
      <div class="actions">
        <div class="voteGroup">
          <button class="iconBtn voteBtn ${leftChosen ? "voteChosen":""}" data-choice="left" ${my ? "disabled":""} aria-label="–ì–æ–ª–æ—Å –∑–∞ —Ñ–æ—Ç–æ 1">
            ${svgHeart(leftChosen)}
            <span class="iconMuted">${vl}</span>
          </button>

          <button class="iconBtn voteBtn ${rightChosen ? "voteChosen":""}" data-choice="right" ${my ? "disabled":""} aria-label="–ì–æ–ª–æ—Å –∑–∞ —Ñ–æ—Ç–æ 2">
            ${svgHeart(rightChosen)}
            <span class="iconMuted">${vr}</span>
          </button>
        </div>

        <button class="iconBtn sharePairBtn" aria-label="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø–∞—Ä–æ–π">
          ${svgShare()}
        </button>
      </div>

      <div class="statsRow">
        <div>–§–æ—Ç–æ 1: <span class="lPct">${pt}</span>%</div>
        <div>–í—Å–µ–≥–æ: <span class="tVotes">${Number(item.total_votes||0)}</span></div>
        <div>–§–æ—Ç–æ 2: <span class="rPct">${pr}</span>%</div>
      </div>
      <div class="bar"><div class="barFill" style="width:${pt}%;"></div></div>
    </div>
  </div>`;
}
function renderFeedAppend(items){
  const list = el("feedList");
  const frag = document.createDocumentFragment();
  const tmp = document.createElement("div");

  for(let i=0;i<items.length;i++){
    tmp.innerHTML = cardHtml(items[i]);
    frag.appendChild(tmp.firstElementChild);
  }
  list.appendChild(frag);
}
function setLoading(on){ el("feedLoading").classList.toggle("hidden", !on); }
function setEmpty(on){ el("feedEmpty").classList.toggle("hidden", !on); }
function setNeedTelegram(on){ el("needTelegram").classList.toggle("hidden", !on); }

// ---------- feed load ----------
async function loadFeedMore(){
  if(isLoading) return;

  if (!hasTelegramAuth()){
    setNeedTelegram(true);
    setLoading(false);
    setEmpty(false);
    return;
  } else {
    setNeedTelegram(false);
  }

  isLoading = true;
  setLoading(true);

  try{
    const tg_id = String(tgUserId);
    const data = await apiFetch(`/feed?tg_id=${encodeURIComponent(tg_id)}&limit=${FEED_LIMIT}&offset=${feedOffset}`, { method:"GET" });

    const items = Array.isArray(data.items) ? data.items : [];
    if(feedOffset === 0){
      el("feedList").innerHTML = "";
      feedItems = [];
    }

    feedItems = feedItems.concat(items);
    renderFeedAppend(items);

    feedOffset += items.length;

    setEmpty(feedItems.length === 0);
  }catch(err){
    console.error("feed error", err);
    toast(err?.data?.detail || err?.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏", 1200);
  }finally{
    isLoading = false;
    setLoading(false);
  }
}
function setupInfiniteScroll(){
  const wrap = el("feedWrap");
  wrap.addEventListener("scroll", () => {
    if (currentTab !== "feed") return;
    const nearBottom = wrap.scrollTop + wrap.clientHeight >= wrap.scrollHeight - 600;
    if (nearBottom && !isLoading) loadFeedMore();
  }, { passive:true });
}

// ---------- vote ----------
async function handleVote(btn){
  const card = btn.closest(".card");
  if(!card) return;
  const pairId = card.getAttribute("data-pair-id");
  const choice = btn.getAttribute("data-choice");
  if(!pairId || !choice) return;

  if(!hasTelegramAuth()){
    toast("–û—Ç–∫—Ä–æ–π –≤ Telegram", 1000);
    return;
  }

  const voteBtns = card.querySelectorAll(".voteBtn");
  voteBtns.forEach(b=>b.disabled = true);

  try{
    const payload = { tg_id: String(tgUserId), pair_id: Number(pairId), choice };
    const data = await apiFetch("/vote", {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    if(!data || !data.ok){
      const errMsg = data?.detail || data?.error || "–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è";
      toast(errMsg, 1100);
      voteBtns.forEach(b=>b.disabled = false);
      return;
    }

    const vl = Number(data.votes_left ?? 0);
    const vr = Number(data.votes_right ?? 0);
    const tv = Number(data.total_votes ?? (vl+vr));

    const leftBtn = card.querySelector('.voteBtn[data-choice="left"]');
    const rightBtn = card.querySelector('.voteBtn[data-choice="right"]');

    if(leftBtn){
      leftBtn.classList.toggle("voteChosen", choice==="left");
      leftBtn.innerHTML = `${svgHeart(choice==="left")}<span class="iconMuted">${vl}</span>`;
      leftBtn.disabled = true;
    }
    if(rightBtn){
      rightBtn.classList.toggle("voteChosen", choice==="right");
      rightBtn.innerHTML = `${svgHeart(choice==="right")}<span class="iconMuted">${vr}</span>`;
      rightBtn.disabled = true;
    }

    const pt = pct(vl, vr);
    const pr = 100 - pt;
    const lPct = card.querySelector(".lPct");
    const rPct = card.querySelector(".rPct");
    const tVotes = card.querySelector(".tVotes");
    const barFill = card.querySelector(".barFill");
    if(lPct) lPct.textContent = String(pt);
    if(rPct) rPct.textContent = String(pr);
    if(tVotes) tVotes.textContent = String(tv);
    if(barFill) barFill.style.width = pt + "%";

    const idx = feedItems.findIndex(x => String(x.id) === String(pairId));
    if(idx >= 0){
      feedItems[idx].my_choice = choice;
      feedItems[idx].votes_left = vl;
      feedItems[idx].votes_right = vr;
      feedItems[idx].total_votes = tv;
    }

    onVoteSuccessEnhancements({ choice, stats: { votes_left: vl, votes_right: vr }, sourceEl: btn });

  }catch(err){
    console.error("vote error", err);
    toast(err?.data?.detail || err?.message || "–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è", 1200);
    voteBtns.forEach(b=>b.disabled = false);
  }
}

// ---------- share ----------
function sharePair(card){
  try{
    const pairId = card.getAttribute("data-pair-id");
    const shareUrl = "https://t.me/Lookinggreat_bot";
    const text = `–û—Ü–µ–Ω–∏ –ø–∞—Ä—É #${pairId} –≤ LookingGreat`;

    if (tg && tg.openTelegramLink) {
      tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(text)}`);
      return;
    }
    navigator.clipboard?.writeText(text + "\n" + shareUrl);
    toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞", 900);
  }catch(e){
    toast("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è", 900);
  }
}

// ---------- profile ----------
async function loadMyPairs(){
  if(!hasTelegramAuth()){
    toast("–û—Ç–∫—Ä–æ–π –≤ Telegram", 1000);
    return;
  }
  isLoading = true;
  setLoading(true);
  try{
    const tg_id = String(tgUserId);
    const data = await apiFetch(`/my_pairs?tg_id=${encodeURIComponent(tg_id)}`, { method:"GET" });
    const items = Array.isArray(data.items) ? data.items : [];
    el("feedList").innerHTML = "";
    feedItems = items;
    feedOffset = items.length;
    renderFeedAppend(items);
    setEmpty(items.length === 0);
  }catch(err){
    console.error("my_pairs error", err);
    toast(err?.data?.detail || err?.message || "–û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è", 1200);
  }finally{
    isLoading = false;
    setLoading(false);
  }
}

// ---------- upload ----------
function openUpload(){
  el("uploadOverlay").classList.add("show");
  el("uploadOverlay").setAttribute("aria-hidden","false");
}
function closeUpload(){
  el("uploadOverlay").classList.remove("show");
  el("uploadOverlay").setAttribute("aria-hidden","true");
}

function setThumb(which, file){
  const box = which === "left" ? el("thumbLeft") : el("thumbRight");
  box.innerHTML = "";
  if(!file) return;
  const img = document.createElement("img");
  img.alt = "thumb";
  img.src = URL.createObjectURL(file);
  box.appendChild(img);
}

async function compressImage(file, maxW=1600, quality=0.86){
  const blobUrl = URL.createObjectURL(file);
  const img = new Image();
  img.src = blobUrl;
  await img.decode();
  URL.revokeObjectURL(blobUrl);

  const ratio = img.width / img.height;
  let w = img.width;
  let h = img.height;
  if (w > maxW) { w = maxW; h = Math.round(w / ratio); }

  const canvas = document.createElement("canvas");
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, w, h);

  return await new Promise((resolve) => {
    canvas.toBlob((b) => {
      const out = new File([b], file.name.replace(/\.\w+$/,"") + ".jpg", { type:"image/jpeg" });
      resolve(out);
    }, "image/jpeg", quality);
  });
}

function showUploadLimitToast(errData){
  const code = errData?.error || "";
  if (code === "daily_limit") {
    toast("–õ–∏–º–∏—Ç –∑–∞–≥—Ä—É–∑–æ–∫ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏—Å—á–µ—Ä–ø–∞–Ω", 1400);
    return true;
  }
  if (code === "file_too_large") {
    toast("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–¥–æ 8MB)", 1400);
    return true;
  }
  return false;
}

async function uploadPair(){
  if(!hasTelegramAuth()){
    toast("–û—Ç–∫—Ä–æ–π –≤ Telegram", 1000);
    return;
  }

  const left = el("fileLeft").files?.[0] || null;
  const right = el("fileRight").files?.[0] || null;
  const caption = (el("captionInput").value || "").trim();

  if(!left || !right){
    toast("–í—ã–±–µ—Ä–∏ –æ–±–∞ —Ñ–æ—Ç–æ", 900);
    return;
  }

  const btn = el("uploadBtn");
  btn.disabled = true;
  btn.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

  try{
    const cLeft = await compressImage(left);
    const cRight = await compressImage(right);

    const fd = new FormData();
    fd.append("tg_id", String(tgUserId));
    fd.append("left", cLeft, cLeft.name);
    fd.append("right", cRight, cRight.name);
    if(caption) fd.append("caption", caption);

    const data = await apiFetch("/upload_pair", { method:"POST", body: fd });

    if(!data || !data.ok){
      if(!showUploadLimitToast(data)) {
        toast(data?.detail || data?.error || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏", 1200);
      }
      return;
    }

    toast("–ó–∞–≥—Ä—É–∂–µ–Ω–æ", 900);
    setTimeout(() => {
      closeUpload();
      el("fileLeft").value = "";
      el("fileRight").value = "";
      el("captionInput").value = "";
      el("thumbLeft").innerHTML = "";
      el("thumbRight").innerHTML = "";
      if(currentTab === "feed"){
        feedOffset = 0;
        loadFeedMore();
      }
    }, 900);

  }catch(err){
    console.error("upload error", err);
    if (!showUploadLimitToast(err?.data)) {
      toast(err?.data?.detail || err?.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏", 1300);
    }
  }finally{
    btn.disabled = false;
    btn.textContent = "–ó–∞–≥—Ä—É–∑–∏—Ç—å";
  }
}

// ---------- tabs ----------
function setTab(tab){
  currentTab = tab;

  el("tabFeed").classList.toggle("tabIconActive", tab==="feed");
  el("tabUpload").classList.toggle("tabIconActive", tab==="upload");
  el("tabProfile").classList.toggle("tabIconActive", tab==="profile");

  if(tab==="feed"){
    el("headerSub").textContent = "–õ–µ–Ω—Ç–∞";
    el("voterStats").classList.remove("hidden");
    feedOffset = 0;
    loadFeedMore();
  }
  if(tab==="upload"){
    el("headerSub").textContent = "–ó–∞–≥—Ä—É–∑–∫–∞";
    el("voterStats").classList.add("hidden");
    openUpload();
  }
  if(tab==="profile"){
    el("headerSub").textContent = "–ü—Ä–æ—Ñ–∏–ª—å";
    el("voterStats").classList.add("hidden");
    loadMyPairs();
  }
}

// ---------- event wiring ----------
function wireEvents(){
  el("tabFeed").addEventListener("click", () => setTab("feed"));
  el("tabUpload").addEventListener("click", () => setTab("upload"));
  el("tabProfile").addEventListener("click", () => setTab("profile"));

  el("uploadClose").addEventListener("click", closeUpload);
  el("uploadOverlay").addEventListener("click", (e) => {
    if(e.target === el("uploadOverlay")) closeUpload();
  });

  el("pickLeft").addEventListener("click", () => el("fileLeft").click());
  el("pickRight").addEventListener("click", () => el("fileRight").click());

  el("fileLeft").addEventListener("change", () => {
    const f = el("fileLeft").files?.[0] || null;
    setThumb("left", f);
  });
  el("fileRight").addEventListener("change", () => {
    const f = el("fileRight").files?.[0] || null;
    setThumb("right", f);
  });

  el("uploadBtn").addEventListener("click", uploadPair);

  el("feedList").addEventListener("click", (e) => {
    const voteBtn = e.target.closest && e.target.closest(".voteBtn");
    if(voteBtn) { handleVote(voteBtn); return; }

    const shareBtn = e.target.closest && e.target.closest(".sharePairBtn");
    if(shareBtn){
      const card = e.target.closest(".card");
      if(card) sharePair(card);
    }
  });
}

function boot(){
  initTelegram();
  wireEvents();
  setupInfiniteScroll();
  renderProgress(); // init progress panel

  // start feed only if telegram initData exists
  feedOffset = 0;
  loadFeedMore();
}

boot();
</script>
</body>
</html>
